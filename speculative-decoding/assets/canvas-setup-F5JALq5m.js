var Se=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0}),ts=(e,t)=>t&e.entityMask,ns=(e,t)=>t>>>e.versionShift&(1<<e.versionBits)-1,rs=(e,t)=>{let n=ns(e,t)+1&(1<<e.versionBits)-1;return t&e.entityMask|n<<e.versionShift},ss=e=>{let t={versioning:!1,versionBits:8},n=t.versionBits??8,r=t.versioning??!1,s=32-n,o=(1<<s)-1,i=s,a=(1<<n)-1<<i;return{aliveCount:0,dense:[],sparse:[],maxId:0,versioning:r,versionBits:n,entityMask:o,versionShift:i,versionMask:a}},os=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount],r=n;return e.sparse[r]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},is=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let r=e.aliveCount-1,s=e.dense[r];if(e.sparse[s]=n,e.dense[n]=s,e.sparse[t]=r,e.dense[r]=t,e.versioning){let o=rs(e,t);e.dense[r]=o}e.aliveCount--},Ht=(e,t)=>{let n=ts(e,t),r=e.sparse[n];return r!==void 0&&r<e.aliveCount&&e.dense[r]===t},_=Symbol.for("bitecs_internal"),as=(e,t)=>Se(e||{},_,{entityIndex:t||ss(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new Map,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set,entitiesWithRelations:new Set,hierarchyData:new Map,hierarchyActiveRelations:new Set,hierarchyQueryCache:new Map});function cs(...e){let t,n;return e.forEach(r=>{typeof r=="object"&&"dense"in r&&"sparse"in r&&"aliveCount"in r?t=r:typeof r=="object"&&(n=r)}),as(n,t)}var us=e=>Array.from(e[_].entityComponents.keys()),ge=()=>{let e=[],t=[],n=r=>e[t[r]]===r;return{add:r=>{n(r)||(t[r]=e.push(r)-1)},remove:r=>{if(!n(r))return;let s=t[r],o=e.pop();o!==r&&(e[s]=o,t[o]=s)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0},sort:r=>{e.sort(r);for(let s=0;s<e.length;s++)t[e[s]]=s}}},ln=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:ArrayBuffer,Ln=(e=1e3)=>{let t=[],n=0,r=new Uint32Array(new ln(e*4)),s=o=>o<t.length&&t[o]<n&&r[t[o]]===o;return{add:o=>{if(!s(o)){if(n>=r.length){let i=new Uint32Array(new ln(r.length*2*4));i.set(r),r=i}r[n]=o,t[o]=n,n++}},remove:o=>{if(!s(o))return;n--;let i=t[o],a=r[n];r[i]=a,t[a]=i},has:s,sparse:t,get dense(){return new Uint32Array(r.buffer,0,n)},reset:()=>{n=0,t.length=0},sort:o=>{let i=Array.from(r.subarray(0,n));i.sort(o);for(let a=0;a<i.length;a++)r[a]=i[a];for(let a=0;a<n;a++)t[r[a]]=a}}},Je=()=>{let e=new Set;return{subscribe:t=>(e.add(t),()=>{e.delete(t)}),notify:(t,...n)=>Array.from(e).reduce((r,s)=>{let o=s(t,...n);return o&&typeof o=="object"?{...r,...o}:r},{})}},$e=Symbol.for("bitecs-relation"),ae=Symbol.for("bitecs-pairTarget"),lt=Symbol.for("bitecs-isPairComponent"),ne=Symbol.for("bitecs-relationData"),et=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?k:n;if(!e.pairsMap.has(r)){let s={};Se(s,$e,t),Se(s,ae,r),Se(s,lt,!0),e.pairsMap.set(r,s)}return e.pairsMap.get(r)};return Se(t,ne,e),t},ls=e=>t=>{let n=t[ne];return n.initStore=e,t},fs=e=>{let t=e[ne];return t.exclusiveRelation=!0,e},ds=e=>{let t=e[ne];return t.autoRemoveSubject=!0,e},ps=e=>t=>{let n=t[ne];return n.onTargetRemoved=e,t},V=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},J=(e,t,n)=>{let r=tn(e,t),s=[];for(let o of r)o[$e]===n&&o[ae]!==k&&!vs(o[ae])&&s.push(o[ae]);return s};function hs(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:r,onTargetRemoved:s}=e[0];return[t&&ls(t),n&&fs,r&&ds,s&&ps(s)].filter(Boolean).reduce((o,i)=>i(o),et())}else return e.reduce((t,n)=>n(t),et())}var gs=Symbol.for("bitecs-wildcard");function ms(){let e=et();return Object.defineProperty(e,gs,{value:!0,enumerable:!1,writable:!1,configurable:!1}),e}function ys(){let e=Symbol.for("bitecs-global-wildcard");return globalThis[e]||(globalThis[e]=ms()),globalThis[e]}var k=ys();function ws(){return et()}function bs(){let e=Symbol.for("bitecs-global-isa");return globalThis[e]||(globalThis[e]=ws()),globalThis[e]}var tt=bs();function vs(e){return e?Object.getOwnPropertySymbols(e).includes(ne):!1}var xs=64,W=4294967295,Gn=1024;function Xn(e,t){let{depths:n}=e;if(t<n.length)return n;let r=Math.max(t+1,n.length*2,n.length+Gn),s=new Uint32Array(r);return s.fill(W),s.set(n),e.depths=s,s}function Yn(e,t,n,r){let{depthToEntities:s}=e;if(r!==void 0&&r!==W){let o=s.get(r);o&&(o.remove(t),o.dense.length===0&&s.delete(r))}n!==W&&(s.has(n)||s.set(n,Ln()),s.get(n).add(t))}function Es(e,t){t>e.maxDepth&&(e.maxDepth=t)}function Qt(e,t,n,r){e.depths[t]=n,Yn(e,t,n,r),Es(e,n)}function Wn(e,t){e[_].hierarchyQueryCache.delete(t)}function jn(e,t){let n=e[_];return n.hierarchyActiveRelations.has(t)||(n.hierarchyActiveRelations.add(t),Kt(e,t),Ns(e,t)),n.hierarchyData.get(t)}function Ns(e,t){let n=Ve(e,[V(t,k)]);for(let s of n)Ot(e,t,s);let r=new Set;for(let s of n)for(let o of J(e,s,t))r.has(o)||(r.add(o),Ot(e,t,o))}function Kt(e,t){let n=e[_];if(!n.hierarchyData.has(t)){let r=Math.max(Gn,n.entityIndex.dense.length*2),s=new Uint32Array(r);s.fill(W),n.hierarchyData.set(t,{depths:s,dirty:ge(),depthToEntities:new Map,maxDepth:0})}}function Zn(e,t,n,r=new Set){if(r.has(n))return 0;r.add(n);let s=J(e,n,t);if(s.length===0)return 0;if(s.length===1)return It(e,t,s[0],r)+1;let o=1/0;for(let i of s){let a=It(e,t,i,r);if(a<o&&(o=a,o===0))break}return o===1/0?0:o+1}function It(e,t,n,r){let s=e[_];Kt(e,t);let o=s.hierarchyData.get(t),{depths:i}=o;if(i=Xn(o,n),i[n]===W){let a=Zn(e,t,n,r);return Qt(o,n,a),a}return i[n]}function Ot(e,t,n){return It(e,t,n,new Set)}function Dn(e,t,n,r,s=ge()){if(s.has(n))return;s.add(n);let o=Ve(e,[t(n)]);for(let i of o)r.add(i),Dn(e,t,i,r,s)}function Ss(e,t,n,r,s=new Set){let o=e[_];if(!o.hierarchyActiveRelations.has(t))return;Kt(e,t);let i=o.hierarchyData.get(t);if(s.has(n)){i.dirty.add(n);return}s.add(n);let{depths:a,dirty:c}=i,u=r!==void 0?Ot(e,t,r)+1:0;if(u>xs)return;let f=a[n];Qt(i,n,u,f===W?void 0:f),f!==u&&(Dn(e,t,n,c,ge()),Wn(e,t))}function Ts(e,t,n){let r=e[_];if(!r.hierarchyActiveRelations.has(t))return;let s=r.hierarchyData.get(t),{depths:o}=s;o=Xn(s,n),Hn(e,t,n,o,ge()),Wn(e,t)}function Hn(e,t,n,r,s){if(s.has(n))return;s.add(n);let o=e[_].hierarchyData.get(t);if(n<r.length){let a=r[n];a!==W&&(o.depths[n]=W,Yn(o,n,W,a))}let i=Ve(e,[t(n)]);for(let a of i)Hn(e,t,a,r,s)}function Qn(e,t){let n=e[_].hierarchyData.get(t);if(!n)return;let{dirty:r,depths:s}=n;if(r.dense.length!==0){for(let o of r.dense)if(s[o]===W){let i=Zn(e,t,o);Qt(n,o,i)}r.reset()}}function Ps(e,t,n,r={}){let s=e[_];jn(e,t);let o=rt(e,[t,...n]),i=s.hierarchyQueryCache.get(t);if(i&&i.hash===o)return i.result;Qn(e,t),er(e,n,r);let a=s.queriesHashMap.get(rt(e,n)),c=s.hierarchyData.get(t),{depths:u}=c;a.sort((l,p)=>{let d=u[l],h=u[p];return d!==h?d-h:l-p});let f=(r.buffered,a.dense);return s.hierarchyQueryCache.set(t,{hash:o,result:f}),f}function _s(e,t,n,r={}){let s=jn(e,t);Qn(e,t);let o=s.depthToEntities.get(n);return o?(r.buffered,o.dense):r.buffered?new Uint32Array(0):[]}var he=Symbol.for("bitecs-opType"),nt=Symbol.for("bitecs-opTerms"),Cs=e=>(...t)=>({[he]:e,[nt]:t}),fn=Cs("Not"),Ft=Symbol.for("bitecs-hierarchyType"),Kn=Symbol.for("bitecs-hierarchyRel"),Jn=Symbol.for("bitecs-hierarchyDepth"),Ms=(e,t)=>({[Ft]:"Hierarchy",[Kn]:e,[Jn]:t}),Te=Symbol.for("bitecs-modifierType"),As={[Te]:"nested"},Is=As,rt=(e,t)=>{let n=e[_],r=o=>(n.componentMap.has(o)||_e(e,o),n.componentMap.get(o).id),s=o=>he in o?`${o[he].toLowerCase()}(${o[nt].map(s).sort().join(",")})`:r(o).toString();return t.map(s).sort().join("-")},dn=(e,t,n={})=>{let r=e[_],s=rt(e,t),o=[],i=y=>{he in y?y[nt].forEach(i):(r.componentMap.has(y)||_e(e,y),o.push(y))};t.forEach(i);let a=[],c=[],u=[],f=(y,w)=>{w.forEach(v=>{r.componentMap.has(v)||_e(e,v),y.push(v)})};t.forEach(y=>{if(he in y){let{[he]:w,[nt]:v}=y;if(w==="Not")f(c,v);else if(w==="Or")f(u,v);else if(w==="And")f(a,v);else throw new Error(`Nested combinator ${w} not supported yet - use simple queries for best performance`)}else r.componentMap.has(y)||_e(e,y),a.push(y)});let l=o.map(y=>r.componentMap.get(y)),p=[...new Set(l.map(y=>y.generationId))],d=(y,w)=>(y[w.generationId]=(y[w.generationId]||0)|w.bitflag,y),h=a.map(y=>r.componentMap.get(y)).reduce(d,{}),g=c.map(y=>r.componentMap.get(y)).reduce(d,{}),m=u.map(y=>r.componentMap.get(y)).reduce(d,{}),E=l.reduce(d,{}),N=Object.assign(n.buffered?Ln():ge(),{allComponents:o,orComponents:u,notComponents:c,masks:h,notMasks:g,orMasks:m,hasMasks:E,generations:p,toRemove:ge(),addObservable:Je(),removeObservable:Je(),queues:{}});r.queries.add(N),r.queriesHashMap.set(s,N),l.forEach(y=>{y.queries.add(N)}),c.length&&r.notQueries.add(N);let C=r.entityIndex;for(let y=0;y<C.aliveCount;y++){let w=C.dense[y];ee(e,w,en)||ft(e,N,w)&&dt(N,w)}return N};function er(e,t,n={}){let r=e[_],s=rt(e,t),o=r.queriesHashMap.get(s);return o?n.buffered&&!("buffer"in o.dense)&&(o=dn(e,t,{buffered:!0})):o=dn(e,t,n),n.buffered,o.dense}function Ve(e,t,...n){let r=t.find(c=>c&&typeof c=="object"&&Ft in c),s=t.filter(c=>!(c&&typeof c=="object"&&Ft in c)),o=!1,i=!0,a=n.some(c=>c&&typeof c=="object"&&Te in c);for(let c of n)if(a&&c&&typeof c=="object"&&Te in c){let u=c;u[Te]==="buffer"&&(o=!0),u[Te]==="nested"&&(i=!1)}else if(!a){let u=c;u.buffered!==void 0&&(o=u.buffered),u.commit!==void 0&&(i=u.commit)}if(r){let{[Kn]:c,[Jn]:u}=r;return u!==void 0?_s(e,c,u,{buffered:o}):Ps(e,c,s,{buffered:o})}return i&&Fs(e),er(e,s,{buffered:o})}function ft(e,t,n){let r=e[_],{masks:s,notMasks:o,orMasks:i,generations:a}=t,c=Object.keys(i).length===0;for(let u=0;u<a.length;u++){let f=a[u],l=s[f],p=o[f],d=i[f],h=r.entityMasks[f][n];if(p&&h&p||l&&(h&l)!==l)return!1;d&&h&d&&(c=!0)}return c}var dt=(e,t)=>{if(e.toRemove.has(t)){e.toRemove.remove(t),e.addObservable.notify(t);return}e.has(t)||(e.add(t),e.addObservable.notify(t))},Os=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let n=e.toRemove.dense[t];e.remove(n)}e.toRemove.reset()},Fs=e=>{let t=e[_];t.dirtyQueries.size&&(t.dirtyQueries.forEach(Os),t.dirtyQueries.clear())},Jt=(e,t,n)=>{let r=e[_];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),r.dirtyQueries.add(t),t.removeObservable.notify(n))},_e=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[_],r=new Set,s={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:r,setObservable:Je(),getObservable:Je()};return n.componentMap.set(t,s),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),s},ee=(e,t,n)=>{let r=e[_],s=r.componentMap.get(n);if(!s)return!1;let{generationId:o,bitflag:i}=s;return(r.entityMasks[o][t]&i)===i},tr=(e,t,n)=>{let r=e[_].componentMap.get(n);if(r&&ee(e,t,n))return r.getObservable.notify(t)},nr=(e,t,n,r,s=new Set)=>{if(!s.has(r)){s.add(r),me(t,n,tt(r));for(let o of tn(t,r))if(o!==en&&!ee(t,n,o)){me(t,n,o);let i=e.componentMap.get(o);if(i?.setObservable){let a=tr(t,r,o);i.setObservable.notify(n,a)}}for(let o of J(t,r,tt))nr(e,t,n,o,s)}},me=(e,t,n)=>{if(!Fe(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);let r=e[_],s="component"in n?n.component:n,o="data"in n?n.data:void 0;r.componentMap.has(s)||_e(e,s);let i=r.componentMap.get(s);if(ee(e,t,s))return o!==void 0&&i.setObservable.notify(t,o),!1;let{generationId:a,bitflag:c,queries:u}=i;if(r.entityMasks[a][t]|=c,ee(e,t,en)||u.forEach(f=>{ft(e,f,t)?dt(f,t):Jt(e,f,t)}),r.entityComponents.get(t).add(s),o!==void 0&&i.setObservable.notify(t,o),s[lt]){let f=s[$e],l=s[ae];if(Rt(e,t,V(f,k),V(k,l)),typeof l=="number"&&(Rt(e,l,V(k,t),V(k,f)),r.entitiesWithRelations.add(l),r.entitiesWithRelations.add(t)),r.entitiesWithRelations.add(l),f[ne].exclusiveRelation===!0&&l!==k){let p=J(e,t,f)[0];p!=null&&p!==l&&D(e,t,f(p))}if(f===tt){let p=J(e,t,tt);for(let d of p)nr(r,e,t,d)}Ss(e,f,t,typeof l=="number"?l:void 0)}return!0};function Rt(e,t,...n){(Array.isArray(n[0])?n[0]:n).forEach(r=>{me(e,t,r)})}var D=(e,t,...n)=>{let r=e[_];if(!Fe(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);n.forEach(s=>{if(!ee(e,t,s))return;let o=r.componentMap.get(s),{generationId:i,bitflag:a,queries:c}=o;if(r.entityMasks[i][t]&=~a,c.forEach(u=>{u.toRemove.remove(t),ft(e,u,t)?dt(u,t):Jt(e,u,t)}),r.entityComponents.get(t).delete(s),s[lt]){let u=s[ae],f=s[$e];Ts(e,f,t),D(e,t,V(k,u)),typeof u=="number"&&Fe(e,u)&&(D(e,u,V(k,t)),D(e,u,V(k,f))),J(e,t,f).length===0&&D(e,t,V(f,k))}})},Rs=D,en={};function Bs(e,...t){let n=e[_],r=os(n.entityIndex);return n.notQueries.forEach(s=>{ft(e,s,r)&&dt(s,r)}),n.entityComponents.set(r,new Set),t.length>0&&Rt(e,r,t),r}var rr=(e,t)=>{let n=e[_];if(!Ht(n.entityIndex,t))return;let r=[t],s=new Set;for(;r.length>0;){let o=r.shift();if(s.has(o))continue;s.add(o);let i=[];if(n.entitiesWithRelations.has(o)){for(let a of Ve(e,[k(o)],Is))if(Fe(e,a))for(let c of n.entityComponents.get(a)){if(!c[lt])continue;let u=c[$e][ne];i.push(()=>D(e,a,V(k,o))),c[ae]===o&&(i.push(()=>D(e,a,c)),u.autoRemoveSubject&&r.push(a),u.onTargetRemoved&&i.push(()=>u.onTargetRemoved(e,a,o)))}n.entitiesWithRelations.delete(o)}for(let a of i)a();for(let a of r)rr(e,a);for(let a of n.queries)Jt(e,a,o);is(n.entityIndex,o),n.entityComponents.delete(o);for(let a=0;a<n.entityMasks.length;a++)n.entityMasks[a][o]=0}},tn=(e,t)=>{let n=e[_];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!Ht(n.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(n.entityComponents.get(t))},Fe=(e,t)=>Ht(e[_].entityIndex,t);class sr extends Error{constructor(t="Circular dependency detected"){super(t),this.name="CycleError"}}function Ze(e,t){if(e.length===0)return[];const n=new Map,r=new Map;for(const i of e)n.set(i,new Set),r.set(i,0);for(const[i,a]of t)!n.has(i)||!n.has(a)||(n.get(i).add(a),r.set(a,r.get(a)+1));ks(e,n);const s=[],o=[];for(const i of e)r.get(i)===0&&s.push(i);for(;s.length>0;){const i=s.shift();o.push(i);for(const a of n.get(i)){const c=r.get(a)-1;r.set(a,c),c===0&&s.push(a)}}return o}function ks(e,t){const n=new Set,r=new Set;function s(o){if(r.has(o))return!0;if(n.has(o))return!1;n.add(o),r.add(o);for(const i of t.get(o))if(s(i))return!0;return r.delete(o),!1}for(const o of e)if(s(o))throw new sr}const De={FIXED_DT:1/50,DEFAULT_DT:1/60};class or extends Error{constructor(t){super(t),this.name="OrderingError"}}class qs{_systems=new Set;_systemsVersion=0;_accumulator=0;_initialized=new WeakSet;_cache=new Map;_cacheVersion=-1;_time={deltaTime:0,fixedDeltaTime:De.FIXED_DT,elapsed:0};get systems(){return this._systems}get systemsVersion(){return this._systemsVersion}get accumulator(){return this._accumulator}get time(){return this._time}register(t){this._systems.add(t),this._systemsVersion++}unregister(t){this._systems.delete(t)&&this._systemsVersion++}step(t,n=De.DEFAULT_DT){const r=De.FIXED_DT;for(this._time.deltaTime=n,this._time.elapsed+=n,this._accumulator+=n,this.runGroup(t,"setup");this._accumulator>=r;)this._time.deltaTime=r,this.runGroup(t,"fixed"),this._accumulator-=r;this._time.deltaTime=n,this.runGroup(t,"simulation"),this.runGroup(t,"draw")}runGroup(t,n){for(const r of this.getSorted(n))this._initialized.has(r)||(r.setup?.(t),this._initialized.add(r)),r.update?.(t)}getSorted(t){this._systemsVersion!==this._cacheVersion&&(this._cache.clear(),this._cacheVersion=this._systemsVersion);const n=this._cache.get(t);if(n)return n;const r=Array.from(this._systems),s=r.filter(i=>(i.group??"simulation")===t),o=$s(s,r);return this._cache.set(t,o),o}}function $s(e,t){Vs(e,t??e);const r=e.filter(i=>i.first),s=e.filter(i=>i.last),o=e.filter(i=>!i.first&&!i.last);return[...Ze(r,bt(r)),...Ze(o,bt(o)),...Ze(s,bt(s))]}function bt(e){const t=[];for(const n of e){for(const r of n.before??[])e.includes(r)&&t.push([n,r]);for(const r of n.after??[])e.includes(r)&&t.push([r,n])}return t}function Vs(e,t){for(const n of e){if(n.first&&n.last)throw new or("System cannot have both first and last constraints");const r=n.group??"simulation";for(const s of n.before??[])pn(s,r,t);for(const s of n.after??[])pn(s,r,t)}}function pn(e,t,n){if(!n.includes(e))return;const r=e.group??"simulation";if(r!==t)throw new or(`Cross-group constraint: ${t} references ${r}`)}const zs="modulepreload",Us=function(e,t){return new URL(e,t).href},hn={},Bt=function(t,n,r){let s=Promise.resolve();if(n&&n.length>0){let u=function(f){return Promise.all(f.map(l=>Promise.resolve(l).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};const i=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),c=a?.nonce||a?.getAttribute("nonce");s=u(n.map(f=>{if(f=Us(f,r),f in hn)return;hn[f]=!0;const l=f.endsWith(".css"),p=l?'[rel="stylesheet"]':"";if(r)for(let h=i.length-1;h>=0;h--){const g=i[h];if(g.href===f&&(!l||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${f}"]${p}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":zs,l||(d.as="script"),d.crossOrigin="",d.href=f,c&&d.setAttribute("nonce",c),document.head.appendChild(d),l)return new Promise((h,g)=>{d.addEventListener("load",h),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return s.then(i=>{for(const a of i||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})};function Ls(){if(typeof __TAURI_INTERNALS__<"u")return"standalone";if(typeof Bun<"u")return"headless";if(typeof window<"u"&&typeof fetch=="function")return"web";throw new Error("Unknown runtime environment")}function Gs(){return{target:"web",async readFile(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.status}`);return t.text()},async readBinary(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.status}`);return t.arrayBuffer()},requestFrame(e){requestAnimationFrame(e)},now(){return performance.now()}}}function Xs(){return{target:"headless",async readFile(e){return Bun.file(e).text()},async readBinary(e){return Bun.file(e).arrayBuffer()},requestFrame(e){setTimeout(e,0)},now(){return performance.now()}}}function gn(e){return e.startsWith("/")||e.startsWith("./")||e.startsWith("../")}function Ys(){return{target:"standalone",async readFile(e){if(gn(e)){const n=await fetch(e);if(!n.ok)throw new Error(`Failed to load ${e}: ${n.status}`);return n.text()}const{readTextFile:t}=await Bt(async()=>{const{readTextFile:n}=await import("./index-BrFmEk1v.js");return{readTextFile:n}},[],import.meta.url);return t(e)},async readBinary(e){if(gn(e)){const r=await fetch(e);if(!r.ok)throw new Error(`Failed to load ${e}: ${r.status}`);return r.arrayBuffer()}const{readFile:t}=await Bt(async()=>{const{readFile:r}=await import("./index-BrFmEk1v.js");return{readFile:r}},[],import.meta.url);return(await t(e)).buffer},requestFrame(e){requestAnimationFrame(e)},now(){return performance.now()}}}let Ge;async function Ws(){switch(Ls()){case"headless":return Xs();case"standalone":return Ys();case"web":return Gs()}}let vt;async function ir(){return Ge||(vt||(vt=Ws()),Ge=await vt,Ge)}function te(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/[\s_]+/g,"-").toLowerCase()}function nn(e){return e.replace(/-([a-z])/g,(t,n)=>n.toUpperCase())}const rn=new WeakMap;function F(e,t){rn.set(e,t)}function mn(e){return rn.get(e)}const ar=new Map;function cr(e,t){const n=te(e),r=rn.get(t);ar.set(n,{component:t,name:n,traits:r})}function ur(e){return ar.get(te(e))}function js(e,t,n){return{get:r=>e[r*t+n],set:(r,s)=>{e[r*t+n]=s}}}function re(e){const t=Symbol(e),n=Object.assign(t,{from(r){return r.getResource(n)}});return n}const S=65536;class Re{world;scheduler=new qs;canvas;_resources=new Map;_disposed=!1;_running=!1;_runtime=null;_lastTime=0;_fieldAccessors=null;get time(){return this.scheduler.time}get running(){return this._running}static Builder=null;static new(){if(!Re.Builder)throw new Error("StateBuilder not injected. Import from 'shallot' or 'shallot/core'.");return new Re.Builder}constructor(t=null){this.world=cs(),this.canvas=t}setResource(t,n){this._resources.set(t,n)}getResource(t){return this._resources.get(t)}deleteResource(t){return this._resources.delete(t)}async start(t){this._running||(this._runtime=t??await ir(),this._running=!0,this._lastTime=this._runtime.now(),this.scheduleFrame())}stop(){this._running=!1}scheduleFrame(){!this._running||!this._runtime||this._runtime.requestFrame(()=>this.tick())}tick(){if(!this._running||!this._runtime)return;const t=this._runtime.now(),n=(t-this._lastTime)/1e3;this._lastTime=t,this.step(n),this.scheduleFrame()}register(t){if("update"in t||"setup"in t||"dispose"in t)this.scheduler.register(t);else{const n=t;if(n.components)for(const[r,s]of Object.entries(n.components))cr(r,s);if(n.systems)for(const r of n.systems)this.scheduler.register(r)}}unregister(t){this.scheduler.unregister(t)}step(t=De.DEFAULT_DT){this.scheduler.step(this,t)}addEntity(){const t=Bs(this.world);if(t>=S)throw new Error(`Entity limit exceeded: ${t} >= ${S}`);return t}removeEntity(t){this._fieldAccessors?.delete(t),rr(this.world,t)}entityExists(t){return Fe(this.world,t)}getAllEntities(){return us(this.world)}query(t){return Ve(this.world,t)}getEntityComponents(t){return tn(this.world,t)}addComponent(t,n){me(this.world,t,n);const r=mn(n);if(r?.defaults){const s=r.defaults(),o=n;for(const[i,a]of Object.entries(s)){const c=o[i];c!=null&&(c[t]=a)}}}addComponents(t,...n){for(const r of n)this.addComponent(t,r)}removeComponent(t,...n){D(this.world,t,...n)}removeComponents(t,...n){Rs(this.world,t,...n)}hasComponent(t,n){return ee(this.world,t,n)}getComponent(t,n){return tr(this.world,t,n)}setComponent(t,n,r){this.addComponent(t,n);const s=n;for(const[o,i]of Object.entries(r)){const a=s[o];a!=null&&(a[t]=i)}}addRelation(t,n,r){me(this.world,t,n.relation(r))}hasRelation(t,n,r){return ee(this.world,t,n.relation(r))}getRelationTargets(t,n){return J(this.world,t,n.relation)}getFirstRelationTarget(t,n){const r=J(this.world,t,n.relation);return r.length>0?r[0]:-1}ensureFieldAccessors(){return this._fieldAccessors||(this._fieldAccessors=new Map),this._fieldAccessors}resolveFieldPath(t){const n=t.lastIndexOf(".");return n===-1?null:{component:t.slice(0,n),field:t.slice(n+1)}}bindFieldAccessor(t,n,r){const s=ur(n);if(!s)return null;const o=nn(r),i=mn(s.component);if(i?.accessors?.[o]){const u=i.accessors[o];return this.ensureFieldAccessors().set(t,u),u}const a=s.component[o];if(a==null||!(ArrayBuffer.isView(a)||Array.isArray(a)))return null;const c=js(a,1,0);return this.ensureFieldAccessors().set(t,c),c}getFieldAccessor(t){return this._fieldAccessors?.get(t)}removeFieldAccessor(t){return this._fieldAccessors?.delete(t)??!1}dispose(){if(!this._disposed){this.stop(),this._fieldAccessors=null;for(const t of this.scheduler.systems)t.dispose?.(this);this._disposed=!0}}}class ye{static defaultPlugins=[];static loading=null;_plugins=[];_systems=[];_scenes=[];_excludedPlugins=new Set;_useDefaultPlugins=!0;_canvas=null;_loading=void 0;withCanvas(t){return this._canvas=t,this}withPlugins(...t){return this._plugins.push(...t),this}withoutPlugin(t){return this._excludedPlugins.add(t),this}withoutPlugins(...t){for(const n of t)this._excludedPlugins.add(n);return this}withoutDefaultPlugins(){return this._useDefaultPlugins=!1,this}withSystems(...t){return this._systems.push(...t),this}withScene(t){return this._scenes.push(t),this}withLoading(t){return this._loading=t,this}async build(){const t=this._loading===void 0&&this._canvas?ye.loading?.(this._canvas)??null:this._loading,n=t?.show(),r=new Re(this._canvas),s=new Set;if(this._useDefaultPlugins)for(const f of ye.defaultPlugins)this._excludedPlugins.has(f)||s.add(f);for(const f of this._plugins)s.add(f);const o=[...s];for(const f of o){if(f.components)for(const[l,p]of Object.entries(f.components))cr(l,p);if(f.systems)for(const l of f.systems)r.scheduler.register(l)}const i=[];for(const f of o)for(const l of f.dependencies??[])o.includes(l)&&i.push([l,f]);const a=Ze(o,i);let c=0;const u=a.length;for(const f of a)await f.initialize?.(r),c++,t?.update(c/u);for(const f of this._systems)r.scheduler.register(f);if(this._scenes.length>0){const{loadSceneFile:f}=await Bt(async()=>{const{loadSceneFile:p}=await Promise.resolve().then(()=>ei);return{loadSceneFile:p}},void 0,import.meta.url),l=await ir();for(const p of this._scenes){const d=await f(r,p,l.readFile.bind(l));d.errors.length>0&&console.warn(`Scene "${p}" loaded with errors:`,d.errors)}}return n?.(),r}async run(){const t=await this.build();return await t.start(),t}}Re.Builder=ye;const lr=new Map;function fr(e,t){const n=hs({exclusive:t?.exclusive,autoRemoveSubject:t?.autoRemoveSubject}),r={name:te(e),relation:n,exclusive:t?.exclusive,autoRemoveSubject:t?.autoRemoveSubject};return lr.set(r.name,r),r}function Zs(e){return lr.get(te(e))}const Y=fr("child-of",{exclusive:!0,autoRemoveSubject:!0}),xt=Math.PI/180,ve=180/Math.PI;function yn(e,t,n){return e<t?t:e>n?n:e}function Ds(e,t,n){const r=e*xt*.5,s=t*xt*.5,o=n*xt*.5,i=Math.cos(r),a=Math.sin(r),c=Math.cos(s),u=Math.sin(s),f=Math.cos(o),l=Math.sin(o);return{x:a*c*f+i*u*l,y:i*u*f-a*c*l,z:i*c*l+a*u*f,w:i*c*f-a*u*l}}function wn(e,t,n,r){const s=e+e,o=t+t,i=n+n,a=e*s,c=e*o,u=e*i,f=t*o,l=t*i,p=n*i,d=r*s,h=r*o,g=r*i,m=u+h,E=Math.asin(m<-1?-1:m>1?1:m);return m>-.9999999&&m<.9999999?{x:Math.atan2(d-l,1-(a+f))*ve,y:E*ve,z:Math.atan2(g-c,1-(f+p))*ve}:{x:Math.atan2(l+d,1-(a+p))*ve,y:E*ve,z:0}}function Hs(e,t,n,r,s,o,i=0,a=1,c=0){if(!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(s)||!Number.isFinite(o))throw new Error(`lookAt received NaN: eye=[${e},${t},${n}], target=[${r},${s},${o}]`);let u=e-r,f=t-s,l=n-o,p=Math.sqrt(u*u+f*f+l*l);p===0?l=1:(p=1/p,u*=p,f*=p,l*=p);let d=a*l-c*f,h=c*u-i*l,g=i*f-a*u,m=Math.sqrt(d*d+h*h+g*g);m<1e-6&&(Math.abs(l)>Math.abs(u)?i+=1e-4:c+=1e-4,d=a*l-c*f,h=c*u-i*l,g=i*f-a*u,m=Math.sqrt(d*d+h*h+g*g)),m<1e-6?(d=1,h=0,g=0):(m=1/m,d*=m,h*=m,g*=m);const E=f*g-l*h,N=l*d-u*g,C=u*h-f*d,y=d+N+l;let w,v,L,G;if(y>0){const P=.5/Math.sqrt(y+1);w=.25/P,v=(C-f)*P,L=(u-g)*P,G=(h-E)*P}else if(d>N&&d>l){const P=2*Math.sqrt(1+d-N-l);w=(C-f)/P,v=.25*P,L=(E+h)/P,G=(u+g)/P}else if(N>l){const P=2*Math.sqrt(1+N-d-l);w=(u-g)/P,v=(E+h)/P,L=.25*P,G=(C+f)/P}else{const P=2*Math.sqrt(1+l-d-N);w=(h-E)/P,v=(u+g)/P,L=(C+f)/P,G=.25*P}return{x:v,y:L,z:G,w}}const dr=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",Qs=dr+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",Ks="["+dr+"]["+Qs+"]*",Js=new RegExp("^"+Ks+"$");function pr(e,t){const n=[];let r=t.exec(e);for(;r;){const s=[];s.startIndex=t.lastIndex-r[0].length;const o=r.length;for(let i=0;i<o;i++)s.push(r[i]);n.push(s),r=t.exec(e)}return n}const pt=function(e){const t=Js.exec(e);return!(t===null||typeof t>"u")};function eo(e){return typeof e<"u"}const to={allowBooleanAttributes:!1,unpairedTags:[]};function no(e,t){t=Object.assign({},to,t);const n=[];let r=!1,s=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let o=0;o<e.length;o++)if(e[o]==="<"&&e[o+1]==="?"){if(o+=2,o=vn(e,o),o.err)return o}else if(e[o]==="<"){let i=o;if(o++,e[o]==="!"){o=xn(e,o);continue}else{let a=!1;e[o]==="/"&&(a=!0,o++);let c="";for(;o<e.length&&e[o]!==">"&&e[o]!==" "&&e[o]!=="	"&&e[o]!==`
`&&e[o]!=="\r";o++)c+=e[o];if(c=c.trim(),c[c.length-1]==="/"&&(c=c.substring(0,c.length-1),o--),!lo(c)){let l;return c.trim().length===0?l="Invalid space after '<'.":l="Tag '"+c+"' is an invalid name.",M("InvalidTag",l,q(e,o))}const u=oo(e,o);if(u===!1)return M("InvalidAttr","Attributes for '"+c+"' have open quote.",q(e,o));let f=u.value;if(o=u.index,f[f.length-1]==="/"){const l=o-f.length;f=f.substring(0,f.length-1);const p=En(f,t);if(p===!0)r=!0;else return M(p.err.code,p.err.msg,q(e,l+p.err.line))}else if(a)if(u.tagClosed){if(f.trim().length>0)return M("InvalidTag","Closing tag '"+c+"' can't have attributes or invalid starting.",q(e,i));if(n.length===0)return M("InvalidTag","Closing tag '"+c+"' has not been opened.",q(e,i));{const l=n.pop();if(c!==l.tagName){let p=q(e,l.tagStartPos);return M("InvalidTag","Expected closing tag '"+l.tagName+"' (opened in line "+p.line+", col "+p.col+") instead of closing tag '"+c+"'.",q(e,i))}n.length==0&&(s=!0)}}else return M("InvalidTag","Closing tag '"+c+"' doesn't have proper closing.",q(e,o));else{const l=En(f,t);if(l!==!0)return M(l.err.code,l.err.msg,q(e,o-f.length+l.err.line));if(s===!0)return M("InvalidXml","Multiple possible root nodes found.",q(e,o));t.unpairedTags.indexOf(c)!==-1||n.push({tagName:c,tagStartPos:i}),r=!0}for(o++;o<e.length;o++)if(e[o]==="<")if(e[o+1]==="!"){o++,o=xn(e,o);continue}else if(e[o+1]==="?"){if(o=vn(e,++o),o.err)return o}else break;else if(e[o]==="&"){const l=co(e,o);if(l==-1)return M("InvalidChar","char '&' is not expected.",q(e,o));o=l}else if(s===!0&&!bn(e[o]))return M("InvalidXml","Extra text at the end",q(e,o));e[o]==="<"&&o--}}else{if(bn(e[o]))continue;return M("InvalidChar","char '"+e[o]+"' is not expected.",q(e,o))}if(r){if(n.length==1)return M("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",q(e,n[0].tagStartPos));if(n.length>0)return M("InvalidXml","Invalid '"+JSON.stringify(n.map(o=>o.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return M("InvalidXml","Start tag expected.",1);return!0}function bn(e){return e===" "||e==="	"||e===`
`||e==="\r"}function vn(e,t){const n=t;for(;t<e.length;t++)if(e[t]=="?"||e[t]==" "){const r=e.substr(n,t-n);if(t>5&&r==="xml")return M("InvalidXml","XML declaration allowed only at the start of the document.",q(e,t));if(e[t]=="?"&&e[t+1]==">"){t++;break}else continue}return t}function xn(e,t){if(e.length>t+5&&e[t+1]==="-"&&e[t+2]==="-"){for(t+=3;t<e.length;t++)if(e[t]==="-"&&e[t+1]==="-"&&e[t+2]===">"){t+=2;break}}else if(e.length>t+8&&e[t+1]==="D"&&e[t+2]==="O"&&e[t+3]==="C"&&e[t+4]==="T"&&e[t+5]==="Y"&&e[t+6]==="P"&&e[t+7]==="E"){let n=1;for(t+=8;t<e.length;t++)if(e[t]==="<")n++;else if(e[t]===">"&&(n--,n===0))break}else if(e.length>t+9&&e[t+1]==="["&&e[t+2]==="C"&&e[t+3]==="D"&&e[t+4]==="A"&&e[t+5]==="T"&&e[t+6]==="A"&&e[t+7]==="["){for(t+=8;t<e.length;t++)if(e[t]==="]"&&e[t+1]==="]"&&e[t+2]===">"){t+=2;break}}return t}const ro='"',so="'";function oo(e,t){let n="",r="",s=!1;for(;t<e.length;t++){if(e[t]===ro||e[t]===so)r===""?r=e[t]:r!==e[t]||(r="");else if(e[t]===">"&&r===""){s=!0;break}n+=e[t]}return r!==""?!1:{value:n,index:t,tagClosed:s}}const io=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function En(e,t){const n=pr(e,io),r={};for(let s=0;s<n.length;s++){if(n[s][1].length===0)return M("InvalidAttr","Attribute '"+n[s][2]+"' has no space in starting.",xe(n[s]));if(n[s][3]!==void 0&&n[s][4]===void 0)return M("InvalidAttr","Attribute '"+n[s][2]+"' is without value.",xe(n[s]));if(n[s][3]===void 0&&!t.allowBooleanAttributes)return M("InvalidAttr","boolean attribute '"+n[s][2]+"' is not allowed.",xe(n[s]));const o=n[s][2];if(!uo(o))return M("InvalidAttr","Attribute '"+o+"' is an invalid name.",xe(n[s]));if(!r.hasOwnProperty(o))r[o]=1;else return M("InvalidAttr","Attribute '"+o+"' is repeated.",xe(n[s]))}return!0}function ao(e,t){let n=/\d/;for(e[t]==="x"&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(e[t]===";")return t;if(!e[t].match(n))break}return-1}function co(e,t){if(t++,e[t]===";")return-1;if(e[t]==="#")return t++,ao(e,t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(e[t]===";")break;return-1}return t}function M(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function uo(e){return pt(e)}function lo(e){return pt(e)}function q(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function xe(e){return e.startIndex+e[1].length}const fo={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e},captureMetaData:!1},po=function(e){return Object.assign({},fo,e)};let st;typeof Symbol!="function"?st="@@xmlMetadata":st=Symbol("XML Node Metadata");class oe{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,n){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:n})}addChild(t,n){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child}),n!==void 0&&(this.child[this.child.length-1][st]={startIndex:n})}static getMetaDataSymbol(){return st}}class ho{constructor(t){this.suppressValidationErr=!t}readDocType(t,n){const r={};if(t[n+3]==="O"&&t[n+4]==="C"&&t[n+5]==="T"&&t[n+6]==="Y"&&t[n+7]==="P"&&t[n+8]==="E"){n=n+9;let s=1,o=!1,i=!1,a="";for(;n<t.length;n++)if(t[n]==="<"&&!i){if(o&&se(t,"!ENTITY",n)){n+=7;let c,u;[c,u,n]=this.readEntityExp(t,n+1,this.suppressValidationErr),u.indexOf("&")===-1&&(r[c]={regx:RegExp(`&${c};`,"g"),val:u})}else if(o&&se(t,"!ELEMENT",n)){n+=8;const{index:c}=this.readElementExp(t,n+1);n=c}else if(o&&se(t,"!ATTLIST",n))n+=8;else if(o&&se(t,"!NOTATION",n)){n+=9;const{index:c}=this.readNotationExp(t,n+1,this.suppressValidationErr);n=c}else if(se(t,"!--",n))i=!0;else throw new Error("Invalid DOCTYPE");s++,a=""}else if(t[n]===">"){if(i?t[n-1]==="-"&&t[n-2]==="-"&&(i=!1,s--):s--,s===0)break}else t[n]==="["?o=!0:a+=t[n];if(s!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:n}}readEntityExp(t,n){n=z(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n])&&t[n]!=='"'&&t[n]!=="'";)r+=t[n],n++;if(Ee(r),n=z(t,n),!this.suppressValidationErr){if(t.substring(n,n+6).toUpperCase()==="SYSTEM")throw new Error("External entities are not supported");if(t[n]==="%")throw new Error("Parameter entities are not supported")}let s="";return[n,s]=this.readIdentifierVal(t,n,"entity"),n--,[r,s,n]}readNotationExp(t,n){n=z(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n]);)r+=t[n],n++;!this.suppressValidationErr&&Ee(r),n=z(t,n);const s=t.substring(n,n+6).toUpperCase();if(!this.suppressValidationErr&&s!=="SYSTEM"&&s!=="PUBLIC")throw new Error(`Expected SYSTEM or PUBLIC, found "${s}"`);n+=s.length,n=z(t,n);let o=null,i=null;if(s==="PUBLIC")[n,o]=this.readIdentifierVal(t,n,"publicIdentifier"),n=z(t,n),(t[n]==='"'||t[n]==="'")&&([n,i]=this.readIdentifierVal(t,n,"systemIdentifier"));else if(s==="SYSTEM"&&([n,i]=this.readIdentifierVal(t,n,"systemIdentifier"),!this.suppressValidationErr&&!i))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:r,publicIdentifier:o,systemIdentifier:i,index:--n}}readIdentifierVal(t,n,r){let s="";const o=t[n];if(o!=='"'&&o!=="'")throw new Error(`Expected quoted string, found "${o}"`);for(n++;n<t.length&&t[n]!==o;)s+=t[n],n++;if(t[n]!==o)throw new Error(`Unterminated ${r} value`);return n++,[n,s]}readElementExp(t,n){n=z(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n]);)r+=t[n],n++;if(!this.suppressValidationErr&&!pt(r))throw new Error(`Invalid element name: "${r}"`);n=z(t,n);let s="";if(t[n]==="E"&&se(t,"MPTY",n))n+=4;else if(t[n]==="A"&&se(t,"NY",n))n+=2;else if(t[n]==="("){for(n++;n<t.length&&t[n]!==")";)s+=t[n],n++;if(t[n]!==")")throw new Error("Unterminated content model")}else if(!this.suppressValidationErr)throw new Error(`Invalid Element Expression, found "${t[n]}"`);return{elementName:r,contentModel:s.trim(),index:n}}readAttlistExp(t,n){n=z(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n]);)r+=t[n],n++;Ee(r),n=z(t,n);let s="";for(;n<t.length&&!/\s/.test(t[n]);)s+=t[n],n++;if(!Ee(s))throw new Error(`Invalid attribute name: "${s}"`);n=z(t,n);let o="";if(t.substring(n,n+8).toUpperCase()==="NOTATION"){if(o="NOTATION",n+=8,n=z(t,n),t[n]!=="(")throw new Error(`Expected '(', found "${t[n]}"`);n++;let a=[];for(;n<t.length&&t[n]!==")";){let c="";for(;n<t.length&&t[n]!=="|"&&t[n]!==")";)c+=t[n],n++;if(c=c.trim(),!Ee(c))throw new Error(`Invalid notation name: "${c}"`);a.push(c),t[n]==="|"&&(n++,n=z(t,n))}if(t[n]!==")")throw new Error("Unterminated list of notations");n++,o+=" ("+a.join("|")+")"}else{for(;n<t.length&&!/\s/.test(t[n]);)o+=t[n],n++;const a=["CDATA","ID","IDREF","IDREFS","ENTITY","ENTITIES","NMTOKEN","NMTOKENS"];if(!this.suppressValidationErr&&!a.includes(o.toUpperCase()))throw new Error(`Invalid attribute type: "${o}"`)}n=z(t,n);let i="";return t.substring(n,n+8).toUpperCase()==="#REQUIRED"?(i="#REQUIRED",n+=8):t.substring(n,n+7).toUpperCase()==="#IMPLIED"?(i="#IMPLIED",n+=7):[n,i]=this.readIdentifierVal(t,n,"ATTLIST"),{elementName:r,attributeName:s,attributeType:o,defaultValue:i,index:n}}}const z=(e,t)=>{for(;t<e.length&&/\s/.test(e[t]);)t++;return t};function se(e,t,n){for(let r=0;r<t.length;r++)if(t[r]!==e[n+r+1])return!1;return!0}function Ee(e){if(pt(e))return e;throw new Error(`Invalid entity name ${e}`)}const go=/^[-+]?0x[a-fA-F0-9]+$/,mo=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,yo={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function wo(e,t={}){if(t=Object.assign({},yo,t),!e||typeof e!="string")return e;let n=e.trim();if(t.skipLike!==void 0&&t.skipLike.test(n))return e;if(e==="0")return 0;if(t.hex&&go.test(n))return Eo(n,16);if(n.includes("e")||n.includes("E"))return vo(e,n,t);{const r=mo.exec(n);if(r){const s=r[1]||"",o=r[2];let i=xo(r[3]);const a=s?e[o.length+1]===".":e[o.length]===".";if(!t.leadingZeros&&(o.length>1||o.length===1&&!a))return e;{const c=Number(n),u=String(c);if(c===0)return c;if(u.search(/[eE]/)!==-1)return t.eNotation?c:e;if(n.indexOf(".")!==-1)return u==="0"||u===i||u===`${s}${i}`?c:e;let f=o?i:n;return o?f===u||s+f===u?c:e:f===u||f===s+u?c:e}}else return e}}const bo=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;function vo(e,t,n){if(!n.eNotation)return e;const r=t.match(bo);if(r){let s=r[1]||"";const o=r[3].indexOf("e")===-1?"E":"e",i=r[2],a=s?e[i.length+1]===o:e[i.length]===o;return i.length>1&&a?e:i.length===1&&(r[3].startsWith(`.${o}`)||r[3][0]===o)?Number(t):n.leadingZeros&&!a?(t=(r[1]||"")+r[3],Number(t)):e}else return e}function xo(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substring(0,e.length-1))),e}function Eo(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}function No(e){return typeof e=="function"?e:Array.isArray(e)?t=>{for(const n of e)if(typeof n=="string"&&t===n||n instanceof RegExp&&n.test(t))return!0}:()=>!1}class So{constructor(t){if(this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(n,r)=>String.fromCodePoint(Number.parseInt(r,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(n,r)=>String.fromCodePoint(Number.parseInt(r,16))}},this.addExternalEntities=To,this.parseXml=Ao,this.parseTextData=Po,this.resolveNameSpace=_o,this.buildAttributesMap=Mo,this.isItStopNode=Ro,this.replaceEntitiesValue=Oo,this.readStopNodeData=ko,this.saveTextToParentTag=Fo,this.addChild=Io,this.ignoreAttributesFn=No(this.options.ignoreAttributes),this.options.stopNodes&&this.options.stopNodes.length>0){this.stopNodesExact=new Set,this.stopNodesWildcard=new Set;for(let n=0;n<this.options.stopNodes.length;n++){const r=this.options.stopNodes[n];typeof r=="string"&&(r.startsWith("*.")?this.stopNodesWildcard.add(r.substring(2)):this.stopNodesExact.add(r))}}}}function To(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function Po(e,t,n,r,s,o,i){if(e!==void 0&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){i||(e=this.replaceEntitiesValue(e));const a=this.options.tagValueProcessor(t,e,n,s,o);return a==null?e:typeof a!=typeof e||a!==e?a:this.options.trimValues?qt(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?qt(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function _o(e){if(this.options.removeNSPrefix){const t=e.split(":"),n=e.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(e=n+t[1])}return e}const Co=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function Mo(e,t){if(this.options.ignoreAttributes!==!0&&typeof e=="string"){const n=pr(e,Co),r=n.length,s={};for(let o=0;o<r;o++){const i=this.resolveNameSpace(n[o][1]);if(this.ignoreAttributesFn(i,t))continue;let a=n[o][4],c=this.options.attributeNamePrefix+i;if(i.length)if(this.options.transformAttributeName&&(c=this.options.transformAttributeName(c)),c==="__proto__"&&(c="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const u=this.options.attributeValueProcessor(i,a,t);u==null?s[c]=a:typeof u!=typeof a||u!==a?s[c]=u:s[c]=qt(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(s[c]=!0)}if(!Object.keys(s).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=s,o}return s}}const Ao=function(e){e=e.replace(/\r\n?/g,`
`);const t=new oe("!xml");let n=t,r="",s="";const o=new ho(this.options.processEntities);for(let i=0;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="/"){const c=ie(e,">",i,"Closing Tag is not closed.");let u=e.substring(i+2,c).trim();if(this.options.removeNSPrefix){const p=u.indexOf(":");p!==-1&&(u=u.substr(p+1))}this.options.transformTagName&&(u=this.options.transformTagName(u)),n&&(r=this.saveTextToParentTag(r,n,s));const f=s.substring(s.lastIndexOf(".")+1);if(u&&this.options.unpairedTags.indexOf(u)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${u}>`);let l=0;f&&this.options.unpairedTags.indexOf(f)!==-1?(l=s.lastIndexOf(".",s.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=s.lastIndexOf("."),s=s.substring(0,l),n=this.tagsNodeStack.pop(),r="",i=c}else if(e[i+1]==="?"){let c=kt(e,i,!1,"?>");if(!c)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,s),!(this.options.ignoreDeclaration&&c.tagName==="?xml"||this.options.ignorePiTags)){const u=new oe(c.tagName);u.add(this.options.textNodeName,""),c.tagName!==c.tagExp&&c.attrExpPresent&&(u[":@"]=this.buildAttributesMap(c.tagExp,s)),this.addChild(n,u,s,i)}i=c.closeIndex+1}else if(e.substr(i+1,3)==="!--"){const c=ie(e,"-->",i+4,"Comment is not closed.");if(this.options.commentPropName){const u=e.substring(i+4,c-2);r=this.saveTextToParentTag(r,n,s),n.add(this.options.commentPropName,[{[this.options.textNodeName]:u}])}i=c}else if(e.substr(i+1,2)==="!D"){const c=o.readDocType(e,i);this.docTypeEntities=c.entities,i=c.i}else if(e.substr(i+1,2)==="!["){const c=ie(e,"]]>",i,"CDATA is not closed.")-2,u=e.substring(i+9,c);r=this.saveTextToParentTag(r,n,s);let f=this.parseTextData(u,n.tagname,s,!0,!1,!0,!0);f==null&&(f=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:u}]):n.add(this.options.textNodeName,f),i=c+2}else{let c=kt(e,i,this.options.removeNSPrefix),u=c.tagName;const f=c.rawTagName;let l=c.tagExp,p=c.attrExpPresent,d=c.closeIndex;if(this.options.transformTagName){const m=this.options.transformTagName(u);l===u&&(l=m),u=m}n&&r&&n.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,n,s,!1));const h=n;h&&this.options.unpairedTags.indexOf(h.tagname)!==-1&&(n=this.tagsNodeStack.pop(),s=s.substring(0,s.lastIndexOf("."))),u!==t.tagname&&(s+=s?"."+u:u);const g=i;if(this.isItStopNode(this.stopNodesExact,this.stopNodesWildcard,s,u)){let m="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)u[u.length-1]==="/"?(u=u.substr(0,u.length-1),s=s.substr(0,s.length-1),l=u):l=l.substr(0,l.length-1),i=c.closeIndex;else if(this.options.unpairedTags.indexOf(u)!==-1)i=c.closeIndex;else{const N=this.readStopNodeData(e,f,d+1);if(!N)throw new Error(`Unexpected end of ${f}`);i=N.i,m=N.tagContent}const E=new oe(u);u!==l&&p&&(E[":@"]=this.buildAttributesMap(l,s)),m&&(m=this.parseTextData(m,u,s,!0,p,!0,!0)),s=s.substr(0,s.lastIndexOf(".")),E.add(this.options.textNodeName,m),this.addChild(n,E,s,g)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){if(u[u.length-1]==="/"?(u=u.substr(0,u.length-1),s=s.substr(0,s.length-1),l=u):l=l.substr(0,l.length-1),this.options.transformTagName){const E=this.options.transformTagName(u);l===u&&(l=E),u=E}const m=new oe(u);u!==l&&p&&(m[":@"]=this.buildAttributesMap(l,s)),this.addChild(n,m,s,g),s=s.substr(0,s.lastIndexOf("."))}else{const m=new oe(u);this.tagsNodeStack.push(n),u!==l&&p&&(m[":@"]=this.buildAttributesMap(l,s)),this.addChild(n,m,s,g),n=m}r="",i=d}}else r+=e[i];return t.child};function Io(e,t,n,r){this.options.captureMetaData||(r=void 0);const s=this.options.updateTag(t.tagname,n,t[":@"]);s===!1||(typeof s=="string"&&(t.tagname=s),e.addChild(t,r))}const Oo=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Fo(e,t,n,r){return e&&(r===void 0&&(r=t.child.length===0),e=this.parseTextData(e,t.tagname,n,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,r),e!==void 0&&e!==""&&t.add(this.options.textNodeName,e),e=""),e}function Ro(e,t,n,r){return!!(t&&t.has(r)||e&&e.has(n))}function Bo(e,t,n=">"){let r,s="";for(let o=t;o<e.length;o++){let i=e[o];if(r)i===r&&(r="");else if(i==='"'||i==="'")r=i;else if(i===n[0])if(n[1]){if(e[o+1]===n[1])return{data:s,index:o}}else return{data:s,index:o};else i==="	"&&(i=" ");s+=i}}function ie(e,t,n,r){const s=e.indexOf(t,n);if(s===-1)throw new Error(r);return s+t.length-1}function kt(e,t,n,r=">"){const s=Bo(e,t+1,r);if(!s)return;let o=s.data;const i=s.index,a=o.search(/\s/);let c=o,u=!0;a!==-1&&(c=o.substring(0,a),o=o.substring(a+1).trimStart());const f=c;if(n){const l=c.indexOf(":");l!==-1&&(c=c.substr(l+1),u=c!==s.data.substr(l+1))}return{tagName:c,tagExp:o,closeIndex:i,attrExpPresent:u,rawTagName:f}}function ko(e,t,n){const r=n;let s=1;for(;n<e.length;n++)if(e[n]==="<")if(e[n+1]==="/"){const o=ie(e,">",n,`${t} is not closed`);if(e.substring(n+2,o).trim()===t&&(s--,s===0))return{tagContent:e.substring(r,n),i:o};n=o}else if(e[n+1]==="?")n=ie(e,"?>",n+1,"StopNode is not closed.");else if(e.substr(n+1,3)==="!--")n=ie(e,"-->",n+3,"StopNode is not closed.");else if(e.substr(n+1,2)==="![")n=ie(e,"]]>",n,"StopNode is not closed.")-2;else{const o=kt(e,n,">");o&&((o&&o.tagName)===t&&o.tagExp[o.tagExp.length-1]!=="/"&&s++,n=o.closeIndex)}}function qt(e,t,n){if(t&&typeof e=="string"){const r=e.trim();return r==="true"?!0:r==="false"?!1:wo(e,n)}else return eo(e)?e:""}const Et=oe.getMetaDataSymbol();function qo(e,t){return hr(e,t)}function hr(e,t,n){let r;const s={};for(let o=0;o<e.length;o++){const i=e[o],a=$o(i);let c="";if(n===void 0?c=a:c=n+"."+a,a===t.textNodeName)r===void 0?r=i[a]:r+=""+i[a];else{if(a===void 0)continue;if(i[a]){let u=hr(i[a],t,c);const f=zo(u,t);i[Et]!==void 0&&(u[Et]=i[Et]),i[":@"]?Vo(u,i[":@"],c,t):Object.keys(u).length===1&&u[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?u=u[t.textNodeName]:Object.keys(u).length===0&&(t.alwaysCreateTextNode?u[t.textNodeName]="":u=""),s[a]!==void 0&&s.hasOwnProperty(a)?(Array.isArray(s[a])||(s[a]=[s[a]]),s[a].push(u)):t.isArray(a,c,f)?s[a]=[u]:s[a]=u}}}return typeof r=="string"?r.length>0&&(s[t.textNodeName]=r):r!==void 0&&(s[t.textNodeName]=r),s}function $o(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(r!==":@")return r}}function Vo(e,t,n,r){if(t){const s=Object.keys(t),o=s.length;for(let i=0;i<o;i++){const a=s[i];r.isArray(a,n+"."+a,!0,!0)?e[a]=[t[a]]:e[a]=t[a]}}}function zo(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return!!(r===0||r===1&&(e[n]||typeof e[n]=="boolean"||e[n]===0))}class Uo{constructor(t){this.externalEntities={},this.options=po(t)}parse(t,n){if(typeof t!="string"&&t.toString)t=t.toString();else if(typeof t!="string")throw new Error("XML data is accepted in String or Bytes[] form.");if(n){n===!0&&(n={});const o=no(t,n);if(o!==!0)throw Error(`${o.err.msg}:${o.err.line}:${o.err.col}`)}const r=new So(this.options);r.addExternalEntities(this.externalEntities);const s=r.parseXml(t);return this.options.preserveOrder||s===void 0?s:qo(s,this.options)}addEntity(t,n){if(n.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(n==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=n}static getMetaDataSymbol(){return oe.getMetaDataSymbol()}}function Lo(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const n=[];for(let r=0;r<=t.length;r++)n[r]=[r];for(let r=0;r<=e.length;r++)n[0][r]=r;for(let r=1;r<=t.length;r++)for(let s=1;s<=e.length;s++){const o=e[s-1]===t[r-1]?0:1;n[r][s]=Math.min(n[r-1][s]+1,n[r][s-1]+1,n[r-1][s-1]+o)}return n[t.length][e.length]}function Nn(e,t){const n=te(e);let r=null,s=1/0;for(const o of t){const i=te(o);if(n===i||n.endsWith(i)||n.endsWith("-"+i))return o;const a=Lo(n,i),c=Math.max(n.length,i.length),u=Math.ceil(c*.5);a<s&&a<=u&&(s=a,r=o)}return r}function gr(e){const t=[],n=[],r=new Uo({ignoreAttributes:!1,attributeNamePrefix:"",preserveOrder:!0,trimValues:!0,allowBooleanAttributes:!0});let s;try{s=r.parse(e,{allowBooleanAttributes:!0})}catch(a){return{entities:[],errors:[{message:`xml parse error: ${a.message}`}],warnings:[]}}const o=mr(s),i=[];for(const a of o)if(a.tag==="scene")for(const c of a.children){const u=$t(c,t,n);u&&i.push(u)}else if(a.tag==="a"){const c=$t(a,t,n);c&&i.push(c)}else(a.tag.toLowerCase()==="scene"||a.tag.toLowerCase()==="world")&&t.push({message:`Invalid tag "${a.tag}". Use lowercase <scene>`});return{entities:i,errors:t,warnings:n}}function Go(e){return e.startsWith("@")&&e.length>1}function $t(e,t,n){if(e.tag!=="a")return e.tag.toLowerCase()==="a"&&t.push({message:`Invalid tag "${e.tag}". Use lowercase <a>`}),null;const r=[],s=[],o=[],i=[];let a;for(const[c,u]of Object.entries(e.attrs)){if(c==="id"){a=u;continue}if(typeof u=="string"&&Go(u)){o.push({attrName:c,targetName:u.slice(1)});continue}const f=ur(c);if(f){const l={};typeof u=="string"&&u!==""&&(l._value=u),r.push({def:f,attrs:l});continue}typeof u=="string"&&u!==""&&i.push({name:c,value:u})}for(const{name:c,value:u}of i){const f=nn(c);let l=!1;for(const p of r){const d=p.def.component;(f in d||`${f}X`in d)&&(l=!0,p.attrs._value||(p.attrs[c]=u))}if(!l){const p=a?` (${a})`:"";n.push(`shorthand "${c}" matches no declared component${p}`)}}for(const c of e.children)if(c.tag==="a"){const u=$t(c,t,n);u&&s.push(u)}else c.tag.toLowerCase()==="a"?t.push({message:`Invalid tag "${c.tag}". Use lowercase <a>`}):t.push({message:`Only <a> children allowed, found <${c.tag}>`});return{id:a,components:r,children:s,entityRefs:o}}function mr(e){if(!Array.isArray(e))return[];const t=[];for(const n of e)if(!(typeof n!="object"||n===null))for(const[r,s]of Object.entries(n)){if(r===":@")continue;const o=n[":@"]??{},i={};for(const[c,u]of Object.entries(o))typeof u=="string"?i[c]=u:(u===!0||u==="")&&(i[c]="");const a=mr(s);t.push({tag:r,attrs:i,children:a})}return t}const yr=[];function sn(e){yr.push(e)}class Xo{nameToEntity=new Map;getEntityByName(t){return this.nameToEntity.get(t)??null}setName(t,n){this.nameToEntity.set(t,n)}getEntityMap(){return new Map(this.nameToEntity)}}function wr(e,t){const n=gr(t);return Wo(e,n.entities,n.errors)}async function Yo(e,t,n){const r=await n(t);return wr(e,r)}function Wo(e,t,n){const r=new Xo,s=[...n],o=[],i=[],a=[];for(const c of t){const u=br(e,c,r,void 0,o);i.push(u)}for(const{def:c,eid:u,parent:f}of o){f!==void 0&&me(e.world,u,V(Y.relation,f));for(const l of c.entityRefs)jo(e,u,l,r,s);for(const l of c.components)Zo(e,u,l,r,s,a)}for(const c of a){const u=r.getEntityByName(c.targetName);if(u===null){s.push({message:`Unknown entity: "@${c.targetName}"`});continue}Vt(c.component,c.field,c.eid,u)}for(const c of yr)c(e,r);return{entities:r.getEntityMap(),roots:i,errors:s}}function br(e,t,n,r,s){const o=e.addEntity();t.id&&n.setName(t.id,o),s.push({def:t,eid:o,parent:r});for(const i of t.children)br(e,i,n,o,s);return o}function jo(e,t,n,r,s){const o=Zs(n.attrName);if(!o){s.push({message:`Unknown relation: "${n.attrName}"`});return}const i=r.getEntityByName(n.targetName);if(i===null){s.push({message:`Unknown entity: "@${n.targetName}"`});return}e.addRelation(t,o,i)}function Zo(e,t,n,r,s,o){const{def:i,attrs:a}=n,{component:c,name:u,traits:f}=i;e.addComponent(t,c);const l=f?.defaults?.()??{};for(const[h,g]of Object.entries(l))Vt(c,h,t,g);let p,d=[];if(f?.adapter)p=f.adapter(a,t);else{const h=Do(i,a);p=h.values,d=h.entityRefs;for(const g of h.errors)s.push({message:`<${u}> ${g}`})}for(const[h,g]of Object.entries(p))Vt(c,h,t,g);for(const h of d)o.push({eid:t,component:c,field:h.field,targetName:h.targetName})}function Do(e,t){const n={},r=[],s=[];if(t._value&&Sn(t._value)){const o=Nt(e.name,t._value,e.component);Object.assign(n,o.values),r.push(...o.entityRefs),s.push(...o.errors)}for(const[o,i]of Object.entries(t))if(o!=="_value"&&i)if(Sn(i)){const a=Nt(e.name,i,e.component);Object.assign(n,a.values),r.push(...a.entityRefs),s.push(...a.errors)}else{const a=Nt(e.name,`${o}: ${i}`,e.component);Object.assign(n,a.values),r.push(...a.entityRefs),s.push(...a.errors)}return{values:n,entityRefs:r,errors:s}}function Vt(e,t,n,r){const s=e[t];s!=null&&(ArrayBuffer.isView(s)||Array.isArray(s))&&(s[n]=r)}function vr(e,t){return`${t}X`in e&&`${t}Y`in e}function xr(e,t){return vr(e,t)&&`${t}Z`in e}function Ho(e,t){return xr(e,t)&&`${t}W`in e}function Qo(e){if(e=e.trim(),e.startsWith("0x")||e.startsWith("0X"))return parseInt(e,16);if(e.startsWith("#"))return parseInt(e.slice(1),16);if(e==="true")return 1;if(e==="false")return 0;const t=parseFloat(e);return isNaN(t)?null:t}function Ko(e){const t=[],n=e.trim();let r=0;for(let s=0;s<=n.length;s++){const o=s<n.length&&/\s/.test(n[s]),i=s===n.length;(o||i)&&(r<s&&t.push(Qo(n.slice(r,s))),r=s+1)}return t}function Jo(e){const t=[];let n=0;for(let r=0;r<=e.length;r++)if(r===e.length||e[r]===";"){const s=e.slice(n,r).trim();s&&t.push(s),n=r+1}return t}function Nt(e,t,n){const r={},s=[],o=[],i=Jo(t);for(const a of i){const c=a.indexOf(":");if(c===-1){o.push(`Invalid syntax: "${a}" (expected "field: value")`);continue}const u=a.slice(0,c).trim(),f=a.slice(c+1).trim();if(!u||!f){o.push(`Invalid syntax: "${a}" (empty field or value)`);continue}const l=nn(u);if(f.startsWith("@")&&f.length>1){if(l in n)s.push({field:l,targetName:f.slice(1)});else{const m=Object.keys(n),E=Nn(u,m);E?o.push(`${e}: unknown field "${u}", did you mean "${te(E)}"?`):o.push(`${e}: unknown field "${u}"`)}continue}const p=Ko(f);if(p.some(m=>m===null)){o.push(`Invalid number in "${a}"`);continue}const d=p;if(Ho(n,l)){d.length===4?(r[`${l}X`]=d[0],r[`${l}Y`]=d[1],r[`${l}Z`]=d[2],r[`${l}W`]=d[3]):d.length===1?(r[`${l}X`]=d[0],r[`${l}Y`]=d[0],r[`${l}Z`]=d[0],r[`${l}W`]=d[0]):o.push(`${e}.${u}: expected 1 or 4 values, got ${d.length}`);continue}if(xr(n,l)){d.length===3?(r[`${l}X`]=d[0],r[`${l}Y`]=d[1],r[`${l}Z`]=d[2]):d.length===1?(r[`${l}X`]=d[0],r[`${l}Y`]=d[0],r[`${l}Z`]=d[0]):o.push(`${e}.${u}: expected 1 or 3 values, got ${d.length}`);continue}if(vr(n,l)){d.length===2?(r[`${l}X`]=d[0],r[`${l}Y`]=d[1]):d.length===1?(r[`${l}X`]=d[0],r[`${l}Y`]=d[0]):o.push(`${e}.${u}: expected 1 or 2 values, got ${d.length}`);continue}if(l in n){d.length===1?r[l]=d[0]:o.push(`${e}.${u}: expected 1 value, got ${d.length}`);continue}const h=Object.keys(n),g=Nn(u,h);g?o.push(`${e}: unknown field "${u}", did you mean "${te(g)}"?`):o.push(`${e}: unknown field "${u}"`)}return{values:r,entityRefs:s,errors:o}}function Sn(e){return e.includes(":")&&(e.includes(";")||/^[\w-]+\s*:/.test(e))}const ei=Object.freeze(Object.defineProperty({__proto__:null,loadScene:wr,loadSceneFile:Yo,parseXml:gr,registerPostLoadHook:sn},Symbol.toStringTag,{value:"Module"})),zt=["opaque","transparent","postprocess"];function ti(e){const t=e.map(i=>({id:i.id,phase:i.phase??"opaque",inputs:i.inputs,outputs:i.outputs})),n=new Map;for(const i of e)for(const a of i.outputs)n.set(a.id,i.id);const r=[];for(const i of e)for(const a of i.inputs){const c=n.get(a.id);c&&r.push({from:c,to:i.id,resource:a.id})}const s=new Map;for(const i of zt)s.set(i,[]);for(const i of t)s.get(i.phase).push(i.id);const o=ni(e);return{nodes:t,edges:r,executionOrder:o,byPhase:s}}function ni(e){if(e.length===0)return[];const t=new Map;for(const i of e)for(const a of i.outputs)t.set(a.id,i);const n=new Map,r=new Map;for(const i of e)n.set(i,[]),r.set(i,0);for(const i of e)for(const a of i.inputs){const c=t.get(a.id);c&&(n.get(c).push(i),r.set(i,r.get(i)+1))}const s=new Map;for(const i of zt)s.set(i,[]);for(const i of e){const a=i.phase??"opaque";s.get(a).push(i)}const o=[];for(const i of zt){const a=s.get(i),c=new Map;for(const l of a){let p=0;for(const d of l.inputs){const h=t.get(d.id);h&&a.includes(h)&&p++}c.set(l,p)}const u=[];for(const l of a)c.get(l)===0&&u.push(l);let f=0;for(;f<u.length;){const l=u[f++];o.push(l.id);for(const p of a)for(const d of p.inputs)if(t.get(d.id)===l){const g=c.get(p)-1;c.set(p,g),g===0&&u.push(p)}}}return o}const Tn=["opaque","transparent","postprocess"];function ri(e){const t=[],n=new Map;for(const r of e)for(const s of r.outputs)n.set(s.id,r);for(const r of e)for(const s of r.inputs){const o=n.get(s.id);o&&t.push([o,r])}return t}function si(e){if(e.length===0)return[];const t=ri(e),n=new Map,r=new Map;for(const a of e)n.set(a,[]),r.set(a,0);for(const[a,c]of t)n.get(a).push(c),r.set(c,r.get(c)+1);const s=[];for(const a of e)r.get(a)===0&&s.push(a);const o=[];let i=0;for(;i<s.length;){const a=s[i++];o.push(a);for(const c of n.get(a)){const u=r.get(c)-1;r.set(c,u),u===0&&s.push(c)}}if(o.length!==e.length)throw new sr;return o}function oi(e){if(e.length===0)return{sorted:[]};const t=new Map;for(const r of Tn)t.set(r,[]);for(const r of e){const s=r.phase??"opaque";t.get(s).push(r)}const n=[];for(const r of Tn){const s=t.get(r);n.push(...si(s))}return{sorted:n}}class ii{nodes=new Map;_plan=null;add(t){if(this.nodes.has(t.id))throw new Error(`Node '${t.id}' already exists`);this.nodes.set(t.id,t),this._plan=null}set(t,n){if(n.id!==t)throw new Error(`Node id '${n.id}' must match slot id '${t}'`);this.nodes.set(t,n),this._plan=null}remove(t){const n=this.nodes.delete(t);return n&&(this._plan=null),n}compile(){return this._plan||(this._plan=oi(Array.from(this.nodes.values()))),this._plan}inspect(){return ti(Array.from(this.nodes.values()))}}function ai(){const e=new Map;return{nodeTimings:e,beginNode(t){e.set(t,{start:performance.now(),end:0})},endNode(t){const n=e.get(t);n&&(n.end=performance.now())},finish(t){const n=[];let r=0;for(const[s,o]of e){const i=o.end-o.start;r+=i,n.push({nodeId:s,cpuMs:i})}return{frameIndex:t,nodes:n,totalCpuMs:r}}}}const Pn=1;function _n(e){const t=window.devicePixelRatio||1,n=e.getBoundingClientRect(),r=Math.max(Pn,Math.floor(n.width*t)),s=Math.max(Pn,Math.floor(n.height*t));(e.width!==r||e.height!==s)&&(e.width=r,e.height=s)}let Xe=null,le=null;function on(e,t){return e.createBuffer({label:"entityIds",size:t*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC})}async function ci(){if(!navigator.gpu)throw new Error("WebGPU not supported");const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("No GPU adapter found");const t=e.limits.maxTextureDimension2D;return e.requestDevice({requiredLimits:{maxTextureDimension2D:t}})}const Z=re("compute"),ui={group:"draw",setup(e){e.canvas&&(le=e.canvas,_n(le),Xe=new ResizeObserver(()=>{le&&_n(le)}),Xe.observe(le))},update(e){const t=Z.from(e);if(!t)return;const{device:n,context:r,format:s,graph:o,resources:i}=t,a=o.compile();if(a.sorted.length===0)return;const u=r.getCurrentTexture().createView(),f=n.createCommandEncoder(),l={device:n,queue:n.queue,encoder:f,context:r,format:s,canvasView:u,getTexture(d){return i.textures.get(d)??null},getTextureView(d){return i.textureViews.get(d)??null},getBuffer(d){return i.buffers.get(d)??null},setTexture(d,h){i.textures.set(d,h)},setTextureView(d,h){i.textureViews.set(d,h)},setBuffer(d,h){i.buffers.set(d,h)}},p=ai();for(const d of a.sorted)p.beginNode(d.id),d.execute(l),p.endNode(d.id);n.queue.submit([f.finish()]),t.lastFrameTiming=p.finish(t.frameIndex),t.frameIndex++},dispose(){Xe?.disconnect(),Xe=null,le=null}},ze={systems:[ui],async initialize(e){if(!e.canvas)throw new Error("ComputePlugin requires a canvas");const t=await ci(),n=e.canvas.getContext("webgpu");if(!n)throw new Error("Failed to get WebGPU context");const r=navigator.gpu.getPreferredCanvasFormat();n.configure({device:t,format:r,alphaMode:"premultiplied"});const s=new ii,o={textures:new Map,textureViews:new Map,buffers:new Map};e.setResource(Z,{device:t,context:n,format:r,graph:s,resources:o,lastFrameTiming:null,frameIndex:0})}},Ut=re("input"),Be=new Set,ht=new Set,gt=new Set,B={deltaX:0,deltaY:0,scrollDelta:0,left:!1,right:!1,middle:!1},li={mouse:B,isKeyDown:e=>Be.has(e),isKeyPressed:e=>ht.has(e),isKeyReleased:e=>gt.has(e)};let $=null,ke=0,qe=0,ce=null,Ce=null;function Cn(e){Be.has(e.code)||ht.add(e.code),Be.add(e.code)}function Mn(e){Be.delete(e.code),gt.add(e.code)}function Er(e,t){e===0&&(B.left=t),e===1&&(B.middle=t),e===2&&(B.right=t)}function Nr(){Ce!==null&&Er(Ce,!1),ce=null,Ce=null,ke=0,qe=0}function An(e){e.target===$&&ce===null&&(ce=e.pointerId,Ce=e.button,ke=e.clientX,qe=e.clientY,Er(e.button,!0),$.setPointerCapture(e.pointerId),e.preventDefault())}function In(e){e.pointerId===ce&&($?.releasePointerCapture(e.pointerId),Nr())}function On(e){e.pointerId===ce&&Nr()}function Fn(e){e.pointerId===ce&&(e.preventDefault(),B.deltaX+=e.clientX-ke,B.deltaY+=e.clientY-qe,ke=e.clientX,qe=e.clientY)}function Rn(e){e.target===$&&(B.scrollDelta+=e.deltaY,e.preventDefault())}function Bn(e){e.target===$&&e.preventDefault()}function fi(){ht.clear(),gt.clear(),B.deltaX=0,B.deltaY=0,B.scrollDelta=0}function di(){Be.clear(),ht.clear(),gt.clear(),B.deltaX=0,B.deltaY=0,B.scrollDelta=0,B.left=!1,B.right=!1,B.middle=!1,ce=null,Ce=null,ke=0,qe=0}const pi={group:"simulation",setup(e){e.canvas&&($=e.canvas,$.style.touchAction="none",window.addEventListener("keydown",Cn),window.addEventListener("keyup",Mn),$.addEventListener("pointerdown",An),window.addEventListener("pointerup",In),window.addEventListener("pointercancel",On),window.addEventListener("pointermove",Fn),$.addEventListener("wheel",Rn,{passive:!1}),$.addEventListener("contextmenu",Bn),e.setResource(Ut,li))},dispose(e){$&&(window.removeEventListener("keydown",Cn),window.removeEventListener("keyup",Mn),$.removeEventListener("pointerdown",An),window.removeEventListener("pointerup",In),window.removeEventListener("pointercancel",On),window.removeEventListener("pointermove",Fn),$.removeEventListener("wheel",Rn),$.removeEventListener("contextmenu",Bn),$=null),di(),e.deleteResource(Ut)}},hi={group:"draw",last:!0,update(){fi()}},Sr={systems:[pi,hi]},Tr=e=>e,gi=e=>e*e,mi=e=>e*(2-e),yi=e=>e<.5?2*e*e:-1+(4-2*e)*e,wi=e=>e*e*e,bi=e=>--e*e*e+1,vi=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,xi=e=>e*e*e*e,Ei=e=>1- --e*e*e*e,Ni=e=>e<.5?8*e*e*e*e:1-8*--e*e*e*e,Si=e=>e*e*e*e*e,Ti=e=>1+--e*e*e*e*e,Pi=e=>e<.5?16*e*e*e*e*e:1+16*--e*e*e*e*e,_i=e=>1-Math.cos(e*Math.PI/2),Ci=e=>Math.sin(e*Math.PI/2),Mi=e=>-(Math.cos(Math.PI*e)-1)/2,Ai=e=>e===0?0:Math.pow(2,10*e-10),Ii=e=>e===1?1:1-Math.pow(2,-10*e),Oi=e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,Fi=e=>1-Math.sqrt(1-e*e),Ri=e=>Math.sqrt(1- --e*e),Bi=e=>e<.5?(1-Math.sqrt(1-4*e*e))/2:(Math.sqrt(1-(-2*e+2)*(-2*e+2))+1)/2,ki=e=>(1.70158+1)*e*e*e-1.70158*e*e,qi=e=>1+(1.70158+1)*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),$i=e=>{const t=2.5949095;return e<.5?Math.pow(2*e,2)*((t+1)*2*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(e*2-2)+t)+2)/2},Vi=e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*(2*Math.PI/3)),zi=e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*(2*Math.PI/3))+1,Ui=e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*(2*Math.PI/4.5)))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*(2*Math.PI/4.5))/2+1,ot=e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,Li=e=>1-ot(1-e),Gi=e=>e<.5?(1-ot(1-2*e))/2:(1+ot(2*e-1))/2,Xi=[Tr,gi,mi,yi,wi,bi,vi,xi,Ei,Ni,Si,Ti,Pi,_i,Ci,Mi,Ai,Ii,Oi,Fi,Ri,Bi,ki,qi,$i,Vi,zi,Ui,Li,ot,Gi],Yi={linear:0,"ease-in-quad":1,"ease-out-quad":2,"ease-in-out-quad":3,"ease-in-cubic":4,"ease-out-cubic":5,"ease-in-out-cubic":6,"ease-in-quart":7,"ease-out-quart":8,"ease-in-out-quart":9,"ease-in-quint":10,"ease-out-quint":11,"ease-in-out-quint":12,"ease-in-sine":13,"ease-out-sine":14,"ease-in-out-sine":15,"ease-in-expo":16,"ease-out-expo":17,"ease-in-out-expo":18,"ease-in-circ":19,"ease-out-circ":20,"ease-in-out-circ":21,"ease-in-back":22,"ease-out-back":23,"ease-in-out-back":24,"ease-in-elastic":25,"ease-out-elastic":26,"ease-in-out-elastic":27,"ease-in-bounce":28,"ease-out-bounce":29,"ease-in-out-bounce":30};function Wi(e){return Yi[e]??0}function ji(e){return Xi[e]??Tr}const Zi=(e,t)=>e-t,Di=(e,t)=>e.endTime-t.endTime,Ye=[],We=[],it={duration:[]};F(it,{defaults:()=>({duration:.5})});const H={IDLE:0,PLAYING:1,COMPLETE:2},O={state:[],elapsed:[]};F(O,{defaults:()=>({state:H.IDLE,elapsed:0})});function Hi(e,t){Ye.length=0;for(const n of e.query([V(Y.relation,t)]))Ye.push(n);return Ye.sort(Zi),Ye}function Qi(e,t){const n=Hi(e,t);let r=0;for(const s of n)e.hasComponent(s,it)?r+=it.duration[s]??0:e.hasComponent(s,x)&&(x.delay[s]=r)}function Ki(e,t){for(const n of e.query([O])){if(O.state[n]!==H.PLAYING)continue;const r=O.elapsed[n]??0;r===0&&Qi(e,n);const s=r+t;O.elapsed[n]=s;for(const o of e.query([V(Y.relation,n),x])){if(x.state[o]!==j.IDLE)continue;const i=x.delay[o]??0,a=s>=i,c=r>=i;a&&(aa(e,o),x.state[o]=j.PLAYING,x.elapsed[o]=c?0:s-i-t)}}}function Ji(e,t){We.length=0;for(const n of e.query([V(Y.relation,t),x])){if(x.state[n]===j.COMPLETE&&x.elapsed[n]>=x.duration[n])continue;const r=x.delay[n]??0,s=x.duration[n]??0;We.push({eid:n,endTime:r+s})}We.sort(Di);for(const{eid:n}of We)x.state[n]=j.COMPLETE,Pr(e,n)}function ea(e){for(const t of e.query([O]))O.state[t]===H.COMPLETE&&Ji(e,t)}function ta(e){for(const t of e.query([O])){if(O.state[t]!==H.PLAYING)continue;let n=!0,r=!1;for(const s of e.query([V(Y.relation,t),x]))if(r=!0,x.state[s]!==j.COMPLETE){n=!1;break}r&&n&&(O.state[t]=H.COMPLETE)}}function na(e,t){Ki(e,t)}function ra(e){if(e._value){const t={};for(const n of e._value.split(";")){const r=n.indexOf(":");if(r===-1)continue;const s=n.slice(0,r).trim(),o=n.slice(r+1).trim();s&&o&&(t[s]=o)}return t}return e}const j={IDLE:0,PLAYING:1,COMPLETE:2},x={state:[],from:[],to:[],duration:[],elapsed:[],delay:[],easingIndex:[]};F(x,{defaults:()=>({state:j.IDLE,from:0,to:0,duration:1,elapsed:0,delay:0,easingIndex:0}),adapter:(e,t)=>{const n=ra(e),r={};return n.duration&&(r.duration=parseFloat(n.duration)),n.delay&&(r.delay=parseFloat(n.delay)),n.easing&&(r.easingIndex=Wi(n.easing)),n.target&&oa(n,t),r}});const Ue=fr("tween-target",{exclusive:!0});function sa(e){if(!e.startsWith("@"))return null;const t=e.slice(1),n=t.indexOf(".");if(n===-1)return null;const r=t.slice(0,n),s=t.slice(n+1),o=s.lastIndexOf(".");return o===-1?null:{entity:r,component:s.slice(0,o),field:s.slice(o+1)}}let Lt=[];function oa(e,t){Lt.push({tweenEid:t,target:e.target,to:e.to})}function ia(e,t){for(const n of Lt){const r=sa(n.target);if(!r)continue;const s=t.getEntityByName(r.entity);if(s===null||!e.bindFieldAccessor(n.tweenEid,r.component,r.field))continue;e.addRelation(n.tweenEid,Ue,s);const i=n.to.startsWith("0x")||n.to.startsWith("0X")?parseInt(n.to,16):parseFloat(n.to);if(!Number.isFinite(i))throw new Error(`Tween has invalid 'to' value: "${n.to}" (parsed as ${i})`);x.to[n.tweenEid]=i}Lt=[]}function aa(e,t){const n=e.getFirstRelationTarget(t,Ue),r=e.getFieldAccessor(t);r&&n>=0&&(x.from[t]=r.get(n)??0)}function Pr(e,t){const n=x.elapsed[t],r=x.duration[t];if(n>=r)return;const s=e.getFirstRelationTarget(t,Ue),o=e.getFieldAccessor(t);if(o&&s>=0){const i=x.to[t];if(!Number.isFinite(i))throw new Error(`Tween ${t} has invalid to value: ${i}`);x.from[t]=o.get(s)??0,o.set(s,i)}x.elapsed[t]=r}function ca(e,t){for(const n of e.query([x])){const r=x.state[n];if(r===j.COMPLETE){Pr(e,n);continue}if(r!==j.PLAYING)continue;const s=e.getFirstRelationTarget(n,Ue),o=e.getFieldAccessor(n);x.elapsed[n]===0&&o&&s>=0&&(x.from[n]=o.get(s)??0),x.elapsed[n]+=t;const i=x.elapsed[n],a=x.duration[n],c=a<=0?1:Math.min(i/a,1);if(!Number.isFinite(c))throw new Error(`Tween ${n} invalid progress: elapsed=${i}, duration=${a}, dt=${t}`);const f=ji(x.easingIndex[n])(c),l=x.from[n],p=x.to[n],d=l+(p-l)*f;if(!Number.isFinite(d))throw new Error(`Tween ${n} computed NaN: from=${l}, to=${p}, eased=${f}, raw=${c}`);o&&s>=0&&o.set(s,d),c>=1&&(x.state[n]=j.COMPLETE)}}const ua={group:"simulation",update(e){const t=e.time.deltaTime;ea(e),na(e,t),ca(e,t),ta(e)}},mu={systems:[ua],components:{Tween:x,Sequence:O,Pause:it},relations:[Ue],initialize(){sn(ia)}};let A;function la(e){A.compute_transforms(e)}function fa(){return A.get_indices_ptr()>>>0}function da(){return A.get_matrices_ptr()>>>0}function pa(){return A.get_max_entities()>>>0}function ha(){return A.get_no_parent()>>>0}function ga(){return A.get_parents_ptr()>>>0}function ma(){return A.get_pos_x_ptr()>>>0}function ya(){return A.get_pos_y_ptr()>>>0}function wa(){return A.get_pos_z_ptr()>>>0}function ba(){return A.get_quat_w_ptr()>>>0}function va(){return A.get_quat_x_ptr()>>>0}function xa(){return A.get_quat_y_ptr()>>>0}function Ea(){return A.get_quat_z_ptr()>>>0}function Na(){return A.get_scale_x_ptr()>>>0}function Sa(){return A.get_scale_y_ptr()>>>0}function Ta(){return A.get_scale_z_ptr()>>>0}function Pa(){A.init_data()}const _a=new Set(["basic","cors","default"]);async function Ca(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.ok&&_a.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function Ma(){const e={};return e.wbg={},e}function Aa(e,t){return A=e.exports,_r.__wbindgen_wasm_module=t,A}async function _r(e){if(A!==void 0)return A;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL(""+new URL("shallot_transforms_bg-Bqdpqo0Z.wasm",import.meta.url).href,import.meta.url));const t=Ma();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await Ca(await e,t);return Aa(n,r)}let Gt,Cr,Mr,Ar,Ir,Or,Fr,Rr,Br,kr,qr,Xt,Yt,$r;async function Ia(){if(Gt)return;const e=await _r();Pa();const t=e.memory.buffer,n=pa();Gt=new Float32Array(t,ma(),n),Cr=new Float32Array(t,ya(),n),Mr=new Float32Array(t,wa(),n),Ar=new Float32Array(t,va(),n),Ir=new Float32Array(t,xa(),n),Or=new Float32Array(t,Ea(),n),Fr=new Float32Array(t,ba(),n),Rr=new Float32Array(t,Na(),n),Br=new Float32Array(t,Sa(),n),kr=new Float32Array(t,Ta(),n),qr=new Float32Array(t,da(),n*16),Xt=new Uint32Array(t,fa(),n),Yt=new Uint32Array(t,ga(),n),$r=ha()}function Oa(e){la(e)}function St(e){function t(r){return wn(b.quatX[r],b.quatY[r],b.quatZ[r],b.quatW[r])[e]}function n(r,s){const o=wn(b.quatX[r],b.quatY[r],b.quatZ[r],b.quatW[r]);o[e]=s;const i=Ds(o.x,o.y,o.z);b.quatX[r]=i.x,b.quatY[r]=i.y,b.quatZ[r]=i.z,b.quatW[r]=i.w}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}const b={posX:new Float32Array(S),posY:new Float32Array(S),posZ:new Float32Array(S),quatX:new Float32Array(S),quatY:new Float32Array(S),quatZ:new Float32Array(S),quatW:new Float32Array(S),scaleX:new Float32Array(S),scaleY:new Float32Array(S),scaleZ:new Float32Array(S),eulerX:St("x"),eulerY:St("y"),eulerZ:St("z")},ue={data:new Float32Array(S*16)};F(b,{defaults:()=>({posX:0,posY:0,posZ:0,quatX:0,quatY:0,quatZ:0,quatW:1,scaleX:1,scaleY:1,scaleZ:1}),accessors:{eulerX:b.eulerX,eulerY:b.eulerY,eulerZ:b.eulerZ}});async function Fa(){await Ia(),b.posX=Gt,b.posY=Cr,b.posZ=Mr,b.quatX=Ar,b.quatY=Ir,b.quatZ=Or,b.quatW=Fr,b.scaleX=Rr,b.scaleY=Br,b.scaleZ=kr,ue.data=qr}const Ra={group:"simulation",last:!0,update(e){for(const n of e.query([b,fn(ue)]))e.addComponent(n,ue);let t=0;for(const n of e.query([b,fn(Y.relation(k))]))Xt[t]=n,Yt[t]=$r,t++;for(const n of e.query([b,Y.relation(k),Ms(Y.relation)]))Xt[t]=n,Yt[t]=e.getRelationTargets(n,Y)[0],t++;Oa(t)}},Ba={systems:[Ra],components:{Transform:b,WorldTransform:ue},initialize:Fa},ka=192,be="depth24plus",Vr="r8unorm";function qa(e){return e.createBuffer({label:"scene",size:ka,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC})}function $a(e,t,n,r,s,o){const i=s.get("scene");if(i&&i.width===n&&i.height===r)return;i?.destroy(),s.get("depth")?.destroy(),s.get("mask")?.destroy();const a=e.createTexture({label:"scene",size:{width:n,height:r},format:t,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),c=e.createTexture({label:"depth",size:{width:n,height:r},format:be,usage:GPUTextureUsage.RENDER_ATTACHMENT}),u=e.createTexture({label:"mask",size:{width:n,height:r},format:Vr,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING});s.set("scene",a),o.set("scene",a.createView()),s.set("depth",c),o.set("depth",c.createView()),s.set("mask",u),o.set("mask",u.createView())}function Va(e,t,n,r){if(e<=0)throw new Error(`Invalid FOV: ${e} (must be > 0)`);if(t<=0)throw new Error(`Invalid aspect ratio: ${t} (must be > 0)`);if(n===r)throw new Error(`Invalid depth planes: near === far (${n})`);const s=1/Math.tan(e*Math.PI/360),o=1/(n-r);return new Float32Array([s/t,0,0,0,0,s,0,0,0,0,(r+n)*o,-1,0,0,2*r*n*o,0])}function za(e,t,n,r){if(e<=0)throw new Error(`Invalid orthographic size: ${e} (must be > 0)`);if(t<=0)throw new Error(`Invalid aspect ratio: ${t} (must be > 0)`);if(n===r)throw new Error(`Invalid depth planes: near === far (${n})`);const s=1/(e*t),o=1/e,i=1/(n-r);return new Float32Array([s,0,0,0,0,o,0,0,0,0,i,0,0,0,n*i,1])}function Ua(e,t){const n=new Float32Array(16);for(let r=0;r<4;r++)for(let s=0;s<4;s++)n[s*4+r]=e[r]*t[s*4]+e[r+4]*t[s*4+1]+e[r+8]*t[s*4+2]+e[r+12]*t[s*4+3];return n}function La(e){const t=new Float32Array(16),n=e[0],r=e[1],s=e[2],o=e[4],i=e[5],a=e[6],c=e[8],u=e[9],f=e[10],l=e[12],p=e[13],d=e[14];return t[0]=n,t[1]=o,t[2]=c,t[3]=0,t[4]=r,t[5]=i,t[6]=u,t[7]=0,t[8]=s,t[9]=a,t[10]=f,t[11]=0,t[12]=-(n*l+r*p+s*d),t[13]=-(o*l+i*p+a*d),t[14]=-(c*l+u*p+f*d),t[15]=1,t}const at=20;function Ga(e,t){return e.createBuffer({label:"indirect",size:t*at,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC})}function Xa(e,t,n,r){const s=n*at,o=new ArrayBuffer(at),i=new DataView(o);i.setUint32(0,r.indexCount,!0),i.setUint32(4,r.instanceCount,!0),i.setUint32(8,r.firstIndex,!0),i.setInt32(12,r.baseVertex,!0),i.setUint32(16,r.firstInstance,!0),e.queue.writeBuffer(t,s,o)}const Ya=`
struct VertexInput {
    @location(0) position: vec3<f32>,
    @location(1) normal: vec3<f32>,
    @builtin(instance_index) instance: u32,
}

struct VertexOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) worldNormal: vec3<f32>,
    @location(2) @interpolate(flat) materialId: u32,
}

struct Scene {
    viewProj: mat4x4<f32>,
    cameraWorld: mat4x4<f32>,
    ambientColor: vec4<f32>,
    sunDirection: vec4<f32>,
    sunColor: vec4<f32>,
    cameraMode: f32,
    cameraSize: f32,
    viewport: vec2<f32>,
}

struct MaterialData {
    emission: vec3<f32>,
    roughness: f32,
    metallic: f32,
    _pad0: f32,
    _pad1: f32,
    _pad2: f32,
}

@group(0) @binding(0) var<uniform> scene: Scene;
@group(0) @binding(1) var<storage, read> entityIds: array<u32>;
@group(0) @binding(2) var<storage, read> matrices: array<mat4x4<f32>>;
@group(0) @binding(3) var<storage, read> colors: array<vec4<f32>>;
@group(0) @binding(4) var<storage, read> sizes: array<vec4<f32>>;
@group(0) @binding(5) var<storage, read> materials: array<MaterialData>;
@group(0) @binding(6) var<storage, read> matIds: array<u32>;

@vertex
fn vs(input: VertexInput) -> VertexOutput {
    let eid = entityIds[input.instance];
    let world = matrices[eid];
    let scaledPos = input.position * sizes[eid].xyz;
    let worldPos = world * vec4<f32>(scaledPos, 1.0);
    let worldNormal = normalize((world * vec4<f32>(input.normal, 0.0)).xyz);

    var output: VertexOutput;
    output.position = scene.viewProj * worldPos;
    output.color = colors[eid];
    output.worldNormal = worldNormal;
    output.materialId = matIds[eid];
    return output;
}

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
    let mat = materials[input.materialId];
    let normal = normalize(input.worldNormal);
    let NdotL = max(dot(normal, -scene.sunDirection.xyz), 0.0);

    let ambient = scene.ambientColor.rgb * scene.ambientColor.a;
    let diffuse = scene.sunColor.rgb * NdotL;
    let diffuseFactor = 1.0 - mat.metallic * 0.9;
    let lighting = ambient + diffuse * diffuseFactor;

    return vec4<f32>(input.color.rgb * lighting + mat.emission, input.color.a);
}
`;function Wa(e,t){const n=e.createShaderModule({code:Ya});return e.createRenderPipeline({layout:"auto",vertex:{module:n,entryPoint:"vs",buffers:[{arrayStride:24,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"}]}]},fragment:{module:n,entryPoint:"fs",targets:[{format:t}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:be,depthWriteEnabled:!0,depthCompare:"less"}})}const He={r:.1,g:.1,b:.1,a:1};function ja(e){let t=null;const n=new Map;return{id:"forward",inputs:[],outputs:[{id:"scene",access:"write"},{id:"depth",access:"write"}],execute(r){const{device:s,encoder:o,format:i}=r,a=r.getTextureView("scene")??r.canvasView,c=r.getTextureView("depth");t||(t=Wa(s,i));const u=o.beginRenderPass({colorAttachments:[{view:a,clearValue:He,loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:c,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}),f=e.getCallbacks(),l=f.filter(h=>h.order<0).sort((h,g)=>h.order-g.order),p=f.filter(h=>h.order>=0).sort((h,g)=>h.order-g.order),d={device:s,format:i,depthFormat:be,scene:e.scene,matrices:e.matrices};for(const h of l)h.draw(u,d);u.setPipeline(t);for(const h of e.batches.values()){let g=n.get(h.index);g||(g=s.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.scene}},{binding:1,resource:{buffer:h.entityIds}},{binding:2,resource:{buffer:e.matrices}},{binding:3,resource:{buffer:e.colors}},{binding:4,resource:{buffer:e.sizes}},{binding:5,resource:{buffer:e.materials}},{binding:6,resource:{buffer:e.materialIds}}]}),n.set(h.index,g)),u.setBindGroup(0,g),u.setVertexBuffer(0,h.buffers.vertex),u.setIndexBuffer(h.buffers.index,"uint16"),u.drawIndexedIndirect(e.indirect,h.index*at)}for(const h of p)h.draw(u,d);u.end()}}}const Za={Raster:0},Da={Color:0},zr={Perspective:0,Orthographic:1},U={fov:[],near:[],far:[],active:[],clearColor:[],renderMode:[],debugMode:[],mode:[],size:[]};F(U,{defaults:()=>({fov:60,near:.1,far:1e3,active:1,clearColor:1710618,renderMode:Za.Raster,debugMode:Da.Color,mode:zr.Perspective,size:5})});const ct={exposure:[]};F(ct,{defaults:()=>({exposure:1})});const Ur={},de={strength:[],inner:[],outer:[]};F(de,{defaults:()=>({strength:.5,inner:.4,outer:.8})});function Wt(e){return{r:(e>>16&255)/255,g:(e>>8&255)/255,b:(e&255)/255}}function Ha(e,t,n,r,s){const o=Wt(U.clearColor[n]);He.r=o.r,He.g=o.g,He.b=o.b;const i=r/s,a=U.mode[n]===zr.Orthographic?za(U.size[n],i,U.near[n],U.far[n]):Va(U.fov[n],i,U.near[n],U.far[n]),c=ue.data.subarray(n*16,n*16+16),u=La(c),f=Ua(a,u);e.queue.writeBuffer(t,0,f),e.queue.writeBuffer(t,64,c),e.queue.writeBuffer(t,176,new Float32Array([U.mode[n],U.size[n],r,s]))}const Me={color:[],intensity:[]};F(Me,{defaults:()=>({color:8947848,intensity:1})});const Q={color:[],intensity:[],directionX:[],directionY:[],directionZ:[]};F(Q,{defaults:()=>({color:16777215,intensity:1,directionX:-.6,directionY:-1,directionZ:-.8})});function Qa(e,t,n){const r=Math.sqrt(e*e+t*t+n*n);return r<1e-4?[0,-1,0]:[e/r,t/r,n/r]}function Ka(e,t){const n=new Float32Array(12),r=Wt(e.color);n[0]=r.r,n[1]=r.g,n[2]=r.b,n[3]=e.intensity;const[s,o,i]=Qa(t.directionX,t.directionY,t.directionZ);n[4]=s,n[5]=o,n[6]=i,n[7]=0;const a=Wt(t.color);return n[8]=a.r*t.intensity,n[9]=a.g*t.intensity,n[10]=a.b*t.intensity,n[11]=0,n}function Ja(){const e=new Float32Array([-.5,-.5,.5,0,0,1,.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,.5,.5,0,0,1,.5,-.5,-.5,0,0,-1,-.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,.5,-.5,0,0,-1,-.5,.5,.5,0,1,0,.5,.5,.5,0,1,0,.5,.5,-.5,0,1,0,-.5,.5,-.5,0,1,0,-.5,-.5,-.5,0,-1,0,.5,-.5,-.5,0,-1,0,.5,-.5,.5,0,-1,0,-.5,-.5,.5,0,-1,0,.5,-.5,.5,1,0,0,.5,-.5,-.5,1,0,0,.5,.5,-.5,1,0,0,.5,.5,.5,1,0,0,-.5,-.5,-.5,-1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0]),t=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);return{vertices:e,indices:t,vertexCount:24,indexCount:36}}function ec(e=32,t=16){const n=[],r=[];for(let o=0;o<=t;o++){const a=o/t*Math.PI;for(let c=0;c<=e;c++){const f=c/e*Math.PI*2,l=Math.sin(a)*Math.cos(f),p=Math.cos(a),d=Math.sin(a)*Math.sin(f);n.push(l*.5,p*.5,d*.5,l,p,d)}}for(let o=0;o<t;o++)for(let i=0;i<e;i++){const a=o*(e+1)+i,c=a+e+1;r.push(a,a+1,c),r.push(a+1,c+1,c)}return{vertices:new Float32Array(n),indices:new Uint16Array(r),vertexCount:(t+1)*(e+1),indexCount:t*e*6}}function tc(){const e=new Float32Array([-.5,0,.5,0,1,0,.5,0,.5,0,1,0,.5,0,-.5,0,1,0,-.5,0,-.5,0,1,0]),t=new Uint16Array([0,1,2,0,2,3]);return{vertices:e,indices:t,vertexCount:4,indexCount:6}}const Pe=[];function nc(){Pe.length===0&&(Pe.push(Ja()),Pe.push(ec()),Pe.push(tc()))}nc();const Lr={Box:0,Sphere:1};function kn(e){return Pe[e]}const an={data:new Float32Array(S*4)},Gr={data:new Float32Array(S*4)};function rc(){const e=an.data;function t(r){const s=r*4,o=Math.round(e[s]*255),i=Math.round(e[s+1]*255),a=Math.round(e[s+2]*255);return o<<16|i<<8|a}function n(r,s){const o=r*4;e[o]=(s>>16&255)/255,e[o+1]=(s>>8&255)/255,e[o+2]=(s&255)/255,e[o+3]=1}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}function Tt(e){const t=an.data;function n(s){return t[s*4+e]}function r(s,o){t[s*4+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}function Pt(e){const t=Gr.data;function n(s){return t[s*4+e]}function r(s,o){t[s*4+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const X={shape:[],color:rc(),colorR:Tt(0),colorG:Tt(1),colorB:Tt(2),sizeX:Pt(0),sizeY:Pt(1),sizeZ:Pt(2)};F(X,{defaults:()=>({shape:Lr.Box,color:16777215,sizeX:1,sizeY:1,sizeZ:1}),accessors:{color:X.color,colorR:X.colorR,colorG:X.colorG,colorB:X.colorB,sizeX:X.sizeX,sizeY:X.sizeY,sizeZ:X.sizeZ}});function sc(e,t){const n=e.createBuffer({label:"vertex",size:t.vertices.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(n,0,t.vertices);const r=e.createBuffer({label:"index",size:t.indices.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(r,0,t.indices),{vertex:n,index:r,indexCount:t.indexCount}}function oc(e){const t=new Map;for(const n of e){const r=X.shape[n];let s=t.get(r);s||(s=[],t.set(r,s)),s.push(n)}return t}function ic(e,t,n,r){for(const[s,o]of t){let i=n.batches.get(s);if(!i){let a=n.buffers.get(s);if(!a){const c=kn(s)??kn(Lr.Box);a=sc(e,c),n.buffers.set(s,a)}i={index:n.batches.size,buffers:a,entityIds:on(e,S),count:0},n.batches.set(s,i)}e.queue.writeBuffer(i.entityIds,0,new Uint32Array(o)),i.count=o.length,Xa(e,r,i.index,{indexCount:i.buffers.indexCount,instanceCount:o.length,firstIndex:0,baseVertex:0,firstInstance:0})}}const Ae=[];function ac(){Ae.length===0&&Ae.push({roughness:.9,metallic:0,emissionColor:0,emissionIntensity:0})}ac();const cc={Default:0},qn={data:new Uint32Array(S)},we={type:[]};F(we,{defaults:()=>({type:cc.Default})});function uc(e){return{r:(e>>16&255)/255,g:(e>>8&255)/255,b:(e&255)/255}}function lc(){const t=new Float32Array(Ae.length*8);for(let n=0;n<Ae.length;n++){const r=Ae[n],s=n*8,o=r.emissionColor??0,i=r.emissionIntensity??0,a=uc(o);t[s+0]=a.r*i,t[s+1]=a.g*i,t[s+2]=a.b*i,t[s+3]=r.roughness??.9,t[s+4]=r.metallic??0,t[s+5]=0,t[s+6]=0,t[s+7]=0}return t}const fc=`
struct VertexOutput {
    @builtin(position) position: vec4f,
    @location(0) uv: vec2f,
}

struct Uniforms {
    exposure: f32,
    vignetteStrength: f32,
    vignetteInner: f32,
    vignetteOuter: f32,
    texelSizeX: f32,
    texelSizeY: f32,
    flags: u32,
    _pad: u32,
}

@group(0) @binding(0) var inputTexture: texture_2d<f32>;
@group(0) @binding(1) var inputSampler: sampler;
@group(0) @binding(2) var<uniform> uniforms: Uniforms;
@group(0) @binding(3) var maskTexture: texture_2d<f32>;

const FLAG_TONEMAP: u32 = 1u;
const FLAG_FXAA: u32 = 2u;
const FLAG_VIGNETTE: u32 = 4u;

@vertex
fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
    var positions = array<vec2f, 3>(
        vec2f(-1.0, -1.0),
        vec2f(3.0, -1.0),
        vec2f(-1.0, 3.0)
    );

    let pos = positions[vertexIndex];

    var output: VertexOutput;
    output.position = vec4f(pos, 0.0, 1.0);
    output.uv = (pos + 1.0) * 0.5;
    output.uv.y = 1.0 - output.uv.y;
    return output;
}

fn aces(x: vec3f) -> vec3f {
    let a = 2.51;
    let b = 0.03;
    let c = 2.43;
    let d = 0.59;
    let e = 0.14;
    return saturate((x * (a * x + b)) / (x * (c * x + d) + e));
}

fn luma(color: vec3f) -> f32 {
    return dot(color, vec3f(0.299, 0.587, 0.114));
}

const FXAA_REDUCE_MIN: f32 = 1.0 / 128.0;
const FXAA_REDUCE_MUL: f32 = 1.0 / 8.0;
const FXAA_SPAN_MAX: f32 = 8.0;

fn applyFXAA(uv: vec2f, colorM: vec3f) -> vec3f {
    let texelSize = vec2f(uniforms.texelSizeX, uniforms.texelSizeY);

    let colorNW = textureSample(inputTexture, inputSampler, uv + vec2f(-1.0, -1.0) * texelSize).rgb;
    let colorNE = textureSample(inputTexture, inputSampler, uv + vec2f(1.0, -1.0) * texelSize).rgb;
    let colorSW = textureSample(inputTexture, inputSampler, uv + vec2f(-1.0, 1.0) * texelSize).rgb;
    let colorSE = textureSample(inputTexture, inputSampler, uv + vec2f(1.0, 1.0) * texelSize).rgb;

    let lumaM = luma(colorM);
    let lumaNW = luma(colorNW);
    let lumaNE = luma(colorNE);
    let lumaSW = luma(colorSW);
    let lumaSE = luma(colorSE);

    let lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
    let lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));

    var dir: vec2f;
    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
    dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));

    let dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * 0.25 * FXAA_REDUCE_MUL, FXAA_REDUCE_MIN);
    let rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
    dir = clamp(dir * rcpDirMin, vec2f(-FXAA_SPAN_MAX), vec2f(FXAA_SPAN_MAX)) * texelSize;

    let colorA = 0.5 * (
        textureSample(inputTexture, inputSampler, uv + dir * (1.0 / 3.0 - 0.5)).rgb +
        textureSample(inputTexture, inputSampler, uv + dir * (2.0 / 3.0 - 0.5)).rgb
    );

    let colorB = colorA * 0.5 + 0.25 * (
        textureSample(inputTexture, inputSampler, uv + dir * -0.5).rgb +
        textureSample(inputTexture, inputSampler, uv + dir * 0.5).rgb
    );

    let lumaB = luma(colorB);

    if lumaB < lumaMin || lumaB > lumaMax {
        return colorA;
    }
    return colorB;
}

fn applyVignette(color: vec3f, uv: vec2f) -> vec3f {
    let center = vec2f(0.5, 0.5);
    let dist = distance(uv, center);
    let vignette = 1.0 - smoothstep(uniforms.vignetteInner, uniforms.vignetteOuter, dist) * uniforms.vignetteStrength;
    return color * vignette;
}

@fragment
fn fragmentMain(input: VertexOutput) -> @location(0) vec4f {
    var color = textureSample(inputTexture, inputSampler, input.uv).rgb;
    let maskValue = textureSample(maskTexture, inputSampler, input.uv).r;

    if (uniforms.flags & FLAG_FXAA) != 0u {
        let fxaaColor = applyFXAA(input.uv, color);
        color = select(fxaaColor, color, maskValue >= 0.5);
    }

    if (uniforms.flags & FLAG_TONEMAP) != 0u {
        color = aces(color * uniforms.exposure);
    }

    if (uniforms.flags & FLAG_VIGNETTE) != 0u {
        color = applyVignette(color, input.uv);
    }

    return vec4f(color, 1.0);
}
`,dc=1,pc=2,hc=4;function gc(e){let t=null,n=null,r=null;return{id:"postprocess",phase:"postprocess",inputs:[{id:"scene",access:"read"},{id:"mask",access:"read"}],outputs:[{id:"framebuffer",access:"write"}],execute(s){const{device:o,encoder:i,canvasView:a,format:c,context:u}=s,f=u.canvas.width,l=u.canvas.height,p=s.getTextureView("scene"),d=s.getTextureView("mask");if(!t){const y=o.createShaderModule({code:fc});t=o.createRenderPipeline({layout:"auto",vertex:{module:y,entryPoint:"vertexMain"},fragment:{module:y,entryPoint:"fragmentMain",targets:[{format:c}]},primitive:{topology:"triangle-list"}})}n||(n=o.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})),r||(r=o.createSampler({magFilter:"linear",minFilter:"linear"}));let h=0;e.tonemap&&(h|=dc),e.fxaa&&(h|=pc),e.vignetteStrength>0&&(h|=hc);const g=new ArrayBuffer(32),m=new Float32Array(g),E=new Uint32Array(g);m[0]=e.exposure,m[1]=e.vignetteStrength,m[2]=e.vignetteInner,m[3]=e.vignetteOuter,m[4]=1/f,m[5]=1/l,E[6]=h,o.queue.writeBuffer(n,0,g);const N=o.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:p},{binding:1,resource:r},{binding:2,resource:{buffer:n}},{binding:3,resource:d}]}),C=i.beginRenderPass({colorAttachments:[{view:a,loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});C.setPipeline(t),C.setBindGroup(0,N),C.draw(3),C.end()}}}const Xr=re("transparent-pass");function cn(e,t){const n=Xr.from(e);n&&n.contributors.set(t.id,t)}function mc(e){return{id:"transparent",phase:"transparent",inputs:[{id:"depth",access:"read"}],outputs:[{id:"scene",access:"write"},{id:"mask",access:"write"}],execute(t){const n=e.getContributors();if(n.length===0)return;const r=t.getTextureView("scene")??t.canvasView,s=t.getTextureView("depth"),o=t.getTextureView("mask"),i=t.encoder.beginRenderPass({colorAttachments:[{view:r,loadOp:"load",storeOp:"store"},{view:o,clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:s,depthLoadOp:"load",depthStoreOp:"store"}}),a={device:t.device,format:t.format,maskFormat:Vr},c=[...n].sort((u,f)=>u.order-f.order);for(const u of c)u.draw(i,a);i.end()}}}const Yr=re("opaque-pass");function yc(e){const t=Yr.from(e);return t?Array.from(t.callbacks.values()):[]}const Le=re("render"),wc={group:"draw",first:!0,update(e){const t=Le.from(e),n=Z.from(e);if(!t||!n||!e.canvas)return;const{device:r,format:s,resources:o}=n,{width:i,height:a}=e.canvas;$a(r,s,i,a,o.textures,o.textureViews);for(const d of e.query([U]))if(U.active[d]){Ha(r,t.scene,d,i,a),t.postProcess.tonemap=e.hasComponent(d,ct),t.postProcess.tonemap&&(t.postProcess.exposure=ct.exposure[d]),t.postProcess.fxaa=e.hasComponent(d,Ur),e.hasComponent(d,de)?(t.postProcess.vignetteStrength=de.strength[d],t.postProcess.vignetteInner=de.inner[d],t.postProcess.vignetteOuter=de.outer[d]):t.postProcess.vignetteStrength=0;break}let c={color:8947848,intensity:1},u={color:16777215,intensity:1,directionX:-.5,directionY:-1,directionZ:-.5};for(const d of e.query([Me])){c={color:Me.color[d],intensity:Me.intensity[d]};break}for(const d of e.query([Q])){u={color:Q.color[d],intensity:Q.intensity[d],directionX:Q.directionX[d],directionY:Q.directionY[d],directionZ:Q.directionZ[d]};break}const f=Ka(c,u);r.queue.writeBuffer(t.scene,128,f),r.queue.writeBuffer(t.matrices,0,ue.data);const l=e.query([X,ue]),p=oc(l);r.queue.writeBuffer(t.colors,0,an.data),r.queue.writeBuffer(t.sizes,0,Gr.data);for(const d of e.query([we]))qn.data[d]=we.type[d];r.queue.writeBuffer(t.materials,0,lc()),r.queue.writeBuffer(t.materialIds,0,qn.data),ic(r,p,t,t.indirect)}},bc={group:"setup",update(e){for(const t of e.query([X]))e.hasComponent(t,we)||e.addComponent(t,we)}},mt={systems:[bc,wc],components:{Camera:U,Mesh:X,Material:we,AmbientLight:Me,DirectionalLight:Q,Tonemap:ct,FXAA:Ur,Vignette:de},dependencies:[ze],initialize(e){const t=Z.from(e);if(!t)return;const{device:n}=t,r=a=>n.createBuffer({label:"property",size:a,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),s={scene:qa(n),matrices:r(S*64),colors:r(S*16),sizes:r(S*16),materials:r(256*32),materialIds:r(S*4),indirect:Ga(n,16),batches:new Map,buffers:new Map,postProcess:{tonemap:!1,exposure:1,fxaa:!0,vignetteStrength:0,vignetteInner:.4,vignetteOuter:.8}};e.setResource(Le,s);const o={callbacks:new Map};e.setResource(Yr,o);const i={contributors:new Map};e.setResource(Xr,i),t.graph.add(ja({scene:s.scene,matrices:s.matrices,colors:s.colors,sizes:s.sizes,materials:s.materials,materialIds:s.materialIds,indirect:s.indirect,batches:s.batches,getCallbacks:()=>yc(e)})),t.graph.add(mc({getContributors:()=>Array.from(i.contributors.values())})),t.graph.add(gc(s.postProcess))}},vc={bg:"#1a1a1a",track:"#333",bar:"#E8A86B"},xc={bg:"#f5f5f5",track:"#ddd",bar:"#B87654"},Ec=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">
  <defs>
    <radialGradient id="baseGradient" cx="35%" cy="30%" r="70%" fx="25%" fy="20%">
      <stop offset="0%" stop-color="#F5D4B8"/>
      <stop offset="45%" stop-color="#E8A86B"/>
      <stop offset="100%" stop-color="#B87654"/>
    </radialGradient>
  </defs>
  <g transform="rotate(35 40.0 40.0)">
    <path d="M40.0,2 C44.0,10 66.0,28 66.0,46 C66.0,60 48.0,70 40.0,78 C32.0,70 14.0,60 14.0,46 C14.0,28 36.0,10 40.0,2 Z" fill="url(#baseGradient)"/>
    <path d="M40.0,6 C37.0,14 22.0,28 20.0,44 C20.0,52 28.0,62 36.0,70 C34.0,58 26.0,46 26.0,38 C26.0,26 38.0,12 40.0,6 Z" fill="#B87654" opacity="0.45"/>
    <path d="M40.0,6 C43.0,14 58.0,28 60.0,44 C60.0,52 52.0,62 44.0,70 C46.0,58 54.0,46 54.0,38 C54.0,26 42.0,12 40.0,6 Z" fill="#B87654" opacity="0.35"/>
    <path d="M40.0,8 C40.0,20 40.0,50 40.0,72" stroke="#B87654" stroke-width="1" stroke-opacity="0.4" fill="none" stroke-linecap="round"/>
    <path d="M40.0,78 C48.0,70 66.0,60 66.0,46 C61.0,58 44.0,70 40.0,73 Z" fill="#B87654"/>
    <path d="M40.0,2 C36.0,10 14.0,28 14.0,46 C19.0,30 41.0,8 40.0,7 Z" fill="#F5D4B8" opacity="0.7"/>
    <path d="M40.0,2 C44.0,10 66.0,28 66.0,46 C66.0,60 48.0,70 40.0,78 C32.0,70 14.0,60 14.0,46 C14.0,28 36.0,10 40.0,2 Z" fill="none" stroke="#6B4230" stroke-width="2"/>
  </g>
</svg>`;function Wr(e,t){const n=document.createElement("div");n.style.cssText=`
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: ${t};
        z-index: 1000;
    `;const r=e.parentElement;return r&&(getComputedStyle(r).position==="static"&&(r.style.position="relative"),r.appendChild(n)),n}function jr(e){const t=document.createElement("div");t.style.cssText=`
        width: 200px;
        height: 4px;
        background: ${e.track};
        border-radius: 2px;
        overflow: hidden;
    `;const n=document.createElement("div");return n.style.cssText=`
        width: 0%;
        height: 100%;
        background: ${e.bar};
        transition: width 0.15s ease-out;
    `,t.appendChild(n),{track:t,bar:n}}function Nc(e,t){let n=null,r=null;return{show(){n=Wr(e,t.bg);const s=document.createElement("div");s.innerHTML=Ec,s.style.cssText="width: 64px; height: 64px; margin-bottom: 24px;",n.appendChild(s);const o=jr(t);return r=o.bar,n.appendChild(o.track),()=>{n?.remove(),n=null,r=null}},update(s){r&&(r.style.width=`${s*100}%`)}}}function Sc(e,t){let n=null,r=null;return{show(){n=Wr(e,t.bg);const s=jr(t);return r=s.bar,n.appendChild(s.track),()=>{n?.remove(),n=null,r=null}},update(s){r&&(r.style.width=`${s*100}%`)}}}const Tc=e=>Nc(e,vc),yu=e=>Sc(e,xc),Pc=[Ba,Sr,ze,mt];ye.defaultPlugins=Pc;ye.loading=Tc;const Qe=Math.PI*2,jt={Left:0,Middle:1},T={target:[],yaw:[],pitch:[],distance:[],targetYaw:[],targetPitch:[],targetDistance:[],minPitch:[],maxPitch:[],minDistance:[],maxDistance:[],smoothness:[],sensitivity:[],zoomSpeed:[],button:[]};F(T,{defaults:()=>({target:0,yaw:0,pitch:Math.PI/6,distance:8,targetYaw:0,targetPitch:Math.PI/6,targetDistance:10,minPitch:-Math.PI/2+.01,maxPitch:Math.PI/2-.01,minDistance:1,maxDistance:25,smoothness:.3,sensitivity:.005,zoomSpeed:.025,button:jt.Left})});function _c(e,t){const n=Math.max(0,Math.min(1,e));return 1-Math.pow(1-n,t*60)}function Cc(e){return(e%Qe+Qe)%Qe}function Mc(e,t){const n=Cc(t-e);return n>Math.PI?n-Qe:n}function Ac(e,t){return t===jt.Left?e.left:t===jt.Middle?e.middle:e.right}const Ic={group:"simulation",update(e){const t=Ut.from(e),n=e.time.deltaTime;for(const r of e.query([T,b])){const s=T.sensitivity[r],o=T.zoomSpeed[r],i=T.minPitch[r],a=T.maxPitch[r],c=T.minDistance[r],u=T.maxDistance[r],f=T.smoothness[r];if(t&&Ac(t.mouse,T.button[r])&&(T.targetYaw[r]-=t.mouse.deltaX*s,T.targetPitch[r]=yn(T.targetPitch[r]+t.mouse.deltaY*s,i,a)),t&&t.mouse.scrollDelta!==0){const L=T.targetDistance[r],G=Math.max(.3,L*.08),P=t.mouse.scrollDelta*o*G;T.targetDistance[r]=yn(L+P,c,u)}const l=_c(f,n);T.yaw[r]+=Mc(T.yaw[r],T.targetYaw[r])*l,T.pitch[r]+=(T.targetPitch[r]-T.pitch[r])*l,T.distance[r]+=(T.targetDistance[r]-T.distance[r])*l;const p=T.yaw[r],d=T.pitch[r],h=T.distance[r];let g=0,m=0,E=0;const N=T.target[r];N&&e.hasComponent(N,b)&&(g=b.posX[N],m=b.posY[N],E=b.posZ[N]);const C=g+h*Math.cos(d)*Math.sin(p),y=m+h*Math.sin(d),w=E+h*Math.cos(d)*Math.cos(p);b.posX[r]=C,b.posY[r]=y,b.posZ[r]=w;const v=Hs(C,y,w,g,m,E);b.quatX[r]=v.x,b.quatY[r]=v.y,b.quatZ[r]=v.z,b.quatW[r]=v.w}}},wu={systems:[Ic],components:{Orbit:T},dependencies:[Sr]},yt={data:new Float32Array(S*12)};function fe(e){const t=yt.data;function n(s){return t[s*12+e]}function r(s,o){t[s*12+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}function Oc(){const e=yt.data;function t(r){const s=r*12+8,o=Math.round(e[s]*255),i=Math.round(e[s+1]*255),a=Math.round(e[s+2]*255);return o<<16|i<<8|a}function n(r,s){const o=r*12+8;e[o]=(s>>16&255)/255,e[o+1]=(s>>8&255)/255,e[o+2]=(s&255)/255,e[o+3]=1}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}function _t(e){const t=yt.data;function n(s){return t[s*12+8+e]}function r(s,o){t[s*12+8+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const R={offsetX:fe(0),offsetY:fe(1),offsetZ:fe(2),thickness:fe(3),visible:fe(4),opacity:fe(7),color:Oc(),colorR:_t(0),colorG:_t(1),colorB:_t(2)};F(R,{defaults:()=>({offsetX:1,offsetY:0,offsetZ:0,thickness:2,visible:1,opacity:1,color:16777215}),accessors:{offsetX:R.offsetX,offsetY:R.offsetY,offsetZ:R.offsetZ,thickness:R.thickness,visible:R.visible,opacity:R.opacity,color:R.color,colorR:R.colorR,colorG:R.colorG,colorB:R.colorB}});const Fc=`
struct VertexOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) dist: f32,
    @location(2) halfWidth: f32,
}

struct Scene {
    viewProj: mat4x4<f32>,
    cameraWorld: mat4x4<f32>,
    ambientColor: vec4<f32>,
    sunDirection: vec4<f32>,
    sunColor: vec4<f32>,
    cameraMode: f32,
    cameraSize: f32,
    viewport: vec2<f32>,
}

struct LineData {
    offset: vec3<f32>,
    thickness: f32,
    visible: f32,
    _pad1: f32,
    _pad2: f32,
    opacity: f32,
    color: vec4<f32>,
}

@group(0) @binding(0) var<uniform> scene: Scene;
@group(0) @binding(1) var<storage, read> entityIds: array<u32>;
@group(0) @binding(2) var<storage, read> lines: array<LineData>;
@group(0) @binding(3) var<storage, read> matrices: array<mat4x4<f32>>;

@vertex
fn vs(@builtin(vertex_index) vid: u32, @builtin(instance_index) iid: u32) -> VertexOutput {
    let eid = entityIds[iid];
    let line = lines[eid];
    let transform = matrices[eid];

    let start = transform[3].xyz;
    let rotation = mat3x3<f32>(transform[0].xyz, transform[1].xyz, transform[2].xyz);
    let end = start + rotation * line.offset;

    let startClip = scene.viewProj * vec4(start, 1.0);
    let endClip = scene.viewProj * vec4(end, 1.0);

    let startNDC = startClip.xy / startClip.w;
    let endNDC = endClip.xy / endClip.w;

    let dir = endNDC - startNDC;
    let len = length(dir);
    let normDir = select(vec2(1.0, 0.0), dir / len, len > 0.0001);

    // Convert thickness from pixels to NDC (2 pixels / viewport = NDC units)
    let halfWidth = line.thickness * 0.5;
    let aaPadding = 1.0;
    let totalHalf = halfWidth + aaPadding;
    let perpNDC = vec2(-normDir.y, normDir.x) * totalHalf * 2.0 / scene.viewport;

    var pos: vec2<f32>;
    var t: f32;
    var edge: f32;
    switch vid {
        case 0u: { pos = startNDC - perpNDC; t = 0.0; edge = -1.0; }
        case 1u: { pos = startNDC + perpNDC; t = 0.0; edge = 1.0; }
        case 2u: { pos = endNDC + perpNDC; t = 1.0; edge = 1.0; }
        case 3u: { pos = startNDC - perpNDC; t = 0.0; edge = -1.0; }
        case 4u: { pos = endNDC + perpNDC; t = 1.0; edge = 1.0; }
        case 5u: { pos = endNDC - perpNDC; t = 1.0; edge = -1.0; }
        default: { pos = startNDC; t = 0.0; edge = 0.0; }
    }

    let depth = mix(startClip.z / startClip.w, endClip.z / endClip.w, t);

    // edge is -1 to +1 across quad, convert to pixel distance from line center
    let pixelDist = edge * totalHalf;

    var out: VertexOutput;
    out.position = vec4(pos, depth, 1.0);
    out.color = vec4(line.color.rgb, line.color.a * line.opacity);
    out.dist = pixelDist;
    out.halfWidth = halfWidth;
    return out;
}

struct FragmentOutput {
    @location(0) color: vec4<f32>,
    @location(1) mask: f32,
}

@fragment
fn fs(input: VertexOutput) -> FragmentOutput {
    let dist = abs(input.dist);
    let aa = 1.0 - smoothstep(input.halfWidth - 0.5, input.halfWidth + 0.5, dist);
    var out: FragmentOutput;
    out.color = vec4(input.color.rgb, input.color.a * aa);
    out.mask = select(0.0, 1.0, aa > 0.01);
    return out;
}
`;function Rc(e,t,n){const r=e.createShaderModule({code:Fc});return e.createRenderPipeline({layout:"auto",vertex:{module:r,entryPoint:"vs"},fragment:{module:r,entryPoint:"fs",targets:[{format:t,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:n,writeMask:GPUColorWrite.RED}]},primitive:{topology:"triangle-list"},depthStencil:{format:be,depthCompare:"less",depthWriteEnabled:!1}})}function Bc(e){let t=null,n=null;return{id:"lines",order:0,draw(r,s){const o=e.getCount();o!==0&&(t||(t=Rc(s.device,s.format,s.maskFormat)),n||(n=s.device.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.scene}},{binding:1,resource:{buffer:e.entityIds}},{binding:2,resource:{buffer:e.lines}},{binding:3,resource:{buffer:e.matrices}}]})),r.setPipeline(t),r.setBindGroup(0,n),r.draw(6,o))}}}const wt=re("lines"),$n=new Uint32Array(S),kc={group:"draw",update(e){const t=Z.from(e),n=wt.from(e);if(!t||!n)return;const{device:r}=t;let s=0;for(const o of e.query([R,b]))R.visible[o]&&($n[s++]=o);r.queue.writeBuffer(n.buffer,0,yt.data),r.queue.writeBuffer(n.entityIds,0,$n,0,s),n.count=s}},qc={systems:[kc],components:{Line:R},dependencies:[ze,mt],initialize(e){const t=Z.from(e),n=Le.from(e);if(!t||!n)return;const{device:r}=t,s={buffer:r.createBuffer({label:"lines",size:S*12*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),entityIds:on(r,S),count:0};e.setResource(wt,s),cn(e,Bc({scene:n.scene,lines:s.buffer,entityIds:s.entityIds,matrices:n.matrices,getCount:()=>s.count}))}},Zr={data:new Float32Array(S*4)};function Ct(e){const t=Zr.data;function n(s){return t[s*4+e]}function r(s,o){t[s*4+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const K={start:Ct(0),end:Ct(1),size:Ct(2)};F(K,{defaults:()=>({start:0,end:1,size:1}),accessors:{start:K.start,end:K.end,size:K.size}});const $c=2147483648,Vc=`
struct VertexOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
}

struct Scene {
    viewProj: mat4x4<f32>,
    cameraWorld: mat4x4<f32>,
    ambientColor: vec4<f32>,
    sunDirection: vec4<f32>,
    sunColor: vec4<f32>,
    cameraMode: f32,
    cameraSize: f32,
    viewport: vec2<f32>,
}

struct ArrowData {
    start: f32,
    end: f32,
    size: f32,
    _pad: f32,
}

struct LineData {
    offset: vec3<f32>,
    thickness: f32,
    visible: f32,
    _pad1: f32,
    _pad2: f32,
    opacity: f32,
    color: vec4<f32>,
}

const END_FLAG: u32 = 0x80000000u;

@group(0) @binding(0) var<uniform> scene: Scene;
@group(0) @binding(1) var<storage, read> entityIds: array<u32>;
@group(0) @binding(2) var<storage, read> arrows: array<ArrowData>;
@group(0) @binding(3) var<storage, read> lines: array<LineData>;
@group(0) @binding(4) var<storage, read> matrices: array<mat4x4<f32>>;

@vertex
fn vs(@builtin(vertex_index) vid: u32, @builtin(instance_index) iid: u32) -> VertexOutput {
    let packed = entityIds[iid];
    let isEnd = (packed & END_FLAG) != 0u;
    let eid = packed & ~END_FLAG;

    let arrow = arrows[eid];
    let line = lines[eid];
    let transform = matrices[eid];

    // Extract scale from transform matrix (use X axis scale)
    let scale = length(transform[0].xyz);

    let start = transform[3].xyz;
    let rotation = mat3x3<f32>(transform[0].xyz, transform[1].xyz, transform[2].xyz);
    let end = start + rotation * line.offset;

    // Project start and end to clip space
    let startClip = scene.viewProj * vec4(start, 1.0);
    let endClip = scene.viewProj * vec4(end, 1.0);

    // Convert to screen space (pixels from center)
    let startScreen = (startClip.xy / startClip.w) * scene.viewport * 0.5;
    let endScreen = (endClip.xy / endClip.w) * scene.viewport * 0.5;

    // Anchor point in screen space
    let anchorScreen = select(startScreen, endScreen, isEnd);
    let anchorDepth = select(startClip.z / startClip.w, endClip.z / endClip.w, isEnd);

    // Line direction in screen space (correct for aspect ratio)
    let dir = endScreen - startScreen;
    let len = length(dir);
    let normDir = select(vec2(1.0, 0.0), dir / len, len > 0.0001);
    let perp = vec2(-normDir.y, normDir.x);

    // Arrow direction (pointing away from line)
    let arrowDir = select(-normDir, normDir, isEnd);

    // Arrow dimensions in pixels
    let arrowLengthPx = arrow.size * line.thickness * 4.0 * scale;
    let arrowWidthPx = arrow.size * line.thickness * 2.0 * scale;

    // Build triangle in screen space
    var posScreen: vec2<f32>;
    switch vid {
        case 0u: { posScreen = anchorScreen; }  // Tip
        case 1u: { posScreen = anchorScreen - arrowDir * arrowLengthPx + perp * arrowWidthPx; }
        case 2u: { posScreen = anchorScreen - arrowDir * arrowLengthPx - perp * arrowWidthPx; }
        default: { posScreen = anchorScreen; }
    }

    // Convert back to NDC
    let pos = posScreen / (scene.viewport * 0.5);

    var out: VertexOutput;
    out.position = vec4(pos, anchorDepth, 1.0);
    out.color = vec4(line.color.rgb, line.color.a * line.opacity);
    return out;
}

struct FragmentOutput {
    @location(0) color: vec4<f32>,
    @location(1) mask: f32,
}

@fragment
fn fs(input: VertexOutput) -> FragmentOutput {
    var out: FragmentOutput;
    out.color = input.color;
    out.mask = 1.0;
    return out;
}
`;function zc(e,t,n){const r=e.createShaderModule({code:Vc});return e.createRenderPipeline({layout:"auto",vertex:{module:r,entryPoint:"vs"},fragment:{module:r,entryPoint:"fs",targets:[{format:t,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:n,writeMask:GPUColorWrite.RED}]},primitive:{topology:"triangle-list"},depthStencil:{format:be,depthCompare:"less",depthWriteEnabled:!1}})}function Uc(e){let t=null,n=null;return{id:"arrows",order:1,draw(r,s){const o=e.getCount();o!==0&&(t||(t=zc(s.device,s.format,s.maskFormat)),n||(n=s.device.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.scene}},{binding:1,resource:{buffer:e.entityIds}},{binding:2,resource:{buffer:e.arrows}},{binding:3,resource:{buffer:e.lines}},{binding:4,resource:{buffer:e.matrices}}]})),r.setPipeline(t),r.setBindGroup(0,n),r.draw(3,o))}}}const Dr=re("arrows"),Mt=new Uint32Array(S*2),Lc={group:"draw",update(e){const t=Z.from(e),n=Dr.from(e),r=wt.from(e);if(!t||!n||!r)return;const{device:s}=t;let o=0;for(const i of e.query([K,R,b]))R.visible[i]&&(K.start[i]&&(Mt[o++]=i),K.end[i]&&(Mt[o++]=i|$c));s.queue.writeBuffer(n.buffer,0,Zr.data),s.queue.writeBuffer(n.entityIds,0,Mt,0,o),n.count=o}},bu={systems:[Lc],components:{Arrow:K},dependencies:[ze,mt,qc],initialize(e){const t=Z.from(e),n=Le.from(e),r=wt.from(e);if(!t||!n||!r)return;const{device:s}=t,o={buffer:s.createBuffer({label:"arrows",size:S*4*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),entityIds:on(s,S*2),count:0};e.setResource(Dr,o),cn(e,Uc({scene:n.scene,arrows:o.buffer,lines:r.buffer,matrices:n.matrices,entityIds:o.entityIds,getCount:()=>o.count}))}},Ie=1e20;class Gc{constructor({fontSize:t=24,buffer:n=3,radius:r=8,cutoff:s=.25,fontFamily:o="sans-serif",fontWeight:i="normal",fontStyle:a="normal",lang:c=null}={}){this.buffer=n,this.cutoff=s,this.radius=r,this.lang=c;const u=this.size=t+n*4,f=this._createCanvas(u),l=this.ctx=f.getContext("2d",{willReadFrequently:!0});l.font=`${a} ${i} ${t}px ${o}`,l.textBaseline="alphabetic",l.textAlign="left",l.fillStyle="black",this.gridOuter=new Float64Array(u*u),this.gridInner=new Float64Array(u*u),this.f=new Float64Array(u),this.z=new Float64Array(u+1),this.v=new Uint16Array(u)}_createCanvas(t){const n=document.createElement("canvas");return n.width=n.height=t,n}draw(t){const{width:n,actualBoundingBoxAscent:r,actualBoundingBoxDescent:s,actualBoundingBoxLeft:o,actualBoundingBoxRight:i}=this.ctx.measureText(t),a=Math.ceil(r),c=0,u=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(i-o))),f=Math.min(this.size-this.buffer,a+Math.ceil(s)),l=u+2*this.buffer,p=f+2*this.buffer,d=Math.max(l*p,0),h=new Uint8ClampedArray(d),g={data:h,width:l,height:p,glyphWidth:u,glyphHeight:f,glyphTop:a,glyphLeft:c,glyphAdvance:n};if(u===0||f===0)return g;const{ctx:m,buffer:E,gridInner:N,gridOuter:C}=this;this.lang&&(m.lang=this.lang),m.clearRect(E,E,u,f),m.fillText(t,E,E+a);const y=m.getImageData(E,E,u,f);C.fill(Ie,0,d),N.fill(0,0,d);for(let w=0;w<f;w++)for(let v=0;v<u;v++){const L=y.data[4*(w*u+v)+3]/255;if(L===0)continue;const G=(w+E)*l+v+E;if(L===1)C[G]=0,N[G]=Ie;else{const P=.5-L;C[G]=P>0?P*P:0,N[G]=P<0?P*P:0}}Vn(C,0,0,l,p,l,this.f,this.v,this.z),Vn(N,E,E,u,f,l,this.f,this.v,this.z);for(let w=0;w<d;w++){const v=Math.sqrt(C[w])-Math.sqrt(N[w]);h[w]=Math.round(255-255*(v/this.radius+this.cutoff))}return g}}function Vn(e,t,n,r,s,o,i,a,c){for(let u=t;u<t+r;u++)zn(e,n*o+u,o,s,i,a,c);for(let u=n;u<n+s;u++)zn(e,u*o+t,1,r,i,a,c)}function zn(e,t,n,r,s,o,i){o[0]=0,i[0]=-Ie,i[1]=Ie,s[0]=e[t];for(let a=1,c=0,u=0;a<r;a++){s[a]=e[t+a*n];const f=a*a;do{const l=o[c];u=(s[a]-s[l]+f-l*l)/(a-l)/2}while(u<=i[c]&&--c>-1);c++,o[c]=a,i[c]=u,i[c+1]=Ie}for(let a=0,c=0;a<r;a++){for(;i[c+1]<a;)c++;const u=o[c],f=a-u;e[t+a*n]=s[u]+f*f}}const Zt=5e4,ut=16,Xc=9,Un=.5;let Hr=null,Qr="normal";function Yc(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++){const r=e[n]/255,s=(Un-r)/Un,o=Math.min(1,Math.abs(s));let i=Math.pow(1-o,Xc)/2;s<0&&(i=1-i),t[n]=Math.round(Math.max(0,Math.min(255,i*255)))}return t}async function vu(e,t=400){const n=`${t} 128px "${e}"`;await document.fonts.load(n),Hr=e,Qr=t>=600?"bold":"normal"}const un={data:new Float32Array(S*12)};function Ne(e){const t=un.data;function n(s){return t[s*12+e]}function r(s,o){t[s*12+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}function Wc(){const e=un.data;function t(r){const s=r*12+8,o=Math.round(e[s]*255),i=Math.round(e[s+1]*255),a=Math.round(e[s+2]*255);return o<<16|i<<8|a}function n(r,s){const o=r*12+8;e[o]=(s>>16&255)/255,e[o+1]=(s>>8&255)/255,e[o+2]=(s&255)/255,e[o+3]=1}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}function At(e){const t=un.data;function n(s){return t[s*12+8+e]}function r(s,o){t[s*12+8+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const Ke=new Map;function jc(){return new Proxy({},{get(e,t){const n=Number(t);if(!Number.isNaN(n))return Ke.get(n)},set(e,t,n){const r=Number(t);return Number.isNaN(r)?!1:(n==null?Ke.delete(r):Ke.set(r,n),!0)}})}const I={content:jc(),fontSize:Ne(0),opacity:Ne(1),visible:Ne(2),anchorX:Ne(3),anchorY:Ne(4),color:Wc(),colorR:At(0),colorG:At(1),colorB:At(2)};let Dt=[];function Zc(e){if(e._value){const t={};for(const n of e._value.split(";")){const r=n.indexOf(":");if(r===-1)continue;const s=n.slice(0,r).trim(),o=n.slice(r+1).trim();s&&o&&(t[s]=o)}return t}return e}function Dc(e,t){for(const n of Dt)I.content[n.eid]=n.content;Dt=[]}F(I,{defaults:()=>({fontSize:1,opacity:1,visible:1,anchorX:0,anchorY:0,color:16777215}),adapter:(e,t)=>{const n=Zc(e),r={};if(n.content&&Dt.push({eid:t,content:n.content}),n["font-size"]&&(r.fontSize=parseFloat(n["font-size"])),n.fontSize&&(r.fontSize=parseFloat(n.fontSize)),n.opacity&&(r.opacity=parseFloat(n.opacity)),n.visible&&(r.visible=parseFloat(n.visible)),n["anchor-x"]&&(r.anchorX=parseFloat(n["anchor-x"])),n.anchorX&&(r.anchorX=parseFloat(n.anchorX)),n["anchor-y"]&&(r.anchorY=parseFloat(n["anchor-y"])),n.anchorY&&(r.anchorY=parseFloat(n.anchorY)),n.color){const s=n.color;s.startsWith("0x")||s.startsWith("0X")?r.color=parseInt(s,16):s.startsWith("#")?r.color=parseInt(s.slice(1),16):r.color=parseInt(s,10)}return r},accessors:{fontSize:I.fontSize,opacity:I.opacity,visible:I.visible,anchorX:I.anchorX,anchorY:I.anchorY,color:I.color,colorR:I.colorR,colorG:I.colorG,colorB:I.colorB}});function Hc(e){const s=e.createTexture({size:{width:2048,height:2048},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,label:"glyphAtlas"}),o=new Gc({fontSize:128,fontFamily:Hr??"system-ui, sans-serif",fontWeight:Qr,fontStyle:"normal",buffer:16,radius:48,cutoff:.5});return{texture:s,textureView:s.createView(),width:2048,height:2048,glyphs:new Map,rowHeight:0,cursorX:0,cursorY:0,sdf:o,sdfFontSize:128}}function Qc(e,t,n){const r=t.glyphs.get(n);if(r)return r;const s=t.sdf.draw(n);if(t.cursorX+s.width>t.width&&(t.cursorX=0,t.cursorY+=t.rowHeight,t.rowHeight=0),t.cursorY+s.height>t.height)throw new Error("Glyph atlas full");const o=Yc(new Uint8Array(s.data));e.queue.writeTexture({texture:t.texture,origin:{x:t.cursorX,y:t.cursorY}},o,{bytesPerRow:s.width},{width:s.width,height:s.height});const i={width:s.width,height:s.height,glyphWidth:s.glyphWidth,glyphHeight:s.glyphHeight,glyphTop:s.glyphTop,glyphLeft:s.glyphLeft,advance:s.glyphAdvance,u0:t.cursorX/t.width,v0:t.cursorY/t.height,u1:(t.cursorX+s.width)/t.width,v1:(t.cursorY+s.height)/t.height};return t.glyphs.set(n,i),t.cursorX+=s.width,t.rowHeight=Math.max(t.rowHeight,s.height),i}function Kc(e,t,n){for(const r of n)Qc(e,t,r)}function Jc(e,t,n){const r=[],s=n/t.sdfFontSize;let o=0,i=0;for(const a of e){const c=t.glyphs.get(a);if(!c)continue;const u=c.glyphWidth*s,f=c.glyphHeight*s,l=c.advance*s,p=o+c.glyphLeft*s,d=(c.glyphTop-c.glyphHeight)*s;r.push({x:p,y:d,width:u,height:f,texelWidth:c.width,texelHeight:c.height,u0:c.u0,v0:c.v0,u1:c.u1,v1:c.v1}),o+=l,i=Math.max(i,f)}return{glyphs:r,width:o,height:i}}const eu=`
struct Scene {
    viewProj: mat4x4<f32>,
    cameraWorld: mat4x4<f32>,
    ambientColor: vec4<f32>,
    sunDirection: vec4<f32>,
    sunColor: vec4<f32>,
    cameraMode: f32,
    cameraSize: f32,
    viewport: vec2<f32>,
}

struct GlyphInstance {
    posX: f32,
    posY: f32,
    posZ: f32,
    entityId: u32,
    width: f32,
    height: f32,
    texelWidth: f32,
    texelHeight: f32,
    u0: f32,
    v0: f32,
    u1: f32,
    v1: f32,
    color: vec4<f32>,
}

@group(0) @binding(0) var<uniform> scene: Scene;
@group(0) @binding(1) var<storage, read> glyphs: array<GlyphInstance>;
@group(0) @binding(2) var atlasTexture: texture_2d<f32>;
@group(0) @binding(3) var atlasSampler: sampler;
@group(0) @binding(4) var<storage, read> matrices: array<mat4x4<f32>>;

struct VertexOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv: vec2<f32>,
    @location(1) color: vec4<f32>,
    @location(2) localUV: vec2<f32>,
    @location(3) texelSize: vec2<f32>,
}

@vertex
fn vs(@builtin(vertex_index) vid: u32) -> VertexOutput {
    let glyphIdx = vid / 6u;
    let cornerIdx = vid % 6u;

    let glyph = glyphs[glyphIdx];

    var localPos: vec2<f32>;
    var uv: vec2<f32>;

    switch cornerIdx {
        case 0u: {
            localPos = vec2(0.0, 0.0);
            uv = vec2(glyph.u0, glyph.v1);
        }
        case 1u: {
            localPos = vec2(1.0, 0.0);
            uv = vec2(glyph.u1, glyph.v1);
        }
        case 2u: {
            localPos = vec2(1.0, 1.0);
            uv = vec2(glyph.u1, glyph.v0);
        }
        case 3u: {
            localPos = vec2(0.0, 0.0);
            uv = vec2(glyph.u0, glyph.v1);
        }
        case 4u: {
            localPos = vec2(1.0, 1.0);
            uv = vec2(glyph.u1, glyph.v0);
        }
        case 5u: {
            localPos = vec2(0.0, 1.0);
            uv = vec2(glyph.u0, glyph.v0);
        }
        default: {
            localPos = vec2(0.0);
            uv = vec2(0.0);
        }
    }

    let localPos3 = vec3(
        glyph.posX + localPos.x * glyph.width,
        glyph.posY + localPos.y * glyph.height,
        glyph.posZ
    );

    let transform = matrices[glyph.entityId];
    let worldPos = transform * vec4(localPos3, 1.0);

    var out: VertexOutput;
    out.position = scene.viewProj * worldPos;
    out.uv = uv;
    out.color = glyph.color;
    out.localUV = localPos;
    out.texelSize = vec2(glyph.texelWidth, glyph.texelHeight);
    return out;
}

struct FragmentOutput {
    @location(0) color: vec4<f32>,
    @location(1) mask: f32,
}

@fragment
fn fs(input: VertexOutput) -> FragmentOutput {
    let sdfValue = textureSample(atlasTexture, atlasSampler, input.uv).r;

    // Decode exponential SDF (inverse of Troika-style encoding)
    let sdfExponent = 9.0;
    let isOutside = sdfValue < 0.5;
    let processedAlpha = select(1.0 - sdfValue, sdfValue, isOutside);
    let normalizedDist = 1.0 - pow(2.0 * processedAlpha, 1.0 / sdfExponent);
    let signedDist = select(-normalizedDist, normalizedDist, isOutside);

    // Troika-style AA using screen-space derivatives
    let texelFootprint = fwidth(input.localUV * input.texelSize);
    let aaRadius = length(texelFootprint) * 0.5;
    let smoothing = clamp(aaRadius * 0.5, 0.01, 0.25);

    // Edge at signedDist = 0, positive offset = thicker text
    let edgeOffset = 0.02;
    let alpha = smoothstep(edgeOffset + smoothing, edgeOffset - smoothing, signedDist);

    if alpha < 0.01 {
        discard;
    }

    var out: FragmentOutput;
    out.color = vec4(input.color.rgb, input.color.a * alpha);
    out.mask = select(0.0, 1.0, alpha > 0.01);
    return out;
}
`;function tu(e,t,n){const r=e.createShaderModule({code:eu});return e.createRenderPipeline({layout:"auto",vertex:{module:r,entryPoint:"vs"},fragment:{module:r,entryPoint:"fs",targets:[{format:t,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}},{format:n,writeMask:GPUColorWrite.RED}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:be,depthCompare:"less",depthWriteEnabled:!1}})}function nu(e){let t=null,n=null;return{id:"text",order:2,draw(r,s){const o=e.getCount();o!==0&&(t||(t=tu(s.device,s.format,s.maskFormat)),n||(n=s.device.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.scene}},{binding:1,resource:{buffer:e.glyphs}},{binding:2,resource:e.atlas},{binding:3,resource:e.sampler},{binding:4,resource:{buffer:e.matrices}}]})),r.setPipeline(t),r.setBindGroup(0,n),r.draw(o*6))}}}const Kr=re("text"),ru={group:"draw",update(e){const t=Z.from(e),n=Kr.from(e);if(!t||!n)return;const{device:r}=t,{atlas:s,staging:o}=n,i=new Uint32Array(o.buffer);let a=0;for(const c of e.query([I,b])){if(!I.visible[c])continue;const u=Ke.get(c);if(!u)continue;Kc(r,s,u);const f=I.fontSize[c],l=Jc(u,s,f),p=I.anchorX[c],d=I.anchorY[c],h=-l.width*p,g=-l.height*d,m=I.color[c],E=(m>>16&255)/255,N=(m>>8&255)/255,C=(m&255)/255,y=I.opacity[c];for(const w of l.glyphs){if(a>=Zt)break;const v=a*ut;o[v+0]=h+w.x,o[v+1]=g+w.y,o[v+2]=0,i[v+3]=c,o[v+4]=w.width,o[v+5]=w.height,o[v+6]=w.texelWidth,o[v+7]=w.texelHeight,o[v+8]=w.u0,o[v+9]=w.v0,o[v+10]=w.u1,o[v+11]=w.v1,o[v+12]=E,o[v+13]=N,o[v+14]=C,o[v+15]=y,a++}}n.count=a,a>0&&r.queue.writeBuffer(n.buffer,0,o.buffer,0,a*ut*4)}},xu={systems:[ru],components:{Text:I},dependencies:[ze,mt],initialize(e){sn(Dc);const t=Z.from(e),n=Le.from(e);if(!t||!n)return;const{device:r}=t,s=Hc(r),o=r.createSampler({magFilter:"linear",minFilter:"linear"}),i={atlas:s,sampler:o,buffer:r.createBuffer({label:"glyphs",size:Zt*ut*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),staging:new Float32Array(Zt*ut),count:0};e.setResource(Kr,i),cn(e,nu({scene:n.scene,glyphs:i.buffer,atlas:s.textureView,sampler:o,matrices:n.matrices,getCount:()=>i.count}))}};var je=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0}),su=Symbol.for("bitecs-relation"),ou=Symbol.for("bitecs-pairTarget"),iu=Symbol.for("bitecs-isPairComponent"),au=Symbol.for("bitecs-relationData"),Jr=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?du:n;if(!e.pairsMap.has(r)){let s={};je(s,su,t),je(s,ou,r),je(s,iu,!0),e.pairsMap.set(r,s)}return e.pairsMap.get(r)};return je(t,au,e),t},cu=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},uu=Symbol.for("bitecs-wildcard");function lu(){let e=Jr();return Object.defineProperty(e,uu,{value:!0,enumerable:!1,writable:!1,configurable:!1}),e}function fu(){let e=Symbol.for("bitecs-global-wildcard");return globalThis[e]||(globalThis[e]=lu()),globalThis[e]}var du=fu();function pu(){return Jr()}function hu(){let e=Symbol.for("bitecs-global-isa");return globalThis[e]||(globalThis[e]=pu()),globalThis[e]}hu();const pe={step:[],target:[],max:[]};F(pe,{defaults:()=>({step:0,target:0,max:0})});const Oe={from:[],to:[]};F(Oe,{defaults:()=>({from:0,to:0})});const es={index:[],group:[]};F(es,{defaults:()=>({index:0,group:0})});function gu(){let e=!1;return{group:"simulation",update(t){if(!e)for(const n of t.query([pe])){const r=pe.step[n],s=pe.target[n];if(r!==s){e=!0;for(const o of t.query([O]))O.state[o]===H.PLAYING&&(O.state[o]=H.COMPLETE);t.step(0);for(const o of t.query([O])){O.state[o]=H.IDLE,O.elapsed[o]=0;for(const i of t.query([cu(Y.relation,o),x]))x.state[i]=j.IDLE,x.elapsed[i]=0}for(const o of t.query([O,Oe]))if(Oe.from[o]===r&&Oe.to[o]===s){O.state[o]=H.PLAYING;break}pe.step[n]=s,e=!1}}}}}function Eu(){return{components:{StepController:pe,StepTransition:Oe,TokenIndex:es},systems:[gu()]}}function Nu(e){const t=e.getBoundingClientRect();e.width=t.width*window.devicePixelRatio,e.height=t.height*window.devicePixelRatio}function Su(e,t){let n=!1,r=performance.now();function s(o){if(!n)return;const i=(o-r)/1e3;r=o,e.step(i),requestAnimationFrame(s)}new IntersectionObserver(([o])=>{o.isIntersecting?n||(n=!0,r=performance.now(),requestAnimationFrame(s)):n=!1}).observe(document.documentElement)}function Tu(e){e.addEventListener("wheel",t=>{window.parent.postMessage({type:"iframe-scroll",deltaY:t.deltaY},"*")},{passive:!0})}export{bu as A,Z as B,Y as C,Le as D,on as E,cn as F,be as G,K as H,Sr as I,qc as L,X as M,wu as O,mt as R,Re as S,Ba as T,Tu as a,vu as b,xu as c,mu as d,Eu as e,es as f,I as g,pe as h,Su as i,V as j,H as k,O as l,yu as m,cu as n,x as o,j as p,Oe as q,F as r,Nu as s,b as t,R as u,fr as v,Lr as w,re as x,S as y,ze as z};
//# sourceMappingURL=canvas-setup-F5JALq5m.js.map
