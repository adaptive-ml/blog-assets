{"version":3,"file":"overview-BOgnWyqf.js","sources":["../../../demos/overview.ts"],"sourcesContent":["import {\r\n  State,\r\n  TransformsPlugin,\r\n  RenderPlugin,\r\n  TweenPlugin,\r\n  minimalLight,\r\n} from '@multiplekex/shallot';\r\nimport { OrbitPlugin, LinesPlugin, ArrowsPlugin, TextPlugin, setTextFont } from '@multiplekex/shallot/extras';\r\nimport {\r\n  createStepPlugin,\r\n  setupStepUI,\r\n  findStepElements,\r\n  StepController,\r\n  setupCanvas,\r\n  setupScrollPassthrough,\r\n  createVisibilityLoop,\r\n  TokenIndex,\r\n  type StepContent,\r\n} from '@blog-components/sequence';\r\nimport { Text } from '@multiplekex/shallot/extras';\r\nimport { setupCanvasRecording } from '@blog-components/recording';\r\nimport { SpecdecPlugin, BorderPlugin } from '../src';\r\n\r\nconst GROUP_INPUT = 0;\r\nconst GROUP_OUTPUT = 1;\r\nconst GROUP_DRAFT_INPUT = 2;\r\nconst GROUP_DRAFT_OUTPUT = 3;\r\nconst GROUP_DRAFT_MARK = 4;\r\n\r\nconst STEP_CONTENT: StepContent[] = [\r\n  { title: 'Input', description: 'We have a sequence of <span class=\"term-input\">input tokens</span>. We want to predict the next six.' },\r\n  { title: 'Target Model', description: 'We feed them to a large language model — the <span class=\"term-target-model\">target model</span>.' },\r\n  { title: 'First Prediction', description: 'The <span class=\"term-target-model\">target model</span> predicts the next token: <span class=\"term-output\">\"bees\"</span>.' },\r\n  { title: 'Sequential Generation', description: 'We repeat this process, generating one token per pass. This is slow.' },\r\n  { title: 'Draft Model', description: 'Now suppose we have a smaller, faster model — the <span class=\"term-draft-model\">draft model</span>.' },\r\n  { title: 'Draft Output', description: 'The <span class=\"term-draft-model\">draft model</span> generates tokens quickly, but with lower quality.' },\r\n  { title: 'Validation', description: 'Now, what if we could use our <span class=\"term-target-model\">target model</span> to accept or reject these tokens?' },\r\n  { title: 'Speculative Decoding', description: 'That\\'s <b>speculative decoding</b>. Draft quickly, then validate all at once.' },\r\n];\r\n\r\nasync function init(): Promise<void> {\r\n  const canvas = document.getElementById('canvas') as HTMLCanvasElement;\r\n  if (!canvas) return;\r\n\r\n  setupCanvas(canvas);\r\n  setupScrollPassthrough(canvas);\r\n  window.addEventListener('resize', () => setupCanvas(canvas));\r\n\r\n  await setTextFont('ABC Diatype', 400);\r\n\r\n  const state = await State.new()\r\n    .withCanvas(canvas)\r\n    .withLoading(minimalLight(canvas))\r\n    .withPlugins(\r\n      TransformsPlugin,\r\n      RenderPlugin,\r\n      OrbitPlugin,\r\n      LinesPlugin,\r\n      ArrowsPlugin,\r\n      TextPlugin,\r\n      TweenPlugin,\r\n      createStepPlugin(),\r\n      SpecdecPlugin,\r\n      BorderPlugin\r\n    )\r\n    .withScene('../scenes/overview.scene')\r\n    .build();\r\n\r\n  const inputTokens = ['The', 'scientist', 'discovered', 'that'];\r\n  const outputTokens = ['bees', 'communicate', 'with', 'a', 'wiggle', 'dance'];\r\n  const draftOutputTokens = ['bees', 'communicate', 'using', 'a', 'buzz', 'sound'];\r\n  const validationMarks = ['✓', '✓', '✓', '✓', '✗', '✗'];\r\n\r\n  for (const eid of state.query([TokenIndex, Text])) {\r\n    const idx = TokenIndex.index[eid];\r\n    const group = TokenIndex.group[eid];\r\n\r\n    if (group === GROUP_INPUT && idx < inputTokens.length) {\r\n      Text.content[eid] = inputTokens[idx];\r\n    } else if (group === GROUP_OUTPUT && idx < outputTokens.length) {\r\n      Text.content[eid] = outputTokens[idx];\r\n    } else if (group === GROUP_DRAFT_INPUT && idx < inputTokens.length) {\r\n      Text.content[eid] = inputTokens[idx];\r\n    } else if (group === GROUP_DRAFT_OUTPUT && idx < draftOutputTokens.length) {\r\n      Text.content[eid] = draftOutputTokens[idx];\r\n    } else if (group === GROUP_DRAFT_MARK && idx < validationMarks.length) {\r\n      Text.content[eid] = validationMarks[idx];\r\n    }\r\n  }\r\n\r\n  canvas.__state__ = state;\r\n  setupCanvasRecording(canvas, state);\r\n\r\n  const controllers = [...state.query([StepController])];\r\n  const controllerEid = controllers[0];\r\n  canvas.__controllerEid__ = controllerEid;\r\n\r\n  if (controllerEid !== undefined) {\r\n    canvas.__getStep__ = () => StepController.target[controllerEid];\r\n    canvas.__setStep__ = (step: number) => {\r\n      StepController.target[controllerEid] = step;\r\n    };\r\n    canvas.__maxStep__ = STEP_CONTENT.length - 1;\r\n\r\n    const elements = findStepElements(document.body);\r\n    setupStepUI(elements, {\r\n      steps: STEP_CONTENT,\r\n      onStepChange(step) {\r\n        StepController.target[controllerEid] = step;\r\n      },\r\n    });\r\n  }\r\n\r\n  createVisibilityLoop(state);\r\n\r\n  const reportHeight = () => {\r\n    window.parent.postMessage({ type: 'iframe-resize', height: document.body.scrollHeight }, '*');\r\n  };\r\n  reportHeight();\r\n  window.addEventListener('resize', reportHeight);\r\n}\r\n\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', init);\r\n} else {\r\n  init();\r\n}\r\n"],"names":["GROUP_INPUT","GROUP_OUTPUT","GROUP_DRAFT_INPUT","GROUP_DRAFT_OUTPUT","GROUP_DRAFT_MARK","STEP_CONTENT","init","canvas","setupCanvas","setupScrollPassthrough","setTextFont","state","State","minimalLight","TransformsPlugin","RenderPlugin","OrbitPlugin","LinesPlugin","ArrowsPlugin","TextPlugin","TweenPlugin","createStepPlugin","SpecdecPlugin","BorderPlugin","inputTokens","outputTokens","draftOutputTokens","validationMarks","eid","TokenIndex","Text","idx","group","setupCanvasRecording","controllerEid","StepController","step","elements","findStepElements","setupStepUI","createVisibilityLoop","reportHeight"],"mappings":"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"}