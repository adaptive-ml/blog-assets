{"version":3,"file":"step-by-step-vtKMwtXL.js","sources":["../../../demos/step-by-step.ts"],"sourcesContent":["import {\n  State,\n  TransformsPlugin,\n  RenderPlugin,\n  TweenPlugin,\n  minimalLight,\n  ChildOf,\n  Pair,\n} from '@multiplekex/shallot';\nimport { OrbitPlugin, LinesPlugin, ArrowsPlugin, TextPlugin } from '@multiplekex/shallot/extras';\nimport { Text } from '@multiplekex/shallot/extras';\nimport {\n  createStepPlugin,\n  setupCanvas,\n  setupScrollPassthrough,\n  setupDemo,\n  TokenIndex,\n} from '@blog-components/sequence';\nimport { SpecdecPlugin, BorderPlugin, ProbabilityDistributionPlugin, ProbabilityDistribution, BarHighlight, setDistributionProbabilities, GradientLegendPlugin, TokenReplacement, setTokenReplacementTexts } from '../src';\n\nconst GROUP_INPUT = 0;\nconst GROUP_OUTPUT = 1;\nconst GROUP_MARK = 2;\n\nconst STEPS = [\n  { title: 'Draft Model', description: 'The <span class=\"term-draft-model\">draft model</span> generates output tokens.' },\n  { title: 'Target Model', description: 'The <span class=\"term-target-model\">target model</span> processes all outputs in a single forward pass.' },\n  { title: 'Target Distribution', description: 'The <span class=\"term-target-model\">target model</span> produces a probability distribution, <span class=\"term-target-model\">p<sub>target</sub></span>, at each position.' },\n  { title: 'Draft Distribution', description: 'Each token was sampled from <span class=\"term-draft-model\">p<sub>draft</sub></span>. We compare this to <span class=\"term-target-model\">p<sub>target</sub></span>.' },\n  { title: 'Acceptance', description: 'We use <code>min(1, <span class=\"term-target-model\">p<sub>target</sub></span> / <span class=\"term-draft-model\">p<sub>draft</sub></span>)</code> to decide whether to accept each token.' },\n  { title: 'Bees', description: 'We accept \"bees\". <span class=\"term-target-model\">p<sub>target</sub></span> &gt; <span class=\"term-draft-model\">p<sub>draft</sub></span>, so the formula gives <span class=\"term-accept\">1</span>, or <span class=\"term-accept\">100%</span> chance to accept.' },\n  { title: 'Communicate', description: '\"communicate\" also has <span class=\"term-target-model\">p<sub>target</sub></span> &gt; <span class=\"term-draft-model\">p<sub>draft</sub></span>, so we accept.' },\n  { title: 'Using', description: 'For \"using\", <span class=\"term-target-model\">p<sub>target</sub></span> &lt; <span class=\"term-draft-model\">p<sub>draft</sub></span>. The formula gives <span class=\"term-accept\">0.8</span>, or <span class=\"term-accept\">80%</span> chance. We accept.' },\n  { title: 'A', description: '\"a\" has <span class=\"term-target-model\">p<sub>target</sub></span> slightly below <span class=\"term-draft-model\">p<sub>draft</sub></span>. <span class=\"term-accept\">90%</span> chance. We accept.' },\n  { title: 'Buzz', description: 'For \"buzz\", <span class=\"term-target-model\">p<sub>target</sub></span> is much lower than <span class=\"term-draft-model\">p<sub>draft</sub></span>. The formula gives <span class=\"term-reject\">0.2</span>, or <span class=\"term-reject\">20%</span> chance. This time, we reject.' },\n  { title: 'Residual', description: 'After rejection, we resample from <span class=\"term-residual\">p<sub>residual</sub></span> = <code>max(0, <span class=\"term-target-model\">p<sub>target</sub></span> - <span class=\"term-draft-model\">p<sub>draft</sub></span>)</code>.' },\n  { title: 'Resampling', description: 'Finally, we replace \"buzz\" with the resampled token: \"wiggle\".' },\n  { title: 'Repeat', description: 'We repeat the same process, continuing generation from \"wiggle\".' },\n];\n\nasync function init(): Promise<void> {\n  const canvas = document.getElementById('canvas') as HTMLCanvasElement;\n  if (!canvas) return;\n\n  setupCanvas(canvas);\n  setupScrollPassthrough(canvas);\n  window.addEventListener('resize', () => setupCanvas(canvas));\n\n  const state = await State.new()\n    .withCanvas(canvas)\n    .withLoading(minimalLight(canvas))\n    .withPlugins(\n      TransformsPlugin,\n      RenderPlugin,\n      OrbitPlugin,\n      LinesPlugin,\n      ArrowsPlugin,\n      TextPlugin,\n      TweenPlugin,\n      createStepPlugin(),\n      SpecdecPlugin,\n      BorderPlugin,\n      ProbabilityDistributionPlugin,\n      GradientLegendPlugin\n    )\n    .withScene('../scenes/step-by-step.scene')\n    .build();\n\n  const inputTokens = ['The', 'scientist', 'discovered', 'that'];\n  const outputTokens = ['bees', 'communicate', 'using', 'a', 'buzz', 'sound'];\n\n  for (const eid of state.query([TokenIndex, Text])) {\n    const idx = TokenIndex.index[eid];\n    const group = TokenIndex.group[eid];\n\n    if (group === GROUP_INPUT && idx < inputTokens.length) {\n      Text.content[eid] = inputTokens[idx];\n    } else if (group === GROUP_OUTPUT && idx < outputTokens.length) {\n      Text.content[eid] = outputTokens[idx];\n    }\n  }\n\n  const BAR_COUNT = 15;\n\n  const tokenData = [\n    {\n      label: 'bees',\n      barIndex: 6,\n      yOffset: 1.2,\n      targetProbs: [0.08, 0.15, 0.04, 0.22, 0.06, 0.12, 0.75, 0.18, 0.03, 0.09, 0.25, 0.05, 0.11, 0.07, 0.02],\n      draftProbs:  [0.12, 0.08, 0.06, 0.18, 0.10, 0.15, 0.55, 0.25, 0.05, 0.14, 0.20, 0.08, 0.09, 0.04, 0.03],\n    },\n    {\n      label: 'communicate',\n      barIndex: 9,\n      yOffset: 2.3,\n      targetProbs: [0.05, 0.12, 0.08, 0.15, 0.04, 0.18, 0.06, 0.10, 0.03, 0.70, 0.22, 0.07, 0.14, 0.09, 0.02],\n      draftProbs:  [0.08, 0.10, 0.06, 0.12, 0.05, 0.15, 0.09, 0.14, 0.04, 0.50, 0.18, 0.06, 0.11, 0.07, 0.03],\n    },\n    {\n      label: 'using',\n      barIndex: 7,\n      yOffset: 1.0,\n      targetProbs: [0.12, 0.18, 0.10, 0.15, 0.08, 0.20, 0.14, 0.48, 0.11, 0.16, 0.09, 0.13, 0.07, 0.10, 0.05],\n      draftProbs:  [0.10, 0.15, 0.12, 0.18, 0.09, 0.17, 0.11, 0.60, 0.13, 0.14, 0.08, 0.12, 0.09, 0.11, 0.06],\n    },\n    {\n      label: 'a',\n      barIndex: 5,\n      yOffset: 1.1,\n      targetProbs: [0.08, 0.12, 0.15, 0.10, 0.18, 0.54, 0.14, 0.09, 0.20, 0.11, 0.07, 0.16, 0.06, 0.13, 0.04],\n      draftProbs:  [0.10, 0.14, 0.12, 0.08, 0.16, 0.60, 0.11, 0.07, 0.18, 0.13, 0.09, 0.15, 0.05, 0.10, 0.06],\n    },\n    {\n      label: 'buzz',\n      barIndex: 11,\n      yOffset: 1.3,\n      targetProbs: [0.15, 0.08, 0.12, 0.65, 0.06, 0.18, 0.14, 0.20, 0.09, 0.16, 0.07, 0.10, 0.11, 0.08, 0.05],\n      draftProbs:  [0.08, 0.12, 0.10, 0.08, 0.09, 0.14, 0.11, 0.18, 0.13, 0.16, 0.07, 0.50, 0.10, 0.08, 0.06],\n      wiggleBarIndex: 3,\n      wiggleYOffset: 4.5,\n    },\n  ];\n\n  const probBarsEids = [...state.query([ProbabilityDistribution])];\n  const probBarsEid = probBarsEids[0];\n\n  const highlightEids = [...state.query([BarHighlight])];\n  const highlight0Eid = highlightEids[0];\n  const highlight1Eid = highlightEids[1];\n\n  let highlight0LabelEid: number | undefined;\n  let highlight1LabelEid: number | undefined;\n\n  if (highlight0Eid !== undefined) {\n    for (const childEid of state.query([Pair(ChildOf.relation, highlight0Eid), Text])) {\n      highlight0LabelEid = childEid;\n      break;\n    }\n  }\n  if (highlight1Eid !== undefined) {\n    for (const childEid of state.query([Pair(ChildOf.relation, highlight1Eid), Text])) {\n      highlight1LabelEid = childEid;\n      break;\n    }\n  }\n\n  if (highlight0LabelEid !== undefined) {\n    Text.content[highlight0LabelEid] = tokenData[0].label;\n  }\n  if (highlight1LabelEid !== undefined) {\n    Text.content[highlight1LabelEid] = 'wiggle';\n  }\n\n  if (probBarsEid !== undefined) {\n    ProbabilityDistribution.barCount[probBarsEid] = BAR_COUNT;\n    setDistributionProbabilities(probBarsEid, tokenData[0].targetProbs, tokenData[0].draftProbs);\n  }\n\n  let output4Eid: number | undefined;\n  let mark4Eid: number | undefined;\n\n  for (const eid of state.query([TokenIndex, Text])) {\n    const idx = TokenIndex.index[eid];\n    const group = TokenIndex.group[eid];\n\n    if (group === GROUP_OUTPUT && idx === 4) {\n      output4Eid = eid;\n      state.addComponent(eid, TokenReplacement);\n      setTokenReplacementTexts(eid, 'buzz', 'wiggle');\n    } else if (group === GROUP_MARK && idx === 4) {\n      mark4Eid = eid;\n      state.addComponent(eid, TokenReplacement);\n      setTokenReplacementTexts(eid, '✗', '✓');\n    }\n  }\n\n  const updateGraphForStep = (step: number) => {\n    if (probBarsEid === undefined) return;\n\n    const tokenIndex = Math.max(0, step - 5);\n    if (tokenIndex < tokenData.length) {\n      const data = tokenData[tokenIndex];\n      setDistributionProbabilities(probBarsEid, data.targetProbs, data.draftProbs);\n\n      if (highlight0Eid !== undefined) {\n        BarHighlight.barIndex[highlight0Eid] = data.barIndex;\n        BarHighlight.yOffset[highlight0Eid] = data.yOffset;\n      }\n      if (highlight0LabelEid !== undefined) {\n        Text.content[highlight0LabelEid] = data.label;\n      }\n    }\n  };\n\n  setupDemo(canvas, state, STEPS, updateGraphForStep);\n}\n\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', init);\n} else {\n  init();\n}\n"],"names":["GROUP_INPUT","GROUP_OUTPUT","GROUP_MARK","STEPS","init","canvas","setupCanvas","setupScrollPassthrough","state","State","minimalLight","TransformsPlugin","RenderPlugin","OrbitPlugin","LinesPlugin","ArrowsPlugin","TextPlugin","TweenPlugin","createStepPlugin","SpecdecPlugin","BorderPlugin","ProbabilityDistributionPlugin","GradientLegendPlugin","inputTokens","outputTokens","eid","TokenIndex","Text","idx","group","BAR_COUNT","tokenData","probBarsEid","ProbabilityDistribution","highlightEids","BarHighlight","highlight0Eid","highlight1Eid","highlight0LabelEid","highlight1LabelEid","childEid","Pair","ChildOf","setDistributionProbabilities","TokenReplacement","setTokenReplacementTexts","setupDemo","step","tokenIndex","data"],"mappings":"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"}