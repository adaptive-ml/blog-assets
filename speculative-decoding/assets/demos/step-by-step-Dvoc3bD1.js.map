{"version":3,"file":"step-by-step-Dvoc3bD1.js","sources":["../../../demos/step-by-step.ts"],"sourcesContent":["import {\r\n  State,\r\n  TransformsPlugin,\r\n  RenderPlugin,\r\n  TweenPlugin,\r\n  minimalLight,\r\n  ChildOf,\r\n  Pair,\r\n} from '@multiplekex/shallot';\r\nimport { OrbitPlugin, LinesPlugin, ArrowsPlugin, TextPlugin, setTextFont } from '@multiplekex/shallot/extras';\r\nimport { Text } from '@multiplekex/shallot/extras';\r\nimport {\r\n  createStepPlugin,\r\n  setupStepUI,\r\n  findStepElements,\r\n  StepController,\r\n  setupCanvas,\r\n  setupScrollPassthrough,\r\n  createVisibilityLoop,\r\n  TokenIndex,\r\n  type StepContent,\r\n} from '@blog-components/sequence';\r\nimport { setupCanvasRecording } from '@blog-components/recording';\r\nimport { SpecdecPlugin, BorderPlugin, ProbabilityDistributionPlugin, ProbabilityDistribution, BarHighlight, setDistributionProbabilities, GradientLegendPlugin, TokenReplacement, setTokenReplacementTexts } from '../src';\r\n\r\nconst GROUP_INPUT = 0;\r\nconst GROUP_OUTPUT = 1;\r\nconst GROUP_MARK = 2;\r\n\r\nconst STEP_CONTENT: StepContent[] = [\r\n  { title: 'Draft Model', description: 'The <span class=\"term-draft-model\">draft model</span> generates output tokens.' },\r\n  { title: 'Target Model', description: 'The <span class=\"term-target-model\">target model</span> processes all outputs in a single forward pass.' },\r\n  { title: 'Target Distribution', description: 'The <span class=\"term-target-model\">target model</span> produces a probability distribution, <span class=\"term-target-model\">p<sub>target</sub></span>, at each position.' },\r\n  { title: 'Draft Distribution', description: 'Each token was sampled from <span class=\"term-draft-model\">p<sub>draft</sub></span>. We compare this to <span class=\"term-target-model\">p<sub>target</sub></span>.' },\r\n  { title: 'Acceptance', description: 'We use <code>min(1, <span class=\"term-target-model\">p<sub>target</sub></span> / <span class=\"term-draft-model\">p<sub>draft</sub></span>)</code> to decide whether to accept each token.' },\r\n  { title: 'Bees', description: 'We accept \"bees\". <span class=\"term-target-model\">p<sub>target</sub></span> &gt; <span class=\"term-draft-model\">p<sub>draft</sub></span>, so the formula gives <span class=\"term-accept\">1</span>, or <span class=\"term-accept\">100%</span> chance to accept.' },\r\n  { title: 'Communicate', description: '\"communicate\" also has <span class=\"term-target-model\">p<sub>target</sub></span> &gt; <span class=\"term-draft-model\">p<sub>draft</sub></span>, so we accept.' },\r\n  { title: 'Using', description: 'For \"using\", <span class=\"term-target-model\">p<sub>target</sub></span> &lt; <span class=\"term-draft-model\">p<sub>draft</sub></span>. The formula gives <span class=\"term-accept\">0.8</span>, or <span class=\"term-accept\">80%</span> chance. We accept.' },\r\n  { title: 'A', description: '\"a\" has <span class=\"term-target-model\">p<sub>target</sub></span> slightly below <span class=\"term-draft-model\">p<sub>draft</sub></span>. <span class=\"term-accept\">90%</span> chance. We accept.' },\r\n  { title: 'Buzz', description: 'For \"buzz\", <span class=\"term-target-model\">p<sub>target</sub></span> is much lower than <span class=\"term-draft-model\">p<sub>draft</sub></span>. The formula gives <span class=\"term-reject\">0.2</span>, or <span class=\"term-reject\">20%</span> chance. This time, we reject.' },\r\n  { title: 'Residual', description: 'After rejection, we resample from <span class=\"term-residual\">p<sub>residual</sub></span> = <code>max(0, <span class=\"term-target-model\">p<sub>target</sub></span> - <span class=\"term-draft-model\">p<sub>draft</sub></span>)</code>.' },\r\n  { title: 'Resampling', description: 'Finally, we replace \"buzz\" with the resampled token: \"wiggle\".' },\r\n  { title: 'Repeat', description: 'We repeat the same process, continuing generation from \"wiggle\".' },\r\n];\r\n\r\nasync function init(): Promise<void> {\r\n  const canvas = document.getElementById('canvas') as HTMLCanvasElement;\r\n  if (!canvas) return;\r\n\r\n  setupCanvas(canvas);\r\n  setupScrollPassthrough(canvas);\r\n  window.addEventListener('resize', () => setupCanvas(canvas));\r\n\r\n  await setTextFont('ABC Diatype', 400);\r\n\r\n  const state = await State.new()\r\n    .withCanvas(canvas)\r\n    .withLoading(minimalLight(canvas))\r\n    .withPlugins(\r\n      TransformsPlugin,\r\n      RenderPlugin,\r\n      OrbitPlugin,\r\n      LinesPlugin,\r\n      ArrowsPlugin,\r\n      TextPlugin,\r\n      TweenPlugin,\r\n      createStepPlugin(),\r\n      SpecdecPlugin,\r\n      BorderPlugin,\r\n      ProbabilityDistributionPlugin,\r\n      GradientLegendPlugin\r\n    )\r\n    .withScene('../scenes/step-by-step.scene')\r\n    .build();\r\n\r\n  const inputTokens = ['The', 'scientist', 'discovered', 'that'];\r\n  const outputTokens = ['bees', 'communicate', 'using', 'a', 'buzz', 'sound'];\r\n\r\n  for (const eid of state.query([TokenIndex, Text])) {\r\n    const idx = TokenIndex.index[eid];\r\n    const group = TokenIndex.group[eid];\r\n\r\n    if (group === GROUP_INPUT && idx < inputTokens.length) {\r\n      Text.content[eid] = inputTokens[idx];\r\n    } else if (group === GROUP_OUTPUT && idx < outputTokens.length) {\r\n      Text.content[eid] = outputTokens[idx];\r\n    }\r\n  }\r\n\r\n  const BAR_COUNT = 15;\r\n\r\n  const tokenData = [\r\n    {\r\n      label: 'bees',\r\n      barIndex: 6,\r\n      yOffset: 1.2,\r\n      targetProbs: [0.08, 0.15, 0.04, 0.22, 0.06, 0.12, 0.75, 0.18, 0.03, 0.09, 0.25, 0.05, 0.11, 0.07, 0.02],\r\n      draftProbs:  [0.12, 0.08, 0.06, 0.18, 0.10, 0.15, 0.55, 0.25, 0.05, 0.14, 0.20, 0.08, 0.09, 0.04, 0.03],\r\n    },\r\n    {\r\n      label: 'communicate',\r\n      barIndex: 9,\r\n      yOffset: 2.3,\r\n      targetProbs: [0.05, 0.12, 0.08, 0.15, 0.04, 0.18, 0.06, 0.10, 0.03, 0.70, 0.22, 0.07, 0.14, 0.09, 0.02],\r\n      draftProbs:  [0.08, 0.10, 0.06, 0.12, 0.05, 0.15, 0.09, 0.14, 0.04, 0.50, 0.18, 0.06, 0.11, 0.07, 0.03],\r\n    },\r\n    {\r\n      label: 'using',\r\n      barIndex: 7,\r\n      yOffset: 1.0,\r\n      targetProbs: [0.12, 0.18, 0.10, 0.15, 0.08, 0.20, 0.14, 0.48, 0.11, 0.16, 0.09, 0.13, 0.07, 0.10, 0.05],\r\n      draftProbs:  [0.10, 0.15, 0.12, 0.18, 0.09, 0.17, 0.11, 0.60, 0.13, 0.14, 0.08, 0.12, 0.09, 0.11, 0.06],\r\n    },\r\n    {\r\n      label: 'a',\r\n      barIndex: 5,\r\n      yOffset: 1.1,\r\n      targetProbs: [0.08, 0.12, 0.15, 0.10, 0.18, 0.54, 0.14, 0.09, 0.20, 0.11, 0.07, 0.16, 0.06, 0.13, 0.04],\r\n      draftProbs:  [0.10, 0.14, 0.12, 0.08, 0.16, 0.60, 0.11, 0.07, 0.18, 0.13, 0.09, 0.15, 0.05, 0.10, 0.06],\r\n    },\r\n    {\r\n      label: 'buzz',\r\n      barIndex: 11,\r\n      yOffset: 1.3,\r\n      targetProbs: [0.15, 0.08, 0.12, 0.65, 0.06, 0.18, 0.14, 0.20, 0.09, 0.16, 0.07, 0.10, 0.11, 0.08, 0.05],\r\n      draftProbs:  [0.08, 0.12, 0.10, 0.08, 0.09, 0.14, 0.11, 0.18, 0.13, 0.16, 0.07, 0.50, 0.10, 0.08, 0.06],\r\n      wiggleBarIndex: 3,\r\n      wiggleYOffset: 4.5,\r\n    },\r\n  ];\r\n\r\n  const probBarsEids = [...state.query([ProbabilityDistribution])];\r\n  const probBarsEid = probBarsEids[0];\r\n\r\n  const highlightEids = [...state.query([BarHighlight])];\r\n  const highlight0Eid = highlightEids[0];\r\n  const highlight1Eid = highlightEids[1];\r\n\r\n  let highlight0LabelEid: number | undefined;\r\n  let highlight1LabelEid: number | undefined;\r\n\r\n  if (highlight0Eid !== undefined) {\r\n    for (const childEid of state.query([Pair(ChildOf.relation, highlight0Eid), Text])) {\r\n      highlight0LabelEid = childEid;\r\n      break;\r\n    }\r\n  }\r\n  if (highlight1Eid !== undefined) {\r\n    for (const childEid of state.query([Pair(ChildOf.relation, highlight1Eid), Text])) {\r\n      highlight1LabelEid = childEid;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (highlight0LabelEid !== undefined) {\r\n    Text.content[highlight0LabelEid] = tokenData[0].label;\r\n  }\r\n  if (highlight1LabelEid !== undefined) {\r\n    Text.content[highlight1LabelEid] = 'wiggle';\r\n  }\r\n\r\n  if (probBarsEid !== undefined) {\r\n    ProbabilityDistribution.barCount[probBarsEid] = BAR_COUNT;\r\n    setDistributionProbabilities(probBarsEid, tokenData[0].targetProbs, tokenData[0].draftProbs);\r\n  }\r\n\r\n  let output4Eid: number | undefined;\r\n  let mark4Eid: number | undefined;\r\n\r\n  for (const eid of state.query([TokenIndex, Text])) {\r\n    const idx = TokenIndex.index[eid];\r\n    const group = TokenIndex.group[eid];\r\n\r\n    if (group === GROUP_OUTPUT && idx === 4) {\r\n      output4Eid = eid;\r\n      state.addComponent(eid, TokenReplacement);\r\n      setTokenReplacementTexts(eid, 'buzz', 'wiggle');\r\n    } else if (group === GROUP_MARK && idx === 4) {\r\n      mark4Eid = eid;\r\n      state.addComponent(eid, TokenReplacement);\r\n      setTokenReplacementTexts(eid, '✗', '✓');\r\n    }\r\n  }\r\n\r\n  const updateGraphForStep = (step: number) => {\r\n    if (probBarsEid === undefined) return;\r\n\r\n    const tokenIndex = Math.max(0, step - 5);\r\n    if (tokenIndex < tokenData.length) {\r\n      const data = tokenData[tokenIndex];\r\n      setDistributionProbabilities(probBarsEid, data.targetProbs, data.draftProbs);\r\n\r\n      if (highlight0Eid !== undefined) {\r\n        BarHighlight.barIndex[highlight0Eid] = data.barIndex;\r\n        BarHighlight.yOffset[highlight0Eid] = data.yOffset;\r\n      }\r\n      if (highlight0LabelEid !== undefined) {\r\n        Text.content[highlight0LabelEid] = data.label;\r\n      }\r\n    }\r\n  };\r\n\r\n  canvas.__state__ = state;\r\n  setupCanvasRecording(canvas, state);\r\n\r\n  const controllers = [...state.query([StepController])];\r\n  const controllerEid = controllers[0];\r\n  canvas.__controllerEid__ = controllerEid;\r\n\r\n  if (controllerEid !== undefined) {\r\n    canvas.__getStep__ = () => StepController.target[controllerEid];\r\n    canvas.__setStep__ = (step: number) => {\r\n      StepController.target[controllerEid] = step;\r\n    };\r\n    canvas.__maxStep__ = STEP_CONTENT.length - 1;\r\n\r\n    const elements = findStepElements(document.body);\r\n    setupStepUI(elements, {\r\n      steps: STEP_CONTENT,\r\n      onStepChange(step) {\r\n        StepController.target[controllerEid] = step;\r\n        updateGraphForStep(step);\r\n      },\r\n    });\r\n  }\r\n\r\n  createVisibilityLoop(state);\r\n\r\n  const reportHeight = () => {\r\n    window.parent.postMessage({ type: 'iframe-resize', height: document.body.scrollHeight }, '*');\r\n  };\r\n  reportHeight();\r\n  window.addEventListener('resize', reportHeight);\r\n}\r\n\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', init);\r\n} else {\r\n  init();\r\n}\r\n"],"names":["GROUP_INPUT","GROUP_OUTPUT","GROUP_MARK","STEP_CONTENT","init","canvas","setupCanvas","setupScrollPassthrough","setTextFont","state","State","minimalLight","TransformsPlugin","RenderPlugin","OrbitPlugin","LinesPlugin","ArrowsPlugin","TextPlugin","TweenPlugin","createStepPlugin","SpecdecPlugin","BorderPlugin","ProbabilityDistributionPlugin","GradientLegendPlugin","inputTokens","outputTokens","eid","TokenIndex","Text","idx","group","BAR_COUNT","tokenData","probBarsEid","ProbabilityDistribution","highlightEids","BarHighlight","highlight0Eid","highlight1Eid","highlight0LabelEid","highlight1LabelEid","childEid","Pair","ChildOf","setDistributionProbabilities","TokenReplacement","setTokenReplacementTexts","updateGraphForStep","step","tokenIndex","data","setupCanvasRecording","controllerEid","StepController","elements","findStepElements","setupStepUI","createVisibilityLoop","reportHeight"],"mappings":"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"}