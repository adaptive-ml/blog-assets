<scene>
    <a id="orbit-target" transform="pos: 0 3 0" />

    <a id="camera"
        transform
        camera="clear-color: 0xffffff; mode: 1; size: 4.3"
        orbit="button: 0; target: @orbit-target; target-distance: 6; yaw: 0.2; pitch: 0.3; target-yaw: 0.2; target-pitch: 0.3; min-pitch: 0; zoom-speed: 0"
        fxaa
    />

    <a ambient-light="intensity: 1.3" />
    <a directional-light="intensity: 0.7" />

    <a id="controller" step-controller />

    <!-- Probability distribution bars -->
    <a id="prob-bars" transform="pos: 0 0.5 0" probability-distribution="bar-count: 10; blend: 1; comparison-transition: 1" />

    <!-- Legend (top-left of graph area) -->
    <a id="legend" transform="pos: -3.5 5.6 0.5">
        <!-- Target legend (navy) - visible initially -->
        <a id="legend-target-box" transform="pos: 0 0 0" mesh="shape: 0; size: 0.35 0.35 0.35; color: 0x2a4a6d" />
        <a id="legend-target" transform="pos: 0.4 0 0" text="font-size: 0.45; color: 0x2a4a6d; anchor-x: 0; anchor-y: 0.5; content: Target" />

        <!-- Draft legend (amber) - visible initially -->
        <a id="legend-draft-box" transform="pos: 2.6 0 0" mesh="shape: 0; size: 0.35 0.35 0.35; color: 0xb8864a" />
        <a id="legend-draft" transform="pos: 3.0 0 0" text="font-size: 0.45; color: 0xb8864a; anchor-x: 0; anchor-y: 0.5; content: Draft" />

        <!-- Min legend (green/accepted) - hidden initially -->
        <a id="legend-min-box" transform="pos: 0 0 0; scale: 0 0 0" mesh="shape: 0; size: 0.35 0.35 0.35; color: 0x22c55e" />
        <a id="legend-min" transform="pos: 0.4 0 0; scale: 0 0 0" text="font-size: 0.45; color: 0x22c55e; anchor-x: 0; anchor-y: 0.5; content: Accepted" />

        <!-- Excess legend (red/rejected) - hidden initially -->
        <a id="legend-excess-box" transform="pos: 3.0 0 0; scale: 0 0 0" mesh="shape: 0; size: 0.35 0.35 0.35; color: 0xef4444" />
        <a id="legend-excess" transform="pos: 3.4 0 0; scale: 0 0 0" text="font-size: 0.45; color: 0xef4444; anchor-x: 0; anchor-y: 0.5; content: Rejected" />

        <!-- Residual legend (purple) - hidden initially, same position as excess since they swap -->
        <a id="legend-residual-box" transform="pos: 3.0 0 0; scale: 0 0 0" mesh="shape: 0; size: 0.35 0.35 0.35; color: 0x9333ea" />
        <a id="legend-residual" transform="pos: 3.4 0 0; scale: 0 0 0" text="font-size: 0.45; color: 0x9333ea; anchor-x: 0; anchor-y: 0.5; content: Resampled" />
    </a>

    <!-- Step 0 → 1: Show min region, hide draft/target legends -->
    <a id="step-0-1" sequence step-transition="from: 0; to: 1">
        <!-- Transition to min view -->
        <a tween="target: @prob-bars.probability-distribution.blend; to: 0; duration: 0.5; easing: ease-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.comparison-transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.min-transition; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.2" />
        <!-- Hide draft/target legends, show min legend -->
        <a tween="target: @legend-draft-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-draft-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-draft-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-draft.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-draft.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-draft.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-min-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-min-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-min.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-min.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-min.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
    </a>

    <!-- Step 1 → 0: Return to draft/target view -->
    <a id="step-1-0" sequence step-transition="from: 1; to: 0">
        <a tween="target: @prob-bars.probability-distribution.min-transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.blend; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.2" />
        <a tween="target: @prob-bars.probability-distribution.comparison-transition; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.2" />
        <a tween="target: @prob-bars.probability-distribution.transition; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.2" />
        <!-- Hide min legend, show draft/target legends -->
        <a tween="target: @legend-min-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-draft-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-draft-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-draft-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-draft.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-draft.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-draft.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-target-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-target-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-target-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-target.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-target.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-target.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
    </a>

    <!-- Step 1 → 2: Show excess draft (amber above min) -->
    <a id="step-1-2" sequence step-transition="from: 1; to: 2">
        <a tween="target: @prob-bars.probability-distribution.excess-draft-transition; to: 1; duration: 0.5; easing: ease-out-expo" />
        <!-- Show excess legend -->
        <a tween="target: @legend-excess-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-excess-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-excess-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-excess.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-excess.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @legend-excess.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.3" />
    </a>

    <!-- Step 2 → 1: Hide excess draft -->
    <a id="step-2-1" sequence step-transition="from: 2; to: 1">
        <a tween="target: @prob-bars.probability-distribution.excess-draft-transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <!-- Hide excess legend -->
        <a tween="target: @legend-excess-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-excess-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-excess-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-excess.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-excess.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-excess.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
    </a>

    <!-- Step 2 → 3: Animate transfer (excess draft fades, excess target appears) -->
    <a id="step-2-3" sequence step-transition="from: 2; to: 3">
        <a tween="target: @prob-bars.probability-distribution.excess-target-transition; to: 1; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.transfer-progress; to: 1; duration: 0.8; easing: ease-in-out-expo; delay: 0.2" />
        <!-- Show residual legend -->
        <a tween="target: @legend-residual-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-residual-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-residual-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-residual.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-residual.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-residual.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <!-- Hide excess legend as it fades out -->
        <a tween="target: @legend-excess-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
        <a tween="target: @legend-excess-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
        <a tween="target: @legend-excess-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
        <a tween="target: @legend-excess.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
        <a tween="target: @legend-excess.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
        <a tween="target: @legend-excess.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
    </a>

    <!-- Step 3 → 2: Reverse transfer -->
    <a id="step-3-2" sequence step-transition="from: 3; to: 2">
        <a tween="target: @prob-bars.probability-distribution.transfer-progress; to: 0; duration: 0.8; easing: ease-in-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.excess-target-transition; to: 0; duration: 0.3; easing: ease-out-expo; delay: 0.6" />
        <!-- Hide residual legend -->
        <a tween="target: @legend-residual-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <!-- Show excess legend -->
        <a tween="target: @legend-excess-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-excess-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-excess-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-excess.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-excess.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
        <a tween="target: @legend-excess.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.5" />
    </a>

    <!-- Step 3 → 4: Show that min + residual = target distribution -->
    <a id="step-3-4" sequence step-transition="from: 3; to: 4">
        <!-- Hide min and excess target bars -->
        <a tween="target: @prob-bars.probability-distribution.min-transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <a tween="target: @prob-bars.probability-distribution.excess-target-transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <!-- Show target distribution (navy) -->
        <a tween="target: @prob-bars.probability-distribution.transition; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @prob-bars.probability-distribution.blend; to: 0; duration: 0.5; easing: ease-out-expo; delay: 0.3" />
        <!-- Hide accepted/resampled legends, show target legend -->
        <a tween="target: @legend-min-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-residual.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-target-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-target-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-target.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-target.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-target.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
    </a>

    <!-- Step 4 → 3: Return to min + residual view -->
    <a id="step-4-3" sequence step-transition="from: 4; to: 3">
        <!-- Hide target distribution -->
        <a tween="target: @prob-bars.probability-distribution.transition; to: 0; duration: 0.5; easing: ease-out-expo" />
        <!-- Show min and excess target bars -->
        <a tween="target: @prob-bars.probability-distribution.min-transition; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.3" />
        <a tween="target: @prob-bars.probability-distribution.excess-target-transition; to: 1; duration: 0.5; easing: ease-out-expo; delay: 0.3" />
        <!-- Hide target legend, show accepted/resampled legends -->
        <a tween="target: @legend-target-box.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target-box.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target-box.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target.transform.scale-x; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target.transform.scale-y; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-target.transform.scale-z; to: 0; duration: 0.3; easing: ease-out-expo" />
        <a tween="target: @legend-min-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-min-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-min-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-min.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-min.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-min.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-residual-box.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-residual-box.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-residual-box.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-residual.transform.scale-x; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-residual.transform.scale-y; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
        <a tween="target: @legend-residual.transform.scale-z; to: 1; duration: 0.3; easing: ease-out-expo; delay: 0.4" />
    </a>
</scene>
