import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as w,g as D,a as b,b as x,c as P,T as f,C,d as O,e as k,f as U,R as V,O as G,h as W,i as j}from"./step-plugin-Cqgj3jUS.js";import{M as H,A as Q}from"./mp4-muxer-DaZBAdSD.js";import{c as Y,d as J,D as K}from"./ui-vQ9UuVEs.js";let p=!1;function X(e){let n=0;for(const i of Object.keys(e)){const[t,c]=i.split("-").map(Number);n=Math.max(n,t,c)}return n}function q(e,n,i){const t=window.devicePixelRatio||1;e.style.width=`${n/t}px`,e.style.height=`${i/t}px`,e.width=n,e.height=i}async function Z(e,n,i,t,c){x.state[i]=b.IDLE,x.elapsed[i]=0;for(const o of n.query([P(C.relation,i),f]))f.state[o]=O.IDLE,f.elapsed[o]=0;x.state[i]=b.PLAYING;let u=0;for(const o of n.query([P(C.relation,i),f]))u=Math.max(u,f.duration[o]);const g=u+.1,l=Math.ceil(g*t.fps),s=new H({target:new Q,video:{codec:"avc",width:t.width,height:t.height},fastStart:"in-memory"}),a=new VideoEncoder({output:(o,d)=>s.addVideoChunk(o,d),error:o=>console.error("Encoder error:",o)});a.configure({codec:"avc1.640032",width:t.width,height:t.height,bitrate:t.bitrate,framerate:t.fps});const r=1/t.fps;for(let o=0;o<l;o++){q(e,t.width,t.height),n.step(r);const d=new VideoFrame(e,{timestamp:o*1e6/t.fps});a.encode(d),d.close(),o%30===0&&(c?.(o,l),await new Promise(v=>setTimeout(v,0)))}return await a.flush(),s.finalize(),new Blob([s.target.buffer],{type:"video/mp4"})}function ee(e){const{sequenceMap:n,name:i="recording",recording:t={}}=e,c={...K,...t},u=X(n);let g=null,l="Waiting...",s=0,a,r=null,o=null;const d=()=>{g?.({status:l,isRecording:p,hasCanvas:!!r,currentStep:s,maxStep:u})},v=async()=>{if(p||!r||!o)return;const m=s+1;if(m>u)return;const h=n[`${s}-${m}`];if(!h){l=`No seq ${s}-${m}`,d();return}const y=D(h);if(y===null){l="Seq not found",d();return}p=!0,l="Recording...",d();const N=r.width,A=r.height,B=r.style.cssText;document.body.classList.add("recording-mode"),r.classList.add("recording-target"),q(r,c.width,c.height),window.dispatchEvent(new Event("resize")),await new Promise(S=>requestAnimationFrame(S));const E=await Z(r,o,y,c,(S,z)=>{l=`${S}/${z}`,d()});document.body.classList.remove("recording-mode"),r.classList.remove("recording-target"),r.width=N,r.height=A,r.style.cssText=B,window.dispatchEvent(new Event("resize")),s=m,a!==void 0&&(w.target[a]=m),J(E,`${i}-step-${s-1}-${s}.mp4`),l=`${(E.size/1024/1024).toFixed(1)}MB`,p=!1,d()},$=()=>{p||s<=0||(s--,a!==void 0&&(w.target[a]=s),d())},L=()=>{p||s>=u||(s++,a!==void 0&&(w.target[a]=s),d())},{element:M,update:F}=Y({onRecord:v,onPrev:$,onNext:L,showSteps:!0});g=F,document.body.appendChild(M);const I=setInterval(()=>{const m=typeof e.canvas=="string"?e.canvas:null,h=m?document.querySelector(m):e.canvas;if(!h?.__state__)return;clearInterval(I),r=h,o=h.__state__,a=[...o.query([w])][0],a!==void 0&&(s=w.step[a]),l="Ready",d()},100)}const R={"0-1":"step-0-1","1-0":"step-1-0"};function T(e){const n=e.getBoundingClientRect();e.width=n.width*window.devicePixelRatio,e.height=n.height*window.devicePixelRatio}async function _(){const e=document.getElementById("canvas-1");if(!e)return;T(e),window.addEventListener("resize",()=>T(e));const n=await k.new().withCanvas(e).withPlugins(U,V,G,W,j(R)).withScene("/scenes/steps.scene").build();e.__state__=n;let i=performance.now();const t=c=>{const u=(c-i)/1e3;i=c,n.step(u),requestAnimationFrame(t)};requestAnimationFrame(t),ee({canvas:"#canvas-1",sequenceMap:R,name:"video"})}typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_):_());
//# sourceMappingURL=video-BHNnH8-T.js.map
