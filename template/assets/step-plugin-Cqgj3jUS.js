var qe=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0}),Fr=Symbol.for("bitecs-relation"),$r=Symbol.for("bitecs-pairTarget"),qr=Symbol.for("bitecs-isPairComponent"),Br=Symbol.for("bitecs-relationData"),Mn=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?zr:n;if(!e.pairsMap.has(r)){let s={};qe(s,Fr,t),qe(s,$r,r),qe(s,qr,!0),e.pairsMap.set(r,s)}return e.pairsMap.get(r)};return qe(t,Br,e),t},kr=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},Vr=Symbol.for("bitecs-wildcard");function Lr(){let e=Mn();return Object.defineProperty(e,Vr,{value:!0,enumerable:!1,writable:!1,configurable:!1}),e}function Ur(){let e=Symbol.for("bitecs-global-wildcard");return globalThis[e]||(globalThis[e]=Lr()),globalThis[e]}var zr=Ur();function Xr(){return Mn()}function Yr(){let e=Symbol.for("bitecs-global-isa");return globalThis[e]||(globalThis[e]=Xr()),globalThis[e]}Yr();var Ee=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0}),Gr=(e,t)=>t&e.entityMask,jr=(e,t)=>t>>>e.versionShift&(1<<e.versionBits)-1,Wr=(e,t)=>{let n=jr(e,t)+1&(1<<e.versionBits)-1;return t&e.entityMask|n<<e.versionShift},Zr=e=>{let t={versioning:!1,versionBits:8},n=t.versionBits??8,r=t.versioning??!1,s=32-n,o=(1<<s)-1,i=s,a=(1<<n)-1<<i;return{aliveCount:0,dense:[],sparse:[],maxId:0,versioning:r,versionBits:n,entityMask:o,versionShift:i,versionMask:a}},Qr=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount],r=n;return e.sparse[r]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},Hr=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let r=e.aliveCount-1,s=e.dense[r];if(e.sparse[s]=n,e.dense[n]=s,e.sparse[t]=r,e.dense[r]=t,e.versioning){let o=Wr(e,t);e.dense[r]=o}e.aliveCount--},Bt=(e,t)=>{let n=Gr(e,t),r=e.sparse[n];return r!==void 0&&r<e.aliveCount&&e.dense[r]===t},N=Symbol.for("bitecs_internal"),Kr=(e,t)=>Ee(e||{},N,{entityIndex:t||Zr(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new Map,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set,entitiesWithRelations:new Set,hierarchyData:new Map,hierarchyActiveRelations:new Set,hierarchyQueryCache:new Map});function Jr(...e){let t,n;return e.forEach(r=>{typeof r=="object"&&"dense"in r&&"sparse"in r&&"aliveCount"in r?t=r:typeof r=="object"&&(n=r)}),Kr(n,t)}var Dr=e=>Array.from(e[N].entityComponents.keys()),pe=()=>{let e=[],t=[],n=r=>e[t[r]]===r;return{add:r=>{n(r)||(t[r]=e.push(r)-1)},remove:r=>{if(!n(r))return;let s=t[r],o=e.pop();o!==r&&(e[s]=o,t[o]=s)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0},sort:r=>{e.sort(r);for(let s=0;s<e.length;s++)t[e[s]]=s}}},Ht=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:ArrayBuffer,xn=(e=1e3)=>{let t=[],n=0,r=new Uint32Array(new Ht(e*4)),s=o=>o<t.length&&t[o]<n&&r[t[o]]===o;return{add:o=>{if(!s(o)){if(n>=r.length){let i=new Uint32Array(new Ht(r.length*2*4));i.set(r),r=i}r[n]=o,t[o]=n,n++}},remove:o=>{if(!s(o))return;n--;let i=t[o],a=r[n];r[i]=a,t[a]=i},has:s,sparse:t,get dense(){return new Uint32Array(r.buffer,0,n)},reset:()=>{n=0,t.length=0},sort:o=>{let i=Array.from(r.subarray(0,n));i.sort(o);for(let a=0;a<i.length;a++)r[a]=i[a];for(let a=0;a<n;a++)t[r[a]]=a}}},je=()=>{let e=new Set;return{subscribe:t=>(e.add(t),()=>{e.delete(t)}),notify:(t,...n)=>Array.from(e).reduce((r,s)=>{let o=s(t,...n);return o&&typeof o=="object"?{...r,...o}:r},{})}},Re=Symbol.for("bitecs-relation"),se=Symbol.for("bitecs-pairTarget"),nt=Symbol.for("bitecs-isPairComponent"),J=Symbol.for("bitecs-relationData"),We=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?O:n;if(!e.pairsMap.has(r)){let s={};Ee(s,Re,t),Ee(s,se,r),Ee(s,nt,!0),e.pairsMap.set(r,s)}return e.pairsMap.get(r)};return Ee(t,J,e),t},es=e=>t=>{let n=t[J];return n.initStore=e,t},ts=e=>{let t=e[J];return t.exclusiveRelation=!0,e},ns=e=>{let t=e[J];return t.autoRemoveSubject=!0,e},rs=e=>t=>{let n=t[J];return n.onTargetRemoved=e,t},B=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},H=(e,t,n)=>{let r=zt(e,t),s=[];for(let o of r)o[Re]===n&&o[se]!==O&&!ls(o[se])&&s.push(o[se]);return s};function ss(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:r,onTargetRemoved:s}=e[0];return[t&&es(t),n&&ts,r&&ns,s&&rs(s)].filter(Boolean).reduce((o,i)=>i(o),We())}else return e.reduce((t,n)=>n(t),We())}var os=Symbol.for("bitecs-wildcard");function is(){let e=We();return Object.defineProperty(e,os,{value:!0,enumerable:!1,writable:!1,configurable:!1}),e}function as(){let e=Symbol.for("bitecs-global-wildcard");return globalThis[e]||(globalThis[e]=is()),globalThis[e]}var O=as();function us(){return We()}function cs(){let e=Symbol.for("bitecs-global-isa");return globalThis[e]||(globalThis[e]=us()),globalThis[e]}var Ze=cs();function ls(e){return e?Object.getOwnPropertySymbols(e).includes(J):!1}var fs=64,Y=4294967295,In=1024;function Sn(e,t){let{depths:n}=e;if(t<n.length)return n;let r=Math.max(t+1,n.length*2,n.length+In),s=new Uint32Array(r);return s.fill(Y),s.set(n),e.depths=s,s}function Pn(e,t,n,r){let{depthToEntities:s}=e;if(r!==void 0&&r!==Y){let o=s.get(r);o&&(o.remove(t),o.dense.length===0&&s.delete(r))}n!==Y&&(s.has(n)||s.set(n,xn()),s.get(n).add(t))}function ds(e,t){t>e.maxDepth&&(e.maxDepth=t)}function kt(e,t,n,r){e.depths[t]=n,Pn(e,t,n,r),ds(e,n)}function Cn(e,t){e[N].hierarchyQueryCache.delete(t)}function An(e,t){let n=e[N];return n.hierarchyActiveRelations.has(t)||(n.hierarchyActiveRelations.add(t),Vt(e,t),ps(e,t)),n.hierarchyData.get(t)}function ps(e,t){let n=Fe(e,[B(t,O)]);for(let s of n)Nt(e,t,s);let r=new Set;for(let s of n)for(let o of H(e,s,t))r.has(o)||(r.add(o),Nt(e,t,o))}function Vt(e,t){let n=e[N];if(!n.hierarchyData.has(t)){let r=Math.max(In,n.entityIndex.dense.length*2),s=new Uint32Array(r);s.fill(Y),n.hierarchyData.set(t,{depths:s,dirty:pe(),depthToEntities:new Map,maxDepth:0})}}function On(e,t,n,r=new Set){if(r.has(n))return 0;r.add(n);let s=H(e,n,t);if(s.length===0)return 0;if(s.length===1)return Et(e,t,s[0],r)+1;let o=1/0;for(let i of s){let a=Et(e,t,i,r);if(a<o&&(o=a,o===0))break}return o===1/0?0:o+1}function Et(e,t,n,r){let s=e[N];Vt(e,t);let o=s.hierarchyData.get(t),{depths:i}=o;if(i=Sn(o,n),i[n]===Y){let a=On(e,t,n,r);return kt(o,n,a),a}return i[n]}function Nt(e,t,n){return Et(e,t,n,new Set)}function Rn(e,t,n,r,s=pe()){if(s.has(n))return;s.add(n);let o=Fe(e,[t(n)]);for(let i of o)r.add(i),Rn(e,t,i,r,s)}function hs(e,t,n,r,s=new Set){let o=e[N];if(!o.hierarchyActiveRelations.has(t))return;Vt(e,t);let i=o.hierarchyData.get(t);if(s.has(n)){i.dirty.add(n);return}s.add(n);let{depths:a,dirty:u}=i,c=r!==void 0?Nt(e,t,r)+1:0;if(c>fs)return;let l=a[n];kt(i,n,c,l===Y?void 0:l),l!==c&&(Rn(e,t,n,u,pe()),Cn(e,t))}function gs(e,t,n){let r=e[N];if(!r.hierarchyActiveRelations.has(t))return;let s=r.hierarchyData.get(t),{depths:o}=s;o=Sn(s,n),Fn(e,t,n,o,pe()),Cn(e,t)}function Fn(e,t,n,r,s){if(s.has(n))return;s.add(n);let o=e[N].hierarchyData.get(t);if(n<r.length){let a=r[n];a!==Y&&(o.depths[n]=Y,Pn(o,n,Y,a))}let i=Fe(e,[t(n)]);for(let a of i)Fn(e,t,a,r,s)}function $n(e,t){let n=e[N].hierarchyData.get(t);if(!n)return;let{dirty:r,depths:s}=n;if(r.dense.length!==0){for(let o of r.dense)if(s[o]===Y){let i=On(e,t,o);kt(n,o,i)}r.reset()}}function ms(e,t,n,r={}){let s=e[N];An(e,t);let o=He(e,[t,...n]),i=s.hierarchyQueryCache.get(t);if(i&&i.hash===o)return i.result;$n(e,t),kn(e,n,r);let a=s.queriesHashMap.get(He(e,n)),u=s.hierarchyData.get(t),{depths:c}=u;a.sort((f,d)=>{let p=c[f],h=c[d];return p!==h?p-h:f-d});let l=(r.buffered,a.dense);return s.hierarchyQueryCache.set(t,{hash:o,result:l}),l}function ys(e,t,n,r={}){let s=An(e,t);$n(e,t);let o=s.depthToEntities.get(n);return o?(r.buffered,o.dense):r.buffered?new Uint32Array(0):[]}var de=Symbol.for("bitecs-opType"),Qe=Symbol.for("bitecs-opTerms"),ws=e=>(...t)=>({[de]:e,[Qe]:t}),Kt=ws("Not"),_t=Symbol.for("bitecs-hierarchyType"),qn=Symbol.for("bitecs-hierarchyRel"),Bn=Symbol.for("bitecs-hierarchyDepth"),bs=(e,t)=>({[_t]:"Hierarchy",[qn]:e,[Bn]:t}),Ne=Symbol.for("bitecs-modifierType"),vs={[Ne]:"nested"},Es=vs,He=(e,t)=>{let n=e[N],r=o=>(n.componentMap.has(o)||Te(e,o),n.componentMap.get(o).id),s=o=>de in o?`${o[de].toLowerCase()}(${o[Qe].map(s).sort().join(",")})`:r(o).toString();return t.map(s).sort().join("-")},Jt=(e,t,n={})=>{let r=e[N],s=He(e,t),o=[],i=y=>{de in y?y[Qe].forEach(i):(r.componentMap.has(y)||Te(e,y),o.push(y))};t.forEach(i);let a=[],u=[],c=[],l=(y,T)=>{T.forEach(C=>{r.componentMap.has(C)||Te(e,C),y.push(C)})};t.forEach(y=>{if(de in y){let{[de]:T,[Qe]:C}=y;if(T==="Not")l(u,C);else if(T==="Or")l(c,C);else if(T==="And")l(a,C);else throw new Error(`Nested combinator ${T} not supported yet - use simple queries for best performance`)}else r.componentMap.has(y)||Te(e,y),a.push(y)});let f=o.map(y=>r.componentMap.get(y)),d=[...new Set(f.map(y=>y.generationId))],p=(y,T)=>(y[T.generationId]=(y[T.generationId]||0)|T.bitflag,y),h=a.map(y=>r.componentMap.get(y)).reduce(p,{}),g=u.map(y=>r.componentMap.get(y)).reduce(p,{}),m=c.map(y=>r.componentMap.get(y)).reduce(p,{}),M=f.reduce(p,{}),E=Object.assign(n.buffered?xn():pe(),{allComponents:o,orComponents:c,notComponents:u,masks:h,notMasks:g,orMasks:m,hasMasks:M,generations:d,toRemove:pe(),addObservable:je(),removeObservable:je(),queues:{}});r.queries.add(E),r.queriesHashMap.set(s,E),f.forEach(y=>{y.queries.add(E)}),u.length&&r.notQueries.add(E);let F=r.entityIndex;for(let y=0;y<F.aliveCount;y++){let T=F.dense[y];K(e,T,Ut)||rt(e,E,T)&&st(E,T)}return E};function kn(e,t,n={}){let r=e[N],s=He(e,t),o=r.queriesHashMap.get(s);return o?n.buffered&&!("buffer"in o.dense)&&(o=Jt(e,t,{buffered:!0})):o=Jt(e,t,n),n.buffered,o.dense}function Fe(e,t,...n){let r=t.find(u=>u&&typeof u=="object"&&_t in u),s=t.filter(u=>!(u&&typeof u=="object"&&_t in u)),o=!1,i=!0,a=n.some(u=>u&&typeof u=="object"&&Ne in u);for(let u of n)if(a&&u&&typeof u=="object"&&Ne in u){let c=u;c[Ne]==="buffer"&&(o=!0),c[Ne]==="nested"&&(i=!1)}else if(!a){let c=u;c.buffered!==void 0&&(o=c.buffered),c.commit!==void 0&&(i=c.commit)}if(r){let{[qn]:u,[Bn]:c}=r;return c!==void 0?ys(e,u,c,{buffered:o}):ms(e,u,s,{buffered:o})}return i&&_s(e),kn(e,s,{buffered:o})}function rt(e,t,n){let r=e[N],{masks:s,notMasks:o,orMasks:i,generations:a}=t,u=Object.keys(i).length===0;for(let c=0;c<a.length;c++){let l=a[c],f=s[l],d=o[l],p=i[l],h=r.entityMasks[l][n];if(d&&h&d||f&&(h&f)!==f)return!1;p&&h&p&&(u=!0)}return u}var st=(e,t)=>{if(e.toRemove.has(t)){e.toRemove.remove(t),e.addObservable.notify(t);return}e.has(t)||(e.add(t),e.addObservable.notify(t))},Ns=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let n=e.toRemove.dense[t];e.remove(n)}e.toRemove.reset()},_s=e=>{let t=e[N];t.dirtyQueries.size&&(t.dirtyQueries.forEach(Ns),t.dirtyQueries.clear())},Lt=(e,t,n)=>{let r=e[N];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),r.dirtyQueries.add(t),t.removeObservable.notify(n))},Te=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[N],r=new Set,s={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:r,setObservable:je(),getObservable:je()};return n.componentMap.set(t,s),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),s},K=(e,t,n)=>{let r=e[N],s=r.componentMap.get(n);if(!s)return!1;let{generationId:o,bitflag:i}=s;return(r.entityMasks[o][t]&i)===i},Vn=(e,t,n)=>{let r=e[N].componentMap.get(n);if(r&&K(e,t,n))return r.getObservable.notify(t)},Ln=(e,t,n,r,s=new Set)=>{if(!s.has(r)){s.add(r),he(t,n,Ze(r));for(let o of zt(t,r))if(o!==Ut&&!K(t,n,o)){he(t,n,o);let i=e.componentMap.get(o);if(i?.setObservable){let a=Vn(t,r,o);i.setObservable.notify(n,a)}}for(let o of H(t,r,Ze))Ln(e,t,n,o,s)}},he=(e,t,n)=>{if(!Se(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);let r=e[N],s="component"in n?n.component:n,o="data"in n?n.data:void 0;r.componentMap.has(s)||Te(e,s);let i=r.componentMap.get(s);if(K(e,t,s))return o!==void 0&&i.setObservable.notify(t,o),!1;let{generationId:a,bitflag:u,queries:c}=i;if(r.entityMasks[a][t]|=u,K(e,t,Ut)||c.forEach(l=>{rt(e,l,t)?st(l,t):Lt(e,l,t)}),r.entityComponents.get(t).add(s),o!==void 0&&i.setObservable.notify(t,o),s[nt]){let l=s[Re],f=s[se];if(Tt(e,t,B(l,O),B(O,f)),typeof f=="number"&&(Tt(e,f,B(O,t),B(O,l)),r.entitiesWithRelations.add(f),r.entitiesWithRelations.add(t)),r.entitiesWithRelations.add(f),l[J].exclusiveRelation===!0&&f!==O){let d=H(e,t,l)[0];d!=null&&d!==f&&j(e,t,l(d))}if(l===Ze){let d=H(e,t,Ze);for(let p of d)Ln(r,e,t,p)}hs(e,l,t,typeof f=="number"?f:void 0)}return!0};function Tt(e,t,...n){(Array.isArray(n[0])?n[0]:n).forEach(r=>{he(e,t,r)})}var j=(e,t,...n)=>{let r=e[N];if(!Se(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);n.forEach(s=>{if(!K(e,t,s))return;let o=r.componentMap.get(s),{generationId:i,bitflag:a,queries:u}=o;if(r.entityMasks[i][t]&=~a,u.forEach(c=>{c.toRemove.remove(t),rt(e,c,t)?st(c,t):Lt(e,c,t)}),r.entityComponents.get(t).delete(s),s[nt]){let c=s[se],l=s[Re];gs(e,l,t),j(e,t,B(O,c)),typeof c=="number"&&Se(e,c)&&(j(e,c,B(O,t)),j(e,c,B(O,l))),H(e,t,l).length===0&&j(e,t,B(l,O))}})},Ts=j,Ut={};function Ms(e,...t){let n=e[N],r=Qr(n.entityIndex);return n.notQueries.forEach(s=>{rt(e,s,r)&&st(s,r)}),n.entityComponents.set(r,new Set),t.length>0&&Tt(e,r,t),r}var Un=(e,t)=>{let n=e[N];if(!Bt(n.entityIndex,t))return;let r=[t],s=new Set;for(;r.length>0;){let o=r.shift();if(s.has(o))continue;s.add(o);let i=[];if(n.entitiesWithRelations.has(o)){for(let a of Fe(e,[O(o)],Es))if(Se(e,a))for(let u of n.entityComponents.get(a)){if(!u[nt])continue;let c=u[Re][J];i.push(()=>j(e,a,B(O,o))),u[se]===o&&(i.push(()=>j(e,a,u)),c.autoRemoveSubject&&r.push(a),c.onTargetRemoved&&i.push(()=>c.onTargetRemoved(e,a,o)))}n.entitiesWithRelations.delete(o)}for(let a of i)a();for(let a of r)Un(e,a);for(let a of n.queries)Lt(e,a,o);Hr(n.entityIndex,o),n.entityComponents.delete(o);for(let a=0;a<n.entityMasks.length;a++)n.entityMasks[a][o]=0}},zt=(e,t)=>{let n=e[N];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!Bt(n.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(n.entityComponents.get(t))},Se=(e,t)=>Bt(e[N].entityIndex,t);class zn extends Error{constructor(t="Circular dependency detected"){super(t),this.name="CycleError"}}function ze(e,t){if(e.length===0)return[];const n=new Map,r=new Map;for(const i of e)n.set(i,new Set),r.set(i,0);for(const[i,a]of t)!n.has(i)||!n.has(a)||(n.get(i).add(a),r.set(a,r.get(a)+1));xs(e,n);const s=[],o=[];for(const i of e)r.get(i)===0&&s.push(i);for(;s.length>0;){const i=s.shift();o.push(i);for(const a of n.get(i)){const u=r.get(a)-1;r.set(a,u),u===0&&s.push(a)}}return o}function xs(e,t){const n=new Set,r=new Set;function s(o){if(r.has(o))return!0;if(n.has(o))return!1;n.add(o),r.add(o);for(const i of t.get(o))if(s(i))return!0;return r.delete(o),!1}for(const o of e)if(s(o))throw new zn}const Xe={FIXED_DT:1/50,DEFAULT_DT:1/60};class Xn extends Error{constructor(t){super(t),this.name="OrderingError"}}class Is{_systems=new Set;_systemsVersion=0;_accumulator=0;_initialized=new WeakSet;_cache=new Map;_cacheVersion=-1;_time={deltaTime:0,fixedDeltaTime:Xe.FIXED_DT,elapsed:0};get systems(){return this._systems}get systemsVersion(){return this._systemsVersion}get accumulator(){return this._accumulator}get time(){return this._time}register(t){this._systems.add(t),this._systemsVersion++}unregister(t){this._systems.delete(t)&&this._systemsVersion++}step(t,n=Xe.DEFAULT_DT){const r=Xe.FIXED_DT;for(this._time.deltaTime=n,this._time.elapsed+=n,this._accumulator+=n,this.runGroup(t,"setup");this._accumulator>=r;)this._time.deltaTime=r,this.runGroup(t,"fixed"),this._accumulator-=r;this._time.deltaTime=n,this.runGroup(t,"simulation"),this.runGroup(t,"draw")}runGroup(t,n){for(const r of this.getSorted(n))this._initialized.has(r)||(r.setup?.(t),this._initialized.add(r)),r.update?.(t)}getSorted(t){this._systemsVersion!==this._cacheVersion&&(this._cache.clear(),this._cacheVersion=this._systemsVersion);const n=this._cache.get(t);if(n)return n;const r=Array.from(this._systems),s=r.filter(i=>(i.group??"simulation")===t),o=Ss(s,r);return this._cache.set(t,o),o}}function Ss(e,t){Ps(e,t??e);const r=e.filter(i=>i.first),s=e.filter(i=>i.last),o=e.filter(i=>!i.first&&!i.last);return[...ze(r,ct(r)),...ze(o,ct(o)),...ze(s,ct(s))]}function ct(e){const t=[];for(const n of e){for(const r of n.before??[])e.includes(r)&&t.push([n,r]);for(const r of n.after??[])e.includes(r)&&t.push([r,n])}return t}function Ps(e,t){for(const n of e){if(n.first&&n.last)throw new Xn("System cannot have both first and last constraints");const r=n.group??"simulation";for(const s of n.before??[])Dt(s,r,t);for(const s of n.after??[])Dt(s,r,t)}}function Dt(e,t,n){if(!n.includes(e))return;const r=e.group??"simulation";if(r!==t)throw new Xn(`Cross-group constraint: ${t} references ${r}`)}const Cs="modulepreload",As=function(e,t){return new URL(e,t).href},en={},Mt=function(t,n,r){let s=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(f=>Promise.resolve(f).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};const i=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),u=a?.nonce||a?.getAttribute("nonce");s=c(n.map(l=>{if(l=As(l,r),l in en)return;en[l]=!0;const f=l.endsWith(".css"),d=f?'[rel="stylesheet"]':"";if(r)for(let h=i.length-1;h>=0;h--){const g=i[h];if(g.href===l&&(!f||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${d}`))return;const p=document.createElement("link");if(p.rel=f?"stylesheet":Cs,f||(p.as="script"),p.crossOrigin="",p.href=l,u&&p.setAttribute("nonce",u),document.head.appendChild(p),f)return new Promise((h,g)=>{p.addEventListener("load",h),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return s.then(i=>{for(const a of i||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})};function Os(){if(typeof __TAURI_INTERNALS__<"u")return"standalone";if(typeof Bun<"u")return"headless";if(typeof window<"u"&&typeof fetch=="function")return"web";throw new Error("Unknown runtime environment")}function Rs(){return{target:"web",async readFile(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.status}`);return t.text()},async readBinary(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}: ${t.status}`);return t.arrayBuffer()},requestFrame(e){requestAnimationFrame(e)},now(){return performance.now()}}}function Fs(){return{target:"headless",async readFile(e){return Bun.file(e).text()},async readBinary(e){return Bun.file(e).arrayBuffer()},requestFrame(e){setTimeout(e,0)},now(){return performance.now()}}}function tn(e){return e.startsWith("/")||e.startsWith("./")||e.startsWith("../")}function $s(){return{target:"standalone",async readFile(e){if(tn(e)){const n=await fetch(e);if(!n.ok)throw new Error(`Failed to load ${e}: ${n.status}`);return n.text()}const{readTextFile:t}=await Mt(async()=>{const{readTextFile:n}=await import("./index-BrFmEk1v.js");return{readTextFile:n}},[],import.meta.url);return t(e)},async readBinary(e){if(tn(e)){const r=await fetch(e);if(!r.ok)throw new Error(`Failed to load ${e}: ${r.status}`);return r.arrayBuffer()}const{readFile:t}=await Mt(async()=>{const{readFile:r}=await import("./index-BrFmEk1v.js");return{readFile:r}},[],import.meta.url);return(await t(e)).buffer},requestFrame(e){requestAnimationFrame(e)},now(){return performance.now()}}}let Be;async function qs(){switch(Os()){case"headless":return Fs();case"standalone":return $s();case"web":return Rs()}}let lt;async function Yn(){return Be||(lt||(lt=qs()),Be=await lt,Be)}function oe(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/[\s_]+/g,"-").toLowerCase()}function Xt(e){return e.replace(/-([a-z])/g,(t,n)=>n.toUpperCase())}const Yt=new WeakMap;function R(e,t){Yt.set(e,t)}function nn(e){return Yt.get(e)}const Gn=new Map;function jn(e,t){const n=oe(e),r=Yt.get(t);Gn.set(n,{component:t,name:n,traits:r})}function Wn(e){return Gn.get(oe(e))}function Bs(e,t,n){return{get:r=>e[r*t+n],set:(r,s)=>{e[r*t+n]=s}}}function D(e){const t=Symbol(e),n=Object.assign(t,{from(r){return r.getResource(n)}});return n}const _=65536;class Pe{world;scheduler=new Is;canvas;_resources=new Map;_disposed=!1;_running=!1;_runtime=null;_lastTime=0;_fieldAccessors=null;get time(){return this.scheduler.time}get running(){return this._running}static Builder=null;static new(){if(!Pe.Builder)throw new Error("StateBuilder not injected. Import from 'shallot' or 'shallot/core'.");return new Pe.Builder}constructor(t=null){this.world=Jr(),this.canvas=t}setResource(t,n){this._resources.set(t,n)}getResource(t){return this._resources.get(t)}deleteResource(t){return this._resources.delete(t)}async start(t){this._running||(this._runtime=t??await Yn(),this._running=!0,this._lastTime=this._runtime.now(),this.scheduleFrame())}stop(){this._running=!1}scheduleFrame(){!this._running||!this._runtime||this._runtime.requestFrame(()=>this.tick())}tick(){if(!this._running||!this._runtime)return;const t=this._runtime.now(),n=(t-this._lastTime)/1e3;this._lastTime=t,this.step(n),this.scheduleFrame()}register(t){if("update"in t||"setup"in t||"dispose"in t)this.scheduler.register(t);else{const n=t;if(n.components)for(const[r,s]of Object.entries(n.components))jn(r,s);if(n.systems)for(const r of n.systems)this.scheduler.register(r)}}unregister(t){this.scheduler.unregister(t)}step(t=Xe.DEFAULT_DT){this.scheduler.step(this,t)}addEntity(){const t=Ms(this.world);if(t>=_)throw new Error(`Entity limit exceeded: ${t} >= ${_}`);return t}removeEntity(t){this._fieldAccessors?.delete(t),Un(this.world,t)}entityExists(t){return Se(this.world,t)}getAllEntities(){return Dr(this.world)}query(t){return Fe(this.world,t)}getEntityComponents(t){return zt(this.world,t)}addComponent(t,n){he(this.world,t,n);const r=nn(n);if(r?.defaults){const s=r.defaults(),o=n;for(const[i,a]of Object.entries(s)){const u=o[i];u!=null&&(u[t]=a)}}}addComponents(t,...n){for(const r of n)this.addComponent(t,r)}removeComponent(t,...n){j(this.world,t,...n)}removeComponents(t,...n){Ts(this.world,t,...n)}hasComponent(t,n){return K(this.world,t,n)}getComponent(t,n){return Vn(this.world,t,n)}setComponent(t,n,r){this.addComponent(t,n);const s=n;for(const[o,i]of Object.entries(r)){const a=s[o];a!=null&&(a[t]=i)}}addRelation(t,n,r){he(this.world,t,n.relation(r))}hasRelation(t,n,r){return K(this.world,t,n.relation(r))}getRelationTargets(t,n){return H(this.world,t,n.relation)}getFirstRelationTarget(t,n){const r=H(this.world,t,n.relation);return r.length>0?r[0]:-1}ensureFieldAccessors(){return this._fieldAccessors||(this._fieldAccessors=new Map),this._fieldAccessors}resolveFieldPath(t){const n=t.lastIndexOf(".");return n===-1?null:{component:t.slice(0,n),field:t.slice(n+1)}}bindFieldAccessor(t,n,r){const s=Wn(n);if(!s)return null;const o=Xt(r),i=nn(s.component);if(i?.accessors?.[o]){const c=i.accessors[o];return this.ensureFieldAccessors().set(t,c),c}const a=s.component[o];if(a==null)return null;const u=Bs(a,1,0);return this.ensureFieldAccessors().set(t,u),u}getFieldAccessor(t){return this._fieldAccessors?.get(t)}removeFieldAccessor(t){return this._fieldAccessors?.delete(t)??!1}dispose(){if(!this._disposed){this.stop(),this._fieldAccessors=null;for(const t of this.scheduler.systems)t.dispose?.(this);this._disposed=!0}}}class ge{static defaultPlugins=[];static loading=null;_plugins=[];_systems=[];_scenes=[];_excludedPlugins=new Set;_useDefaultPlugins=!0;_canvas=null;_loading=void 0;withCanvas(t){return this._canvas=t,this}withPlugins(...t){return this._plugins.push(...t),this}withoutPlugin(t){return this._excludedPlugins.add(t),this}withoutPlugins(...t){for(const n of t)this._excludedPlugins.add(n);return this}withoutDefaultPlugins(){return this._useDefaultPlugins=!1,this}withSystems(...t){return this._systems.push(...t),this}withScene(t){return this._scenes.push(t),this}withLoading(t){return this._loading=t,this}async build(){const t=this._loading===void 0&&this._canvas?ge.loading?.(this._canvas)??null:this._loading,n=t?.show(),r=new Pe(this._canvas),s=new Set;if(this._useDefaultPlugins)for(const l of ge.defaultPlugins)this._excludedPlugins.has(l)||s.add(l);for(const l of this._plugins)s.add(l);const o=[...s];for(const l of o){if(l.components)for(const[f,d]of Object.entries(l.components))jn(f,d);if(l.systems)for(const f of l.systems)r.scheduler.register(f)}const i=[];for(const l of o)for(const f of l.dependencies??[])o.includes(f)&&i.push([f,l]);const a=ze(o,i);let u=0;const c=a.length;for(const l of a)await l.initialize?.(r),u++,t?.update(u/c);for(const l of this._systems)r.scheduler.register(l);if(this._scenes.length>0){const{loadSceneFile:l}=await Mt(async()=>{const{loadSceneFile:d}=await Promise.resolve().then(()=>Go);return{loadSceneFile:d}},void 0,import.meta.url),f=await Yn();for(const d of this._scenes){const p=await l(r,d,f.readFile.bind(f));p.errors.length>0&&console.warn(`Scene "${d}" loaded with errors:`,p.errors)}}return n?.(),r}async run(){const t=await this.build();return await t.start(),t}}Pe.Builder=ge;const Zn=new Map;function Qn(e,t){const n=ss({exclusive:t?.exclusive,autoRemoveSubject:t?.autoRemoveSubject}),r={name:oe(e),relation:n,exclusive:t?.exclusive,autoRemoveSubject:t?.autoRemoveSubject};return Zn.set(r.name,r),r}function ks(e){return Zn.get(oe(e))}const X=Qn("child-of",{exclusive:!0,autoRemoveSubject:!0}),ft=Math.PI/180,ye=180/Math.PI;function rn(e,t,n){return e<t?t:e>n?n:e}function Vs(e,t,n){const r=e*ft*.5,s=t*ft*.5,o=n*ft*.5,i=Math.cos(r),a=Math.sin(r),u=Math.cos(s),c=Math.sin(s),l=Math.cos(o),f=Math.sin(o);return{x:a*u*l+i*c*f,y:i*c*l-a*u*f,z:i*u*f+a*c*l,w:i*u*l-a*c*f}}function sn(e,t,n,r){const s=e+e,o=t+t,i=n+n,a=e*s,u=e*o,c=e*i,l=t*o,f=t*i,d=n*i,p=r*s,h=r*o,g=r*i,m=c+h,M=Math.asin(m<-1?-1:m>1?1:m);return m>-.9999999&&m<.9999999?{x:Math.atan2(p-f,1-(a+l))*ye,y:M*ye,z:Math.atan2(g-u,1-(l+d))*ye}:{x:Math.atan2(f+p,1-(a+d))*ye,y:M*ye,z:0}}function Ls(e,t,n,r,s,o,i=0,a=1,u=0){if(!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(s)||!Number.isFinite(o))throw new Error(`lookAt received NaN: eye=[${e},${t},${n}], target=[${r},${s},${o}]`);let c=e-r,l=t-s,f=n-o,d=Math.sqrt(c*c+l*l+f*f);d===0?f=1:(d=1/d,c*=d,l*=d,f*=d);let p=a*f-u*l,h=u*c-i*f,g=i*l-a*c,m=Math.sqrt(p*p+h*h+g*g);m<1e-6&&(Math.abs(f)>Math.abs(c)?i+=1e-4:u+=1e-4,p=a*f-u*l,h=u*c-i*f,g=i*l-a*c,m=Math.sqrt(p*p+h*h+g*g)),m<1e-6?(p=1,h=0,g=0):(m=1/m,p*=m,h*=m,g*=m);const M=l*g-f*h,E=f*p-c*g,F=c*h-l*p,y=p+E+f;let T,C,Z,ee;if(y>0){const x=.5/Math.sqrt(y+1);T=.25/x,C=(F-l)*x,Z=(c-g)*x,ee=(h-M)*x}else if(p>E&&p>f){const x=2*Math.sqrt(1+p-E-f);T=(F-l)/x,C=.25*x,Z=(M+h)/x,ee=(c+g)/x}else if(E>f){const x=2*Math.sqrt(1+E-p-f);T=(c-g)/x,C=(M+h)/x,Z=.25*x,ee=(F+l)/x}else{const x=2*Math.sqrt(1+f-p-E);T=(h-M)/x,C=(c+g)/x,Z=(F+l)/x,ee=.25*x}return{x:C,y:Z,z:ee,w:T}}const Hn=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",Us=Hn+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",zs="["+Hn+"]["+Us+"]*",Xs=new RegExp("^"+zs+"$");function Kn(e,t){const n=[];let r=t.exec(e);for(;r;){const s=[];s.startIndex=t.lastIndex-r[0].length;const o=r.length;for(let i=0;i<o;i++)s.push(r[i]);n.push(s),r=t.exec(e)}return n}const ot=function(e){const t=Xs.exec(e);return!(t===null||typeof t>"u")};function Ys(e){return typeof e<"u"}const Gs={allowBooleanAttributes:!1,unpairedTags:[]};function js(e,t){t=Object.assign({},Gs,t);const n=[];let r=!1,s=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let o=0;o<e.length;o++)if(e[o]==="<"&&e[o+1]==="?"){if(o+=2,o=an(e,o),o.err)return o}else if(e[o]==="<"){let i=o;if(o++,e[o]==="!"){o=un(e,o);continue}else{let a=!1;e[o]==="/"&&(a=!0,o++);let u="";for(;o<e.length&&e[o]!==">"&&e[o]!==" "&&e[o]!=="	"&&e[o]!==`
`&&e[o]!=="\r";o++)u+=e[o];if(u=u.trim(),u[u.length-1]==="/"&&(u=u.substring(0,u.length-1),o--),!eo(u)){let f;return u.trim().length===0?f="Invalid space after '<'.":f="Tag '"+u+"' is an invalid name.",I("InvalidTag",f,$(e,o))}const c=Qs(e,o);if(c===!1)return I("InvalidAttr","Attributes for '"+u+"' have open quote.",$(e,o));let l=c.value;if(o=c.index,l[l.length-1]==="/"){const f=o-l.length;l=l.substring(0,l.length-1);const d=cn(l,t);if(d===!0)r=!0;else return I(d.err.code,d.err.msg,$(e,f+d.err.line))}else if(a)if(c.tagClosed){if(l.trim().length>0)return I("InvalidTag","Closing tag '"+u+"' can't have attributes or invalid starting.",$(e,i));if(n.length===0)return I("InvalidTag","Closing tag '"+u+"' has not been opened.",$(e,i));{const f=n.pop();if(u!==f.tagName){let d=$(e,f.tagStartPos);return I("InvalidTag","Expected closing tag '"+f.tagName+"' (opened in line "+d.line+", col "+d.col+") instead of closing tag '"+u+"'.",$(e,i))}n.length==0&&(s=!0)}}else return I("InvalidTag","Closing tag '"+u+"' doesn't have proper closing.",$(e,o));else{const f=cn(l,t);if(f!==!0)return I(f.err.code,f.err.msg,$(e,o-l.length+f.err.line));if(s===!0)return I("InvalidXml","Multiple possible root nodes found.",$(e,o));t.unpairedTags.indexOf(u)!==-1||n.push({tagName:u,tagStartPos:i}),r=!0}for(o++;o<e.length;o++)if(e[o]==="<")if(e[o+1]==="!"){o++,o=un(e,o);continue}else if(e[o+1]==="?"){if(o=an(e,++o),o.err)return o}else break;else if(e[o]==="&"){const f=Js(e,o);if(f==-1)return I("InvalidChar","char '&' is not expected.",$(e,o));o=f}else if(s===!0&&!on(e[o]))return I("InvalidXml","Extra text at the end",$(e,o));e[o]==="<"&&o--}}else{if(on(e[o]))continue;return I("InvalidChar","char '"+e[o]+"' is not expected.",$(e,o))}if(r){if(n.length==1)return I("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",$(e,n[0].tagStartPos));if(n.length>0)return I("InvalidXml","Invalid '"+JSON.stringify(n.map(o=>o.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return I("InvalidXml","Start tag expected.",1);return!0}function on(e){return e===" "||e==="	"||e===`
`||e==="\r"}function an(e,t){const n=t;for(;t<e.length;t++)if(e[t]=="?"||e[t]==" "){const r=e.substr(n,t-n);if(t>5&&r==="xml")return I("InvalidXml","XML declaration allowed only at the start of the document.",$(e,t));if(e[t]=="?"&&e[t+1]==">"){t++;break}else continue}return t}function un(e,t){if(e.length>t+5&&e[t+1]==="-"&&e[t+2]==="-"){for(t+=3;t<e.length;t++)if(e[t]==="-"&&e[t+1]==="-"&&e[t+2]===">"){t+=2;break}}else if(e.length>t+8&&e[t+1]==="D"&&e[t+2]==="O"&&e[t+3]==="C"&&e[t+4]==="T"&&e[t+5]==="Y"&&e[t+6]==="P"&&e[t+7]==="E"){let n=1;for(t+=8;t<e.length;t++)if(e[t]==="<")n++;else if(e[t]===">"&&(n--,n===0))break}else if(e.length>t+9&&e[t+1]==="["&&e[t+2]==="C"&&e[t+3]==="D"&&e[t+4]==="A"&&e[t+5]==="T"&&e[t+6]==="A"&&e[t+7]==="["){for(t+=8;t<e.length;t++)if(e[t]==="]"&&e[t+1]==="]"&&e[t+2]===">"){t+=2;break}}return t}const Ws='"',Zs="'";function Qs(e,t){let n="",r="",s=!1;for(;t<e.length;t++){if(e[t]===Ws||e[t]===Zs)r===""?r=e[t]:r!==e[t]||(r="");else if(e[t]===">"&&r===""){s=!0;break}n+=e[t]}return r!==""?!1:{value:n,index:t,tagClosed:s}}const Hs=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function cn(e,t){const n=Kn(e,Hs),r={};for(let s=0;s<n.length;s++){if(n[s][1].length===0)return I("InvalidAttr","Attribute '"+n[s][2]+"' has no space in starting.",we(n[s]));if(n[s][3]!==void 0&&n[s][4]===void 0)return I("InvalidAttr","Attribute '"+n[s][2]+"' is without value.",we(n[s]));if(n[s][3]===void 0&&!t.allowBooleanAttributes)return I("InvalidAttr","boolean attribute '"+n[s][2]+"' is not allowed.",we(n[s]));const o=n[s][2];if(!Ds(o))return I("InvalidAttr","Attribute '"+o+"' is an invalid name.",we(n[s]));if(!r.hasOwnProperty(o))r[o]=1;else return I("InvalidAttr","Attribute '"+o+"' is repeated.",we(n[s]))}return!0}function Ks(e,t){let n=/\d/;for(e[t]==="x"&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(e[t]===";")return t;if(!e[t].match(n))break}return-1}function Js(e,t){if(t++,e[t]===";")return-1;if(e[t]==="#")return t++,Ks(e,t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(e[t]===";")break;return-1}return t}function I(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function Ds(e){return ot(e)}function eo(e){return ot(e)}function $(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function we(e){return e.startIndex+e[1].length}const to={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e},captureMetaData:!1},no=function(e){return Object.assign({},to,e)};let Ke;typeof Symbol!="function"?Ke="@@xmlMetadata":Ke=Symbol("XML Node Metadata");class ne{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,n){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:n})}addChild(t,n){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child}),n!==void 0&&(this.child[this.child.length-1][Ke]={startIndex:n})}static getMetaDataSymbol(){return Ke}}class ro{constructor(t){this.suppressValidationErr=!t}readDocType(t,n){const r={};if(t[n+3]==="O"&&t[n+4]==="C"&&t[n+5]==="T"&&t[n+6]==="Y"&&t[n+7]==="P"&&t[n+8]==="E"){n=n+9;let s=1,o=!1,i=!1,a="";for(;n<t.length;n++)if(t[n]==="<"&&!i){if(o&&te(t,"!ENTITY",n)){n+=7;let u,c;[u,c,n]=this.readEntityExp(t,n+1,this.suppressValidationErr),c.indexOf("&")===-1&&(r[u]={regx:RegExp(`&${u};`,"g"),val:c})}else if(o&&te(t,"!ELEMENT",n)){n+=8;const{index:u}=this.readElementExp(t,n+1);n=u}else if(o&&te(t,"!ATTLIST",n))n+=8;else if(o&&te(t,"!NOTATION",n)){n+=9;const{index:u}=this.readNotationExp(t,n+1,this.suppressValidationErr);n=u}else if(te(t,"!--",n))i=!0;else throw new Error("Invalid DOCTYPE");s++,a=""}else if(t[n]===">"){if(i?t[n-1]==="-"&&t[n-2]==="-"&&(i=!1,s--):s--,s===0)break}else t[n]==="["?o=!0:a+=t[n];if(s!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:n}}readEntityExp(t,n){n=k(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n])&&t[n]!=='"'&&t[n]!=="'";)r+=t[n],n++;if(be(r),n=k(t,n),!this.suppressValidationErr){if(t.substring(n,n+6).toUpperCase()==="SYSTEM")throw new Error("External entities are not supported");if(t[n]==="%")throw new Error("Parameter entities are not supported")}let s="";return[n,s]=this.readIdentifierVal(t,n,"entity"),n--,[r,s,n]}readNotationExp(t,n){n=k(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n]);)r+=t[n],n++;!this.suppressValidationErr&&be(r),n=k(t,n);const s=t.substring(n,n+6).toUpperCase();if(!this.suppressValidationErr&&s!=="SYSTEM"&&s!=="PUBLIC")throw new Error(`Expected SYSTEM or PUBLIC, found "${s}"`);n+=s.length,n=k(t,n);let o=null,i=null;if(s==="PUBLIC")[n,o]=this.readIdentifierVal(t,n,"publicIdentifier"),n=k(t,n),(t[n]==='"'||t[n]==="'")&&([n,i]=this.readIdentifierVal(t,n,"systemIdentifier"));else if(s==="SYSTEM"&&([n,i]=this.readIdentifierVal(t,n,"systemIdentifier"),!this.suppressValidationErr&&!i))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:r,publicIdentifier:o,systemIdentifier:i,index:--n}}readIdentifierVal(t,n,r){let s="";const o=t[n];if(o!=='"'&&o!=="'")throw new Error(`Expected quoted string, found "${o}"`);for(n++;n<t.length&&t[n]!==o;)s+=t[n],n++;if(t[n]!==o)throw new Error(`Unterminated ${r} value`);return n++,[n,s]}readElementExp(t,n){n=k(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n]);)r+=t[n],n++;if(!this.suppressValidationErr&&!ot(r))throw new Error(`Invalid element name: "${r}"`);n=k(t,n);let s="";if(t[n]==="E"&&te(t,"MPTY",n))n+=4;else if(t[n]==="A"&&te(t,"NY",n))n+=2;else if(t[n]==="("){for(n++;n<t.length&&t[n]!==")";)s+=t[n],n++;if(t[n]!==")")throw new Error("Unterminated content model")}else if(!this.suppressValidationErr)throw new Error(`Invalid Element Expression, found "${t[n]}"`);return{elementName:r,contentModel:s.trim(),index:n}}readAttlistExp(t,n){n=k(t,n);let r="";for(;n<t.length&&!/\s/.test(t[n]);)r+=t[n],n++;be(r),n=k(t,n);let s="";for(;n<t.length&&!/\s/.test(t[n]);)s+=t[n],n++;if(!be(s))throw new Error(`Invalid attribute name: "${s}"`);n=k(t,n);let o="";if(t.substring(n,n+8).toUpperCase()==="NOTATION"){if(o="NOTATION",n+=8,n=k(t,n),t[n]!=="(")throw new Error(`Expected '(', found "${t[n]}"`);n++;let a=[];for(;n<t.length&&t[n]!==")";){let u="";for(;n<t.length&&t[n]!=="|"&&t[n]!==")";)u+=t[n],n++;if(u=u.trim(),!be(u))throw new Error(`Invalid notation name: "${u}"`);a.push(u),t[n]==="|"&&(n++,n=k(t,n))}if(t[n]!==")")throw new Error("Unterminated list of notations");n++,o+=" ("+a.join("|")+")"}else{for(;n<t.length&&!/\s/.test(t[n]);)o+=t[n],n++;const a=["CDATA","ID","IDREF","IDREFS","ENTITY","ENTITIES","NMTOKEN","NMTOKENS"];if(!this.suppressValidationErr&&!a.includes(o.toUpperCase()))throw new Error(`Invalid attribute type: "${o}"`)}n=k(t,n);let i="";return t.substring(n,n+8).toUpperCase()==="#REQUIRED"?(i="#REQUIRED",n+=8):t.substring(n,n+7).toUpperCase()==="#IMPLIED"?(i="#IMPLIED",n+=7):[n,i]=this.readIdentifierVal(t,n,"ATTLIST"),{elementName:r,attributeName:s,attributeType:o,defaultValue:i,index:n}}}const k=(e,t)=>{for(;t<e.length&&/\s/.test(e[t]);)t++;return t};function te(e,t,n){for(let r=0;r<t.length;r++)if(t[r]!==e[n+r+1])return!1;return!0}function be(e){if(ot(e))return e;throw new Error(`Invalid entity name ${e}`)}const so=/^[-+]?0x[a-fA-F0-9]+$/,oo=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,io={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function ao(e,t={}){if(t=Object.assign({},io,t),!e||typeof e!="string")return e;let n=e.trim();if(t.skipLike!==void 0&&t.skipLike.test(n))return e;if(e==="0")return 0;if(t.hex&&so.test(n))return fo(n,16);if(n.includes("e")||n.includes("E"))return co(e,n,t);{const r=oo.exec(n);if(r){const s=r[1]||"",o=r[2];let i=lo(r[3]);const a=s?e[o.length+1]===".":e[o.length]===".";if(!t.leadingZeros&&(o.length>1||o.length===1&&!a))return e;{const u=Number(n),c=String(u);if(u===0)return u;if(c.search(/[eE]/)!==-1)return t.eNotation?u:e;if(n.indexOf(".")!==-1)return c==="0"||c===i||c===`${s}${i}`?u:e;let l=o?i:n;return o?l===c||s+l===c?u:e:l===c||l===s+c?u:e}}else return e}}const uo=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;function co(e,t,n){if(!n.eNotation)return e;const r=t.match(uo);if(r){let s=r[1]||"";const o=r[3].indexOf("e")===-1?"E":"e",i=r[2],a=s?e[i.length+1]===o:e[i.length]===o;return i.length>1&&a?e:i.length===1&&(r[3].startsWith(`.${o}`)||r[3][0]===o)?Number(t):n.leadingZeros&&!a?(t=(r[1]||"")+r[3],Number(t)):e}else return e}function lo(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substring(0,e.length-1))),e}function fo(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}function po(e){return typeof e=="function"?e:Array.isArray(e)?t=>{for(const n of e)if(typeof n=="string"&&t===n||n instanceof RegExp&&n.test(t))return!0}:()=>!1}class ho{constructor(t){if(this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(n,r)=>String.fromCodePoint(Number.parseInt(r,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(n,r)=>String.fromCodePoint(Number.parseInt(r,16))}},this.addExternalEntities=go,this.parseXml=vo,this.parseTextData=mo,this.resolveNameSpace=yo,this.buildAttributesMap=bo,this.isItStopNode=To,this.replaceEntitiesValue=No,this.readStopNodeData=xo,this.saveTextToParentTag=_o,this.addChild=Eo,this.ignoreAttributesFn=po(this.options.ignoreAttributes),this.options.stopNodes&&this.options.stopNodes.length>0){this.stopNodesExact=new Set,this.stopNodesWildcard=new Set;for(let n=0;n<this.options.stopNodes.length;n++){const r=this.options.stopNodes[n];typeof r=="string"&&(r.startsWith("*.")?this.stopNodesWildcard.add(r.substring(2)):this.stopNodesExact.add(r))}}}}function go(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function mo(e,t,n,r,s,o,i){if(e!==void 0&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){i||(e=this.replaceEntitiesValue(e));const a=this.options.tagValueProcessor(t,e,n,s,o);return a==null?e:typeof a!=typeof e||a!==e?a:this.options.trimValues?It(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?It(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function yo(e){if(this.options.removeNSPrefix){const t=e.split(":"),n=e.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(e=n+t[1])}return e}const wo=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function bo(e,t){if(this.options.ignoreAttributes!==!0&&typeof e=="string"){const n=Kn(e,wo),r=n.length,s={};for(let o=0;o<r;o++){const i=this.resolveNameSpace(n[o][1]);if(this.ignoreAttributesFn(i,t))continue;let a=n[o][4],u=this.options.attributeNamePrefix+i;if(i.length)if(this.options.transformAttributeName&&(u=this.options.transformAttributeName(u)),u==="__proto__"&&(u="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const c=this.options.attributeValueProcessor(i,a,t);c==null?s[u]=a:typeof c!=typeof a||c!==a?s[u]=c:s[u]=It(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(s[u]=!0)}if(!Object.keys(s).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=s,o}return s}}const vo=function(e){e=e.replace(/\r\n?/g,`
`);const t=new ne("!xml");let n=t,r="",s="";const o=new ro(this.options.processEntities);for(let i=0;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="/"){const u=re(e,">",i,"Closing Tag is not closed.");let c=e.substring(i+2,u).trim();if(this.options.removeNSPrefix){const d=c.indexOf(":");d!==-1&&(c=c.substr(d+1))}this.options.transformTagName&&(c=this.options.transformTagName(c)),n&&(r=this.saveTextToParentTag(r,n,s));const l=s.substring(s.lastIndexOf(".")+1);if(c&&this.options.unpairedTags.indexOf(c)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${c}>`);let f=0;l&&this.options.unpairedTags.indexOf(l)!==-1?(f=s.lastIndexOf(".",s.lastIndexOf(".")-1),this.tagsNodeStack.pop()):f=s.lastIndexOf("."),s=s.substring(0,f),n=this.tagsNodeStack.pop(),r="",i=u}else if(e[i+1]==="?"){let u=xt(e,i,!1,"?>");if(!u)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,s),!(this.options.ignoreDeclaration&&u.tagName==="?xml"||this.options.ignorePiTags)){const c=new ne(u.tagName);c.add(this.options.textNodeName,""),u.tagName!==u.tagExp&&u.attrExpPresent&&(c[":@"]=this.buildAttributesMap(u.tagExp,s)),this.addChild(n,c,s,i)}i=u.closeIndex+1}else if(e.substr(i+1,3)==="!--"){const u=re(e,"-->",i+4,"Comment is not closed.");if(this.options.commentPropName){const c=e.substring(i+4,u-2);r=this.saveTextToParentTag(r,n,s),n.add(this.options.commentPropName,[{[this.options.textNodeName]:c}])}i=u}else if(e.substr(i+1,2)==="!D"){const u=o.readDocType(e,i);this.docTypeEntities=u.entities,i=u.i}else if(e.substr(i+1,2)==="!["){const u=re(e,"]]>",i,"CDATA is not closed.")-2,c=e.substring(i+9,u);r=this.saveTextToParentTag(r,n,s);let l=this.parseTextData(c,n.tagname,s,!0,!1,!0,!0);l==null&&(l=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:c}]):n.add(this.options.textNodeName,l),i=u+2}else{let u=xt(e,i,this.options.removeNSPrefix),c=u.tagName;const l=u.rawTagName;let f=u.tagExp,d=u.attrExpPresent,p=u.closeIndex;if(this.options.transformTagName){const m=this.options.transformTagName(c);f===c&&(f=m),c=m}n&&r&&n.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,n,s,!1));const h=n;h&&this.options.unpairedTags.indexOf(h.tagname)!==-1&&(n=this.tagsNodeStack.pop(),s=s.substring(0,s.lastIndexOf("."))),c!==t.tagname&&(s+=s?"."+c:c);const g=i;if(this.isItStopNode(this.stopNodesExact,this.stopNodesWildcard,s,c)){let m="";if(f.length>0&&f.lastIndexOf("/")===f.length-1)c[c.length-1]==="/"?(c=c.substr(0,c.length-1),s=s.substr(0,s.length-1),f=c):f=f.substr(0,f.length-1),i=u.closeIndex;else if(this.options.unpairedTags.indexOf(c)!==-1)i=u.closeIndex;else{const E=this.readStopNodeData(e,l,p+1);if(!E)throw new Error(`Unexpected end of ${l}`);i=E.i,m=E.tagContent}const M=new ne(c);c!==f&&d&&(M[":@"]=this.buildAttributesMap(f,s)),m&&(m=this.parseTextData(m,c,s,!0,d,!0,!0)),s=s.substr(0,s.lastIndexOf(".")),M.add(this.options.textNodeName,m),this.addChild(n,M,s,g)}else{if(f.length>0&&f.lastIndexOf("/")===f.length-1){if(c[c.length-1]==="/"?(c=c.substr(0,c.length-1),s=s.substr(0,s.length-1),f=c):f=f.substr(0,f.length-1),this.options.transformTagName){const M=this.options.transformTagName(c);f===c&&(f=M),c=M}const m=new ne(c);c!==f&&d&&(m[":@"]=this.buildAttributesMap(f,s)),this.addChild(n,m,s,g),s=s.substr(0,s.lastIndexOf("."))}else{const m=new ne(c);this.tagsNodeStack.push(n),c!==f&&d&&(m[":@"]=this.buildAttributesMap(f,s)),this.addChild(n,m,s,g),n=m}r="",i=p}}else r+=e[i];return t.child};function Eo(e,t,n,r){this.options.captureMetaData||(r=void 0);const s=this.options.updateTag(t.tagname,n,t[":@"]);s===!1||(typeof s=="string"&&(t.tagname=s),e.addChild(t,r))}const No=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function _o(e,t,n,r){return e&&(r===void 0&&(r=t.child.length===0),e=this.parseTextData(e,t.tagname,n,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,r),e!==void 0&&e!==""&&t.add(this.options.textNodeName,e),e=""),e}function To(e,t,n,r){return!!(t&&t.has(r)||e&&e.has(n))}function Mo(e,t,n=">"){let r,s="";for(let o=t;o<e.length;o++){let i=e[o];if(r)i===r&&(r="");else if(i==='"'||i==="'")r=i;else if(i===n[0])if(n[1]){if(e[o+1]===n[1])return{data:s,index:o}}else return{data:s,index:o};else i==="	"&&(i=" ");s+=i}}function re(e,t,n,r){const s=e.indexOf(t,n);if(s===-1)throw new Error(r);return s+t.length-1}function xt(e,t,n,r=">"){const s=Mo(e,t+1,r);if(!s)return;let o=s.data;const i=s.index,a=o.search(/\s/);let u=o,c=!0;a!==-1&&(u=o.substring(0,a),o=o.substring(a+1).trimStart());const l=u;if(n){const f=u.indexOf(":");f!==-1&&(u=u.substr(f+1),c=u!==s.data.substr(f+1))}return{tagName:u,tagExp:o,closeIndex:i,attrExpPresent:c,rawTagName:l}}function xo(e,t,n){const r=n;let s=1;for(;n<e.length;n++)if(e[n]==="<")if(e[n+1]==="/"){const o=re(e,">",n,`${t} is not closed`);if(e.substring(n+2,o).trim()===t&&(s--,s===0))return{tagContent:e.substring(r,n),i:o};n=o}else if(e[n+1]==="?")n=re(e,"?>",n+1,"StopNode is not closed.");else if(e.substr(n+1,3)==="!--")n=re(e,"-->",n+3,"StopNode is not closed.");else if(e.substr(n+1,2)==="![")n=re(e,"]]>",n,"StopNode is not closed.")-2;else{const o=xt(e,n,">");o&&((o&&o.tagName)===t&&o.tagExp[o.tagExp.length-1]!=="/"&&s++,n=o.closeIndex)}}function It(e,t,n){if(t&&typeof e=="string"){const r=e.trim();return r==="true"?!0:r==="false"?!1:ao(e,n)}else return Ys(e)?e:""}const dt=ne.getMetaDataSymbol();function Io(e,t){return Jn(e,t)}function Jn(e,t,n){let r;const s={};for(let o=0;o<e.length;o++){const i=e[o],a=So(i);let u="";if(n===void 0?u=a:u=n+"."+a,a===t.textNodeName)r===void 0?r=i[a]:r+=""+i[a];else{if(a===void 0)continue;if(i[a]){let c=Jn(i[a],t,u);const l=Co(c,t);i[dt]!==void 0&&(c[dt]=i[dt]),i[":@"]?Po(c,i[":@"],u,t):Object.keys(c).length===1&&c[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?c=c[t.textNodeName]:Object.keys(c).length===0&&(t.alwaysCreateTextNode?c[t.textNodeName]="":c=""),s[a]!==void 0&&s.hasOwnProperty(a)?(Array.isArray(s[a])||(s[a]=[s[a]]),s[a].push(c)):t.isArray(a,u,l)?s[a]=[c]:s[a]=c}}}return typeof r=="string"?r.length>0&&(s[t.textNodeName]=r):r!==void 0&&(s[t.textNodeName]=r),s}function So(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(r!==":@")return r}}function Po(e,t,n,r){if(t){const s=Object.keys(t),o=s.length;for(let i=0;i<o;i++){const a=s[i];r.isArray(a,n+"."+a,!0,!0)?e[a]=[t[a]]:e[a]=t[a]}}}function Co(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return!!(r===0||r===1&&(e[n]||typeof e[n]=="boolean"||e[n]===0))}class Ao{constructor(t){this.externalEntities={},this.options=no(t)}parse(t,n){if(typeof t!="string"&&t.toString)t=t.toString();else if(typeof t!="string")throw new Error("XML data is accepted in String or Bytes[] form.");if(n){n===!0&&(n={});const o=js(t,n);if(o!==!0)throw Error(`${o.err.msg}:${o.err.line}:${o.err.col}`)}const r=new ho(this.options);r.addExternalEntities(this.externalEntities);const s=r.parseXml(t);return this.options.preserveOrder||s===void 0?s:Io(s,this.options)}addEntity(t,n){if(n.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(n==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=n}static getMetaDataSymbol(){return ne.getMetaDataSymbol()}}function Oo(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const n=[];for(let r=0;r<=t.length;r++)n[r]=[r];for(let r=0;r<=e.length;r++)n[0][r]=r;for(let r=1;r<=t.length;r++)for(let s=1;s<=e.length;s++){const o=e[s-1]===t[r-1]?0:1;n[r][s]=Math.min(n[r-1][s]+1,n[r][s-1]+1,n[r-1][s-1]+o)}return n[t.length][e.length]}function Ro(e,t){const n=oe(e);let r=null,s=1/0;for(const o of t){const i=oe(o);if(n===i||n.endsWith(i)||n.endsWith("-"+i))return o;const a=Oo(n,i),u=Math.max(n.length,i.length),c=Math.ceil(u*.5);a<s&&a<=c&&(s=a,r=o)}return r}function Dn(e){const t=[],n=[],r=new Ao({ignoreAttributes:!1,attributeNamePrefix:"",preserveOrder:!0,trimValues:!0,allowBooleanAttributes:!0});let s;try{s=r.parse(e,{allowBooleanAttributes:!0})}catch(a){return{entities:[],errors:[{message:`xml parse error: ${a.message}`}],warnings:[]}}const o=er(s),i=[];for(const a of o)if(a.tag==="scene")for(const u of a.children){const c=St(u,t,n);c&&i.push(c)}else if(a.tag==="a"){const u=St(a,t,n);u&&i.push(u)}else(a.tag.toLowerCase()==="scene"||a.tag.toLowerCase()==="world")&&t.push({message:`Invalid tag "${a.tag}". Use lowercase <scene>`});return{entities:i,errors:t,warnings:n}}function Fo(e){return e.startsWith("@")&&e.length>1}function St(e,t,n){if(e.tag!=="a")return e.tag.toLowerCase()==="a"&&t.push({message:`Invalid tag "${e.tag}". Use lowercase <a>`}),null;const r=[],s=[],o=[],i=[];let a;for(const[u,c]of Object.entries(e.attrs)){if(u==="id"){a=c;continue}if(typeof c=="string"&&Fo(c)){o.push({attrName:u,targetName:c.slice(1)});continue}const l=Wn(u);if(l){const f={};typeof c=="string"&&c!==""&&(f._value=c),r.push({def:l,attrs:f});continue}typeof c=="string"&&c!==""&&i.push({name:u,value:c})}for(const{name:u,value:c}of i){const l=Xt(u);let f=!1;for(const d of r){const p=d.def.component;(l in p||`${l}X`in p)&&(f=!0,d.attrs._value||(d.attrs[u]=c))}if(!f){const d=a?` (${a})`:"";n.push(`shorthand "${u}" matches no declared component${d}`)}}for(const u of e.children)if(u.tag==="a"){const c=St(u,t,n);c&&s.push(c)}else u.tag.toLowerCase()==="a"?t.push({message:`Invalid tag "${u.tag}". Use lowercase <a>`}):t.push({message:`Only <a> children allowed, found <${u.tag}>`});return{id:a,components:r,children:s,entityRefs:o}}function er(e){if(!Array.isArray(e))return[];const t=[];for(const n of e)if(!(typeof n!="object"||n===null))for(const[r,s]of Object.entries(n)){if(r===":@")continue;const o=n[":@"]??{},i={};for(const[u,c]of Object.entries(o))typeof c=="string"?i[u]=c:(c===!0||c==="")&&(i[u]="");const a=er(s);t.push({tag:r,attrs:i,children:a})}return t}const tr=[];function Gt(e){tr.push(e)}class $o{nameToEntity=new Map;_currentEid=0;get currentEid(){return this._currentEid}setCurrentEid(t){this._currentEid=t}getEntityByName(t){return this.nameToEntity.get(t)??null}setName(t,n){this.nameToEntity.set(t,n)}getEntityMap(){return new Map(this.nameToEntity)}}function nr(e,t){const n=Dn(t);return Bo(e,n.entities,n.errors)}async function qo(e,t,n){const r=await n(t);return nr(e,r)}function Bo(e,t,n){const r=new $o,s=[...n],o=[],i=[];for(const a of t){const u=rr(e,a,r,void 0,o);i.push(u)}for(const{def:a,eid:u,parent:c}of o){c!==void 0&&he(e.world,u,B(X.relation,c));for(const l of a.entityRefs)ko(e,u,l,r,s);for(const l of a.components)Vo(e,u,l,r,s)}for(const a of tr)a(e,r);return{entities:r.getEntityMap(),roots:i,errors:s}}function rr(e,t,n,r,s){const o=e.addEntity();t.id&&n.setName(t.id,o),s.push({def:t,eid:o,parent:r});for(const i of t.children)rr(e,i,n,o,s);return o}function ko(e,t,n,r,s){const o=ks(n.attrName);if(!o){s.push({message:`Unknown relation: "${n.attrName}"`});return}const i=r.getEntityByName(n.targetName);if(i===null){s.push({message:`Unknown entity: "@${n.targetName}"`});return}e.addRelation(t,o,i)}function Vo(e,t,n,r,s){const{def:o,attrs:i}=n,{component:a,name:u,traits:c}=o;e.addComponent(t,a);const l=c?.defaults?.()??{};for(const[d,p]of Object.entries(l))ln(a,d,t,p);let f;if(r.setCurrentEid(t),c?.adapter)f=c.adapter(i,e,r);else{const d=Lo(o,i);f=d.values;for(const p of d.errors)s.push({message:`<${u}> ${p}`})}for(const[d,p]of Object.entries(f))ln(a,d,t,p)}function Lo(e,t){const n={},r=[];if(t._value&&fn(t._value)){const s=pt(e.name,t._value,e.component);Object.assign(n,s.values),r.push(...s.errors)}for(const[s,o]of Object.entries(t))if(s!=="_value"&&o)if(fn(o)){const i=pt(e.name,o,e.component);Object.assign(n,i.values),r.push(...i.errors)}else{const i=pt(e.name,`${s}: ${o}`,e.component);Object.assign(n,i.values),r.push(...i.errors)}return{values:n,errors:r}}function ln(e,t,n,r){const s=e[t];s!=null&&(ArrayBuffer.isView(s)||Array.isArray(s))&&(s[n]=r)}function sr(e,t){return`${t}X`in e&&`${t}Y`in e}function or(e,t){return sr(e,t)&&`${t}Z`in e}function Uo(e,t){return or(e,t)&&`${t}W`in e}function zo(e){if(e=e.trim(),e.startsWith("0x")||e.startsWith("0X"))return parseInt(e,16);if(e.startsWith("#"))return parseInt(e.slice(1),16);if(e==="true")return 1;if(e==="false")return 0;const t=parseFloat(e);return isNaN(t)?null:t}function Xo(e){const t=[],n=e.trim();let r=0;for(let s=0;s<=n.length;s++){const o=s<n.length&&/\s/.test(n[s]),i=s===n.length;(o||i)&&(r<s&&t.push(zo(n.slice(r,s))),r=s+1)}return t}function Yo(e){const t=[];let n=0;for(let r=0;r<=e.length;r++)if(r===e.length||e[r]===";"){const s=e.slice(n,r).trim();s&&t.push(s),n=r+1}return t}function pt(e,t,n){const r={},s=[],o=Yo(t);for(const i of o){const a=i.indexOf(":");if(a===-1){s.push(`Invalid syntax: "${i}" (expected "field: value")`);continue}const u=i.slice(0,a).trim(),c=i.slice(a+1).trim();if(!u||!c){s.push(`Invalid syntax: "${i}" (empty field or value)`);continue}const l=Xt(u),f=Xo(c);if(f.some(g=>g===null)){s.push(`Invalid number in "${i}"`);continue}const d=f;if(Uo(n,l)){d.length===4?(r[`${l}X`]=d[0],r[`${l}Y`]=d[1],r[`${l}Z`]=d[2],r[`${l}W`]=d[3]):d.length===1?(r[`${l}X`]=d[0],r[`${l}Y`]=d[0],r[`${l}Z`]=d[0],r[`${l}W`]=d[0]):s.push(`${e}.${u}: expected 1 or 4 values, got ${d.length}`);continue}if(or(n,l)){d.length===3?(r[`${l}X`]=d[0],r[`${l}Y`]=d[1],r[`${l}Z`]=d[2]):d.length===1?(r[`${l}X`]=d[0],r[`${l}Y`]=d[0],r[`${l}Z`]=d[0]):s.push(`${e}.${u}: expected 1 or 3 values, got ${d.length}`);continue}if(sr(n,l)){d.length===2?(r[`${l}X`]=d[0],r[`${l}Y`]=d[1]):d.length===1?(r[`${l}X`]=d[0],r[`${l}Y`]=d[0]):s.push(`${e}.${u}: expected 1 or 2 values, got ${d.length}`);continue}if(l in n){d.length===1?r[l]=d[0]:s.push(`${e}.${u}: expected 1 value, got ${d.length}`);continue}const p=Object.keys(n),h=Ro(u,p);h?s.push(`${e}: unknown field "${u}", did you mean "${oe(h)}"?`):s.push(`${e}: unknown field "${u}"`)}return{values:r,errors:s}}function fn(e){return e.includes(":")&&(e.includes(";")||/^[\w-]+\s*:/.test(e))}const Go=Object.freeze(Object.defineProperty({__proto__:null,loadScene:nr,loadSceneFile:qo,parseXml:Dn,registerPostLoadHook:Gt},Symbol.toStringTag,{value:"Module"})),Pt=["opaque","transparent","postprocess"];function jo(e){const t=e.map(i=>({id:i.id,phase:i.phase??"opaque",inputs:i.inputs,outputs:i.outputs})),n=new Map;for(const i of e)for(const a of i.outputs)n.set(a.id,i.id);const r=[];for(const i of e)for(const a of i.inputs){const u=n.get(a.id);u&&r.push({from:u,to:i.id,resource:a.id})}const s=new Map;for(const i of Pt)s.set(i,[]);for(const i of t)s.get(i.phase).push(i.id);const o=Wo(e);return{nodes:t,edges:r,executionOrder:o,byPhase:s}}function Wo(e){if(e.length===0)return[];const t=new Map;for(const i of e)for(const a of i.outputs)t.set(a.id,i);const n=new Map,r=new Map;for(const i of e)n.set(i,[]),r.set(i,0);for(const i of e)for(const a of i.inputs){const u=t.get(a.id);u&&(n.get(u).push(i),r.set(i,r.get(i)+1))}const s=new Map;for(const i of Pt)s.set(i,[]);for(const i of e){const a=i.phase??"opaque";s.get(a).push(i)}const o=[];for(const i of Pt){const a=s.get(i),u=new Map;for(const f of a){let d=0;for(const p of f.inputs){const h=t.get(p.id);h&&a.includes(h)&&d++}u.set(f,d)}const c=[];for(const f of a)u.get(f)===0&&c.push(f);let l=0;for(;l<c.length;){const f=c[l++];o.push(f.id);for(const d of a)for(const p of d.inputs)if(t.get(p.id)===f){const g=u.get(d)-1;u.set(d,g),g===0&&c.push(d)}}}return o}const dn=["opaque","transparent","postprocess"];function Zo(e){const t=[],n=new Map;for(const r of e)for(const s of r.outputs)n.set(s.id,r);for(const r of e)for(const s of r.inputs){const o=n.get(s.id);o&&t.push([o,r])}return t}function Qo(e){if(e.length===0)return[];const t=Zo(e),n=new Map,r=new Map;for(const a of e)n.set(a,[]),r.set(a,0);for(const[a,u]of t)n.get(a).push(u),r.set(u,r.get(u)+1);const s=[];for(const a of e)r.get(a)===0&&s.push(a);const o=[];let i=0;for(;i<s.length;){const a=s[i++];o.push(a);for(const u of n.get(a)){const c=r.get(u)-1;r.set(u,c),c===0&&s.push(u)}}if(o.length!==e.length)throw new zn;return o}function Ho(e){if(e.length===0)return{sorted:[]};const t=new Map;for(const r of dn)t.set(r,[]);for(const r of e){const s=r.phase??"opaque";t.get(s).push(r)}const n=[];for(const r of dn){const s=t.get(r);n.push(...Qo(s))}return{sorted:n}}class Ko{nodes=new Map;_plan=null;add(t){if(this.nodes.has(t.id))throw new Error(`Node '${t.id}' already exists`);this.nodes.set(t.id,t),this._plan=null}set(t,n){if(n.id!==t)throw new Error(`Node id '${n.id}' must match slot id '${t}'`);this.nodes.set(t,n),this._plan=null}remove(t){const n=this.nodes.delete(t);return n&&(this._plan=null),n}compile(){return this._plan||(this._plan=Ho(Array.from(this.nodes.values()))),this._plan}inspect(){return jo(Array.from(this.nodes.values()))}}function Jo(){const e=new Map;return{nodeTimings:e,beginNode(t){e.set(t,{start:performance.now(),end:0})},endNode(t){const n=e.get(t);n&&(n.end=performance.now())},finish(t){const n=[];let r=0;for(const[s,o]of e){const i=o.end-o.start;r+=i,n.push({nodeId:s,cpuMs:i})}return{frameIndex:t,nodes:n,totalCpuMs:r}}}}const pn=1;function hn(e){const t=window.devicePixelRatio||1,n=e.getBoundingClientRect(),r=Math.max(pn,Math.floor(n.width*t)),s=Math.max(pn,Math.floor(n.height*t));(e.width!==r||e.height!==s)&&(e.width=r,e.height=s)}let ke=null,ue=null;function Do(e,t){return e.createBuffer({label:"entityIds",size:t*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC})}async function ei(){if(!navigator.gpu)throw new Error("WebGPU not supported");const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("No GPU adapter found");const t=e.limits.maxTextureDimension2D;return e.requestDevice({requiredLimits:{maxTextureDimension2D:t}})}const it=D("compute"),ti={group:"draw",setup(e){e.canvas&&(ue=e.canvas,hn(ue),ke=new ResizeObserver(()=>{ue&&hn(ue)}),ke.observe(ue))},update(e){const t=it.from(e);if(!t)return;const{device:n,context:r,format:s,graph:o,resources:i}=t,a=o.compile();if(a.sorted.length===0)return;const c=r.getCurrentTexture().createView(),l=n.createCommandEncoder(),f={device:n,queue:n.queue,encoder:l,context:r,format:s,canvasView:c,getTexture(p){return i.textures.get(p)??null},getTextureView(p){return i.textureViews.get(p)??null},getBuffer(p){return i.buffers.get(p)??null},setTexture(p,h){i.textures.set(p,h)},setTextureView(p,h){i.textureViews.set(p,h)},setBuffer(p,h){i.buffers.set(p,h)}},d=Jo();for(const p of a.sorted)d.beginNode(p.id),p.execute(f),d.endNode(p.id);n.queue.submit([l.finish()]),t.lastFrameTiming=d.finish(t.frameIndex),t.frameIndex++},dispose(){ke?.disconnect(),ke=null,ue=null}},ir={systems:[ti],async initialize(e){if(!e.canvas)throw new Error("ComputePlugin requires a canvas");const t=await ei(),n=e.canvas.getContext("webgpu");if(!n)throw new Error("Failed to get WebGPU context");const r=navigator.gpu.getPreferredCanvasFormat();n.configure({device:t,format:r,alphaMode:"premultiplied"});const s=new Ko,o={textures:new Map,textureViews:new Map,buffers:new Map};e.setResource(it,{device:t,context:n,format:r,graph:s,resources:o,lastFrameTiming:null,frameIndex:0})}},Ct=D("input"),Ce=new Set,at=new Set,ut=new Set,A={deltaX:0,deltaY:0,scrollDelta:0,left:!1,right:!1,middle:!1},ni={mouse:A,isKeyDown:e=>Ce.has(e),isKeyPressed:e=>at.has(e),isKeyReleased:e=>ut.has(e)};let q=null,Ae=0,Oe=0,ie=null,Me=null;function gn(e){Ce.has(e.code)||at.add(e.code),Ce.add(e.code)}function mn(e){Ce.delete(e.code),ut.add(e.code)}function ar(e,t){e===0&&(A.left=t),e===1&&(A.middle=t),e===2&&(A.right=t)}function ur(){Me!==null&&ar(Me,!1),ie=null,Me=null,Ae=0,Oe=0}function yn(e){e.target===q&&ie===null&&(ie=e.pointerId,Me=e.button,Ae=e.clientX,Oe=e.clientY,ar(e.button,!0),q.setPointerCapture(e.pointerId),e.preventDefault())}function wn(e){e.pointerId===ie&&(q?.releasePointerCapture(e.pointerId),ur())}function bn(e){e.pointerId===ie&&ur()}function vn(e){e.pointerId===ie&&(e.preventDefault(),A.deltaX+=e.clientX-Ae,A.deltaY+=e.clientY-Oe,Ae=e.clientX,Oe=e.clientY)}function En(e){e.target===q&&(A.scrollDelta+=e.deltaY,e.preventDefault())}function Nn(e){e.target===q&&e.preventDefault()}function ri(){at.clear(),ut.clear(),A.deltaX=0,A.deltaY=0,A.scrollDelta=0}function si(){Ce.clear(),at.clear(),ut.clear(),A.deltaX=0,A.deltaY=0,A.scrollDelta=0,A.left=!1,A.right=!1,A.middle=!1,ie=null,Me=null,Ae=0,Oe=0}const oi={group:"simulation",setup(e){e.canvas&&(q=e.canvas,q.style.touchAction="none",window.addEventListener("keydown",gn),window.addEventListener("keyup",mn),q.addEventListener("pointerdown",yn),window.addEventListener("pointerup",wn),window.addEventListener("pointercancel",bn),window.addEventListener("pointermove",vn),q.addEventListener("wheel",En,{passive:!1}),q.addEventListener("contextmenu",Nn),e.setResource(Ct,ni))},dispose(e){q&&(window.removeEventListener("keydown",gn),window.removeEventListener("keyup",mn),q.removeEventListener("pointerdown",yn),window.removeEventListener("pointerup",wn),window.removeEventListener("pointercancel",bn),window.removeEventListener("pointermove",vn),q.removeEventListener("wheel",En),q.removeEventListener("contextmenu",Nn),q=null),si(),e.deleteResource(Ct)}},ii={group:"draw",last:!0,update(){ri()}},cr={systems:[oi,ii]},lr=e=>e,ai=e=>e*e,ui=e=>e*(2-e),ci=e=>e<.5?2*e*e:-1+(4-2*e)*e,li=e=>e*e*e,fi=e=>--e*e*e+1,di=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,pi=e=>e*e*e*e,hi=e=>1- --e*e*e*e,gi=e=>e<.5?8*e*e*e*e:1-8*--e*e*e*e,mi=e=>e*e*e*e*e,yi=e=>1+--e*e*e*e*e,wi=e=>e<.5?16*e*e*e*e*e:1+16*--e*e*e*e*e,bi=e=>1-Math.cos(e*Math.PI/2),vi=e=>Math.sin(e*Math.PI/2),Ei=e=>-(Math.cos(Math.PI*e)-1)/2,Ni=e=>e===0?0:Math.pow(2,10*e-10),_i=e=>e===1?1:1-Math.pow(2,-10*e),Ti=e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,Mi=e=>1-Math.sqrt(1-e*e),xi=e=>Math.sqrt(1- --e*e),Ii=e=>e<.5?(1-Math.sqrt(1-4*e*e))/2:(Math.sqrt(1-(-2*e+2)*(-2*e+2))+1)/2,Si=e=>(1.70158+1)*e*e*e-1.70158*e*e,Pi=e=>1+(1.70158+1)*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),Ci=e=>{const t=2.5949095;return e<.5?Math.pow(2*e,2)*((t+1)*2*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(e*2-2)+t)+2)/2},Ai=e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*(2*Math.PI/3)),Oi=e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*(2*Math.PI/3))+1,Ri=e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*(2*Math.PI/4.5)))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*(2*Math.PI/4.5))/2+1,Je=e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,Fi=e=>1-Je(1-e),$i=e=>e<.5?(1-Je(1-2*e))/2:(1+Je(2*e-1))/2,qi=[lr,ai,ui,ci,li,fi,di,pi,hi,gi,mi,yi,wi,bi,vi,Ei,Ni,_i,Ti,Mi,xi,Ii,Si,Pi,Ci,Ai,Oi,Ri,Fi,Je,$i],Bi={linear:0,"ease-in-quad":1,"ease-out-quad":2,"ease-in-out-quad":3,"ease-in-cubic":4,"ease-out-cubic":5,"ease-in-out-cubic":6,"ease-in-quart":7,"ease-out-quart":8,"ease-in-out-quart":9,"ease-in-quint":10,"ease-out-quint":11,"ease-in-out-quint":12,"ease-in-sine":13,"ease-out-sine":14,"ease-in-out-sine":15,"ease-in-expo":16,"ease-out-expo":17,"ease-in-out-expo":18,"ease-in-circ":19,"ease-out-circ":20,"ease-in-out-circ":21,"ease-in-back":22,"ease-out-back":23,"ease-in-out-back":24,"ease-in-elastic":25,"ease-out-elastic":26,"ease-in-out-elastic":27,"ease-in-bounce":28,"ease-out-bounce":29,"ease-in-out-bounce":30};function ki(e){return Bi[e]??0}function Vi(e){return qi[e]??lr}const Li=(e,t)=>e-t,Ui=(e,t)=>e.endTime-t.endTime,Ve=[],Le=[],De={duration:[]};R(De,{defaults:()=>({duration:.5})});const W={IDLE:0,PLAYING:1,COMPLETE:2},P={state:[],elapsed:[]};R(P,{defaults:()=>({state:W.IDLE,elapsed:0})});function zi(e,t){Ve.length=0;for(const n of e.query([B(X.relation,t)]))Ve.push(n);return Ve.sort(Li),Ve}function Xi(e,t){const n=zi(e,t);let r=0;for(const s of n)e.hasComponent(s,De)?r+=De.duration[s]??0:e.hasComponent(s,b)&&(b.delay[s]=r)}function Yi(e,t){for(const n of e.query([P])){if(P.state[n]!==W.PLAYING)continue;const r=P.elapsed[n]??0;r===0&&Xi(e,n);const s=r+t;P.elapsed[n]=s;for(const o of e.query([B(X.relation,n),b])){if(b.state[o]!==G.IDLE)continue;const i=b.delay[o]??0,a=s>=i,u=r>=i;a&&(Di(e,o),b.state[o]=G.PLAYING,b.elapsed[o]=u?0:s-i-t)}}}function Gi(e,t){Le.length=0;for(const n of e.query([B(X.relation,t),b])){if(b.state[n]===G.COMPLETE&&b.elapsed[n]>=b.duration[n])continue;const r=b.delay[n]??0,s=b.duration[n]??0;Le.push({eid:n,endTime:r+s})}Le.sort(Ui);for(const{eid:n}of Le)b.state[n]=G.COMPLETE,fr(e,n)}function ji(e){for(const t of e.query([P]))P.state[t]===W.COMPLETE&&Gi(e,t)}function Wi(e){for(const t of e.query([P])){if(P.state[t]!==W.PLAYING)continue;let n=!0,r=!1;for(const s of e.query([B(X.relation,t),b]))if(r=!0,b.state[s]!==G.COMPLETE){n=!1;break}r&&n&&(P.state[t]=W.COMPLETE)}}function Zi(e,t){Yi(e,t)}function Qi(e){if(e._value){const t={};for(const n of e._value.split(";")){const r=n.indexOf(":");if(r===-1)continue;const s=n.slice(0,r).trim(),o=n.slice(r+1).trim();s&&o&&(t[s]=o)}return t}return e}const G={IDLE:0,PLAYING:1,COMPLETE:2},b={state:[],from:[],to:[],duration:[],elapsed:[],delay:[],easingIndex:[]};R(b,{defaults:()=>({state:G.IDLE,from:0,to:0,duration:1,elapsed:0,delay:0,easingIndex:0}),adapter:(e,t,n)=>{const r=Qi(e),s={};return r.duration&&(s.duration=parseFloat(r.duration)),r.delay&&(s.delay=parseFloat(r.delay)),r.easing&&(s.easingIndex=ki(r.easing)),r.target&&Ki(t,n,r,n.currentEid),s}});const $e=Qn("tween-target",{exclusive:!0});function Hi(e){if(!e.startsWith("@"))return null;const t=e.slice(1),n=t.indexOf(".");if(n===-1)return null;const r=t.slice(0,n),s=t.slice(n+1),o=s.lastIndexOf(".");return o===-1?null:{entity:r,component:s.slice(0,o),field:s.slice(o+1)}}let At=[];function Ki(e,t,n,r){At.push({tweenEid:r,target:n.target,to:n.to})}function Ji(e,t){for(const n of At){const r=Hi(n.target);if(!r)continue;const s=t.getEntityByName(r.entity);if(s===null||!e.bindFieldAccessor(n.tweenEid,r.component,r.field))continue;e.addRelation(n.tweenEid,$e,s);const i=n.to.startsWith("0x")||n.to.startsWith("0X")?parseInt(n.to,16):parseFloat(n.to);if(!Number.isFinite(i))throw new Error(`Tween has invalid 'to' value: "${n.to}" (parsed as ${i})`);b.to[n.tweenEid]=i}At=[]}function Di(e,t){const n=e.getFirstRelationTarget(t,$e),r=e.getFieldAccessor(t);r&&n>=0&&(b.from[t]=r.get(n)??0)}function fr(e,t){const n=b.elapsed[t],r=b.duration[t];if(n>=r)return;const s=e.getFirstRelationTarget(t,$e),o=e.getFieldAccessor(t);if(o&&s>=0){const i=b.to[t];if(!Number.isFinite(i))throw new Error(`Tween ${t} has invalid to value: ${i}`);b.from[t]=o.get(s)??0,o.set(s,i)}b.elapsed[t]=r}function ea(e,t){for(const n of e.query([b])){const r=b.state[n];if(r===G.COMPLETE){fr(e,n);continue}if(r!==G.PLAYING)continue;const s=e.getFirstRelationTarget(n,$e),o=e.getFieldAccessor(n);b.elapsed[n]===0&&o&&s>=0&&(b.from[n]=o.get(s)??0),b.elapsed[n]+=t;const i=b.elapsed[n],a=b.duration[n],u=a<=0?1:Math.min(i/a,1);if(!Number.isFinite(u))throw new Error(`Tween ${n} invalid progress: elapsed=${i}, duration=${a}, dt=${t}`);const l=Vi(b.easingIndex[n])(u),f=b.from[n],d=b.to[n],p=f+(d-f)*l;if(!Number.isFinite(p))throw new Error(`Tween ${n} computed NaN: from=${f}, to=${d}, eased=${l}, raw=${u}`);o&&s>=0&&o.set(s,p),u>=1&&(b.state[n]=G.COMPLETE)}}const ta={group:"simulation",update(e){const t=e.time.deltaTime;ji(e),Zi(e,t),ea(e,t),Wi(e)}},Au={systems:[ta],components:{Tween:b,Sequence:P,Pause:De},relations:[$e],initialize(){Gt(Ji)}};let S;function na(e){S.compute_transforms(e)}function ra(){return S.get_indices_ptr()>>>0}function sa(){return S.get_matrices_ptr()>>>0}function oa(){return S.get_max_entities()>>>0}function ia(){return S.get_no_parent()>>>0}function aa(){return S.get_parents_ptr()>>>0}function ua(){return S.get_pos_x_ptr()>>>0}function ca(){return S.get_pos_y_ptr()>>>0}function la(){return S.get_pos_z_ptr()>>>0}function fa(){return S.get_quat_w_ptr()>>>0}function da(){return S.get_quat_x_ptr()>>>0}function pa(){return S.get_quat_y_ptr()>>>0}function ha(){return S.get_quat_z_ptr()>>>0}function ga(){return S.get_scale_x_ptr()>>>0}function ma(){return S.get_scale_y_ptr()>>>0}function ya(){return S.get_scale_z_ptr()>>>0}function wa(){S.init_data()}const ba=new Set(["basic","cors","default"]);async function va(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.ok&&ba.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function Ea(){const e={};return e.wbg={},e}function Na(e,t){return S=e.exports,dr.__wbindgen_wasm_module=t,S}async function dr(e){if(S!==void 0)return S;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL(""+new URL("shallot_transforms_bg-Bqdpqo0Z.wasm",import.meta.url).href,import.meta.url));const t=Ea();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await va(await e,t);return Na(n,r)}let Ot,pr,hr,gr,mr,yr,wr,br,vr,Er,Nr,Rt,Ft,_r;async function _a(){if(Ot)return;const e=await dr();wa();const t=e.memory.buffer,n=oa();Ot=new Float32Array(t,ua(),n),pr=new Float32Array(t,ca(),n),hr=new Float32Array(t,la(),n),gr=new Float32Array(t,da(),n),mr=new Float32Array(t,pa(),n),yr=new Float32Array(t,ha(),n),wr=new Float32Array(t,fa(),n),br=new Float32Array(t,ga(),n),vr=new Float32Array(t,ma(),n),Er=new Float32Array(t,ya(),n),Nr=new Float32Array(t,sa(),n*16),Rt=new Uint32Array(t,ra(),n),Ft=new Uint32Array(t,aa(),n),_r=ia()}function Ta(e){na(e)}function ht(e){function t(r){return sn(w.quatX[r],w.quatY[r],w.quatZ[r],w.quatW[r])[e]}function n(r,s){const o=sn(w.quatX[r],w.quatY[r],w.quatZ[r],w.quatW[r]);o[e]=s;const i=Vs(o.x,o.y,o.z);w.quatX[r]=i.x,w.quatY[r]=i.y,w.quatZ[r]=i.z,w.quatW[r]=i.w}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}const w={posX:new Float32Array(_),posY:new Float32Array(_),posZ:new Float32Array(_),quatX:new Float32Array(_),quatY:new Float32Array(_),quatZ:new Float32Array(_),quatW:new Float32Array(_),scaleX:new Float32Array(_),scaleY:new Float32Array(_),scaleZ:new Float32Array(_),eulerX:ht("x"),eulerY:ht("y"),eulerZ:ht("z")},ae={data:new Float32Array(_*16)};R(w,{defaults:()=>({posX:0,posY:0,posZ:0,quatX:0,quatY:0,quatZ:0,quatW:1,scaleX:1,scaleY:1,scaleZ:1}),accessors:{eulerX:w.eulerX,eulerY:w.eulerY,eulerZ:w.eulerZ}});async function Ma(){await _a(),w.posX=Ot,w.posY=pr,w.posZ=hr,w.quatX=gr,w.quatY=mr,w.quatZ=yr,w.quatW=wr,w.scaleX=br,w.scaleY=vr,w.scaleZ=Er,ae.data=Nr}const xa={group:"simulation",last:!0,update(e){for(const n of e.query([w,Kt(ae)]))e.addComponent(n,ae);let t=0;for(const n of e.query([w,Kt(X.relation(O))]))Rt[t]=n,Ft[t]=_r,t++;for(const n of e.query([w,X.relation(O),bs(X.relation)]))Rt[t]=n,Ft[t]=e.getRelationTargets(n,X)[0],t++;Ta(t)}},Ia={systems:[xa],components:{Transform:w,WorldTransform:ae},initialize:Ma},Sa=192,jt="depth24plus",Tr="r8unorm";function Pa(e){return e.createBuffer({label:"scene",size:Sa,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC})}function Ca(e,t,n,r,s,o){const i=s.get("scene");if(i&&i.width===n&&i.height===r)return;i?.destroy(),s.get("depth")?.destroy(),s.get("mask")?.destroy();const a=e.createTexture({label:"scene",size:{width:n,height:r},format:t,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),u=e.createTexture({label:"depth",size:{width:n,height:r},format:jt,usage:GPUTextureUsage.RENDER_ATTACHMENT}),c=e.createTexture({label:"mask",size:{width:n,height:r},format:Tr,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING});s.set("scene",a),o.set("scene",a.createView()),s.set("depth",u),o.set("depth",u.createView()),s.set("mask",c),o.set("mask",c.createView())}function Aa(e,t,n,r){if(e<=0)throw new Error(`Invalid FOV: ${e} (must be > 0)`);if(t<=0)throw new Error(`Invalid aspect ratio: ${t} (must be > 0)`);if(n===r)throw new Error(`Invalid depth planes: near === far (${n})`);const s=1/Math.tan(e*Math.PI/360),o=1/(n-r);return new Float32Array([s/t,0,0,0,0,s,0,0,0,0,(r+n)*o,-1,0,0,2*r*n*o,0])}function Oa(e,t,n,r){if(e<=0)throw new Error(`Invalid orthographic size: ${e} (must be > 0)`);if(t<=0)throw new Error(`Invalid aspect ratio: ${t} (must be > 0)`);if(n===r)throw new Error(`Invalid depth planes: near === far (${n})`);const s=1/(e*t),o=1/e,i=1/(n-r);return new Float32Array([s,0,0,0,0,o,0,0,0,0,i,0,0,0,n*i,1])}function Ra(e,t){const n=new Float32Array(16);for(let r=0;r<4;r++)for(let s=0;s<4;s++)n[s*4+r]=e[r]*t[s*4]+e[r+4]*t[s*4+1]+e[r+8]*t[s*4+2]+e[r+12]*t[s*4+3];return n}function Fa(e){const t=new Float32Array(16),n=e[0],r=e[1],s=e[2],o=e[4],i=e[5],a=e[6],u=e[8],c=e[9],l=e[10],f=e[12],d=e[13],p=e[14];return t[0]=n,t[1]=o,t[2]=u,t[3]=0,t[4]=r,t[5]=i,t[6]=c,t[7]=0,t[8]=s,t[9]=a,t[10]=l,t[11]=0,t[12]=-(n*f+r*d+s*p),t[13]=-(o*f+i*d+a*p),t[14]=-(u*f+c*d+l*p),t[15]=1,t}const et=20;function $a(e,t){return e.createBuffer({label:"indirect",size:t*et,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC})}function qa(e,t,n,r){const s=n*et,o=new ArrayBuffer(et),i=new DataView(o);i.setUint32(0,r.indexCount,!0),i.setUint32(4,r.instanceCount,!0),i.setUint32(8,r.firstIndex,!0),i.setInt32(12,r.baseVertex,!0),i.setUint32(16,r.firstInstance,!0),e.queue.writeBuffer(t,s,o)}const Ba=`
struct VertexInput {
    @location(0) position: vec3<f32>,
    @location(1) normal: vec3<f32>,
    @builtin(instance_index) instance: u32,
}

struct VertexOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) color: vec4<f32>,
    @location(1) worldNormal: vec3<f32>,
    @location(2) @interpolate(flat) materialId: u32,
}

struct Scene {
    viewProj: mat4x4<f32>,
    cameraWorld: mat4x4<f32>,
    ambientColor: vec4<f32>,
    sunDirection: vec4<f32>,
    sunColor: vec4<f32>,
    cameraMode: f32,
    cameraSize: f32,
    viewport: vec2<f32>,
}

struct MaterialData {
    emission: vec3<f32>,
    roughness: f32,
    metallic: f32,
    _pad0: f32,
    _pad1: f32,
    _pad2: f32,
}

@group(0) @binding(0) var<uniform> scene: Scene;
@group(0) @binding(1) var<storage, read> entityIds: array<u32>;
@group(0) @binding(2) var<storage, read> matrices: array<mat4x4<f32>>;
@group(0) @binding(3) var<storage, read> colors: array<vec4<f32>>;
@group(0) @binding(4) var<storage, read> sizes: array<vec4<f32>>;
@group(0) @binding(5) var<storage, read> materials: array<MaterialData>;
@group(0) @binding(6) var<storage, read> matIds: array<u32>;

@vertex
fn vs(input: VertexInput) -> VertexOutput {
    let eid = entityIds[input.instance];
    let world = matrices[eid];
    let scaledPos = input.position * sizes[eid].xyz;
    let worldPos = world * vec4<f32>(scaledPos, 1.0);
    let worldNormal = normalize((world * vec4<f32>(input.normal, 0.0)).xyz);

    var output: VertexOutput;
    output.position = scene.viewProj * worldPos;
    output.color = colors[eid];
    output.worldNormal = worldNormal;
    output.materialId = matIds[eid];
    return output;
}

@fragment
fn fs(input: VertexOutput) -> @location(0) vec4<f32> {
    let mat = materials[input.materialId];
    let normal = normalize(input.worldNormal);
    let NdotL = max(dot(normal, -scene.sunDirection.xyz), 0.0);

    let ambient = scene.ambientColor.rgb * scene.ambientColor.a;
    let diffuse = scene.sunColor.rgb * NdotL;
    let diffuseFactor = 1.0 - mat.metallic * 0.9;
    let lighting = ambient + diffuse * diffuseFactor;

    return vec4<f32>(input.color.rgb * lighting + mat.emission, input.color.a);
}
`;function ka(e,t){const n=e.createShaderModule({code:Ba});return e.createRenderPipeline({layout:"auto",vertex:{module:n,entryPoint:"vs",buffers:[{arrayStride:24,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"}]}]},fragment:{module:n,entryPoint:"fs",targets:[{format:t}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{format:jt,depthWriteEnabled:!0,depthCompare:"less"}})}const Ye={r:.1,g:.1,b:.1,a:1};function Va(e){let t=null;const n=new Map;return{id:"forward",inputs:[],outputs:[{id:"scene",access:"write"},{id:"depth",access:"write"}],execute(r){const{device:s,encoder:o,format:i}=r,a=r.getTextureView("scene")??r.canvasView,u=r.getTextureView("depth");t||(t=ka(s,i));const c=o.beginRenderPass({colorAttachments:[{view:a,clearValue:Ye,loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:u,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}}),l=e.getCallbacks(),f=l.filter(h=>h.order<0).sort((h,g)=>h.order-g.order),d=l.filter(h=>h.order>=0).sort((h,g)=>h.order-g.order),p={device:s,format:i,depthFormat:jt,scene:e.scene,matrices:e.matrices};for(const h of f)h.draw(c,p);c.setPipeline(t);for(const h of e.batches.values()){let g=n.get(h.index);g||(g=s.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.scene}},{binding:1,resource:{buffer:h.entityIds}},{binding:2,resource:{buffer:e.matrices}},{binding:3,resource:{buffer:e.colors}},{binding:4,resource:{buffer:e.sizes}},{binding:5,resource:{buffer:e.materials}},{binding:6,resource:{buffer:e.materialIds}}]}),n.set(h.index,g)),c.setBindGroup(0,g),c.setVertexBuffer(0,h.buffers.vertex),c.setIndexBuffer(h.buffers.index,"uint16"),c.drawIndexedIndirect(e.indirect,h.index*et)}for(const h of d)h.draw(c,p);c.end()}}}const La={Raster:0},Ua={Color:0},Mr={Perspective:0,Orthographic:1},V={fov:[],near:[],far:[],active:[],clearColor:[],renderMode:[],debugMode:[],mode:[],size:[]};R(V,{defaults:()=>({fov:60,near:.1,far:1e3,active:1,clearColor:1710618,renderMode:La.Raster,debugMode:Ua.Color,mode:Mr.Perspective,size:5})});const tt={exposure:[]};R(tt,{defaults:()=>({exposure:1})});const xr={},le={strength:[],inner:[],outer:[]};R(le,{defaults:()=>({strength:.5,inner:.4,outer:.8})});function $t(e){return{r:(e>>16&255)/255,g:(e>>8&255)/255,b:(e&255)/255}}function za(e,t,n,r,s){const o=$t(V.clearColor[n]);Ye.r=o.r,Ye.g=o.g,Ye.b=o.b;const i=r/s,a=V.mode[n]===Mr.Orthographic?Oa(V.size[n],i,V.near[n],V.far[n]):Aa(V.fov[n],i,V.near[n],V.far[n]),u=ae.data.subarray(n*16,n*16+16),c=Fa(u),l=Ra(a,c);e.queue.writeBuffer(t,0,l),e.queue.writeBuffer(t,64,u),e.queue.writeBuffer(t,176,new Float32Array([V.mode[n],V.size[n],r,s]))}const xe={color:[],intensity:[]};R(xe,{defaults:()=>({color:8947848,intensity:1})});const Q={color:[],intensity:[],directionX:[],directionY:[],directionZ:[]};R(Q,{defaults:()=>({color:16777215,intensity:1,directionX:-.6,directionY:-1,directionZ:-.8})});function Xa(e,t,n){const r=Math.sqrt(e*e+t*t+n*n);return r<1e-4?[0,-1,0]:[e/r,t/r,n/r]}function Ya(e,t){const n=new Float32Array(12),r=$t(e.color);n[0]=r.r,n[1]=r.g,n[2]=r.b,n[3]=e.intensity;const[s,o,i]=Xa(t.directionX,t.directionY,t.directionZ);n[4]=s,n[5]=o,n[6]=i,n[7]=0;const a=$t(t.color);return n[8]=a.r*t.intensity,n[9]=a.g*t.intensity,n[10]=a.b*t.intensity,n[11]=0,n}function Ga(){const e=new Float32Array([-.5,-.5,.5,0,0,1,.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,.5,.5,0,0,1,.5,-.5,-.5,0,0,-1,-.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,.5,.5,-.5,0,0,-1,-.5,.5,.5,0,1,0,.5,.5,.5,0,1,0,.5,.5,-.5,0,1,0,-.5,.5,-.5,0,1,0,-.5,-.5,-.5,0,-1,0,.5,-.5,-.5,0,-1,0,.5,-.5,.5,0,-1,0,-.5,-.5,.5,0,-1,0,.5,-.5,.5,1,0,0,.5,-.5,-.5,1,0,0,.5,.5,-.5,1,0,0,.5,.5,.5,1,0,0,-.5,-.5,-.5,-1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,.5,-1,0,0,-.5,.5,-.5,-1,0,0]),t=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);return{vertices:e,indices:t,vertexCount:24,indexCount:36}}function ja(e=32,t=16){const n=[],r=[];for(let o=0;o<=t;o++){const a=o/t*Math.PI;for(let u=0;u<=e;u++){const l=u/e*Math.PI*2,f=Math.sin(a)*Math.cos(l),d=Math.cos(a),p=Math.sin(a)*Math.sin(l);n.push(f*.5,d*.5,p*.5,f,d,p)}}for(let o=0;o<t;o++)for(let i=0;i<e;i++){const a=o*(e+1)+i,u=a+e+1;r.push(a,a+1,u),r.push(a+1,u+1,u)}return{vertices:new Float32Array(n),indices:new Uint16Array(r),vertexCount:(t+1)*(e+1),indexCount:t*e*6}}function Wa(){const e=new Float32Array([-.5,0,.5,0,1,0,.5,0,.5,0,1,0,.5,0,-.5,0,1,0,-.5,0,-.5,0,1,0]),t=new Uint16Array([0,1,2,0,2,3]);return{vertices:e,indices:t,vertexCount:4,indexCount:6}}const _e=[];function Za(){_e.length===0&&(_e.push(Ga()),_e.push(ja()),_e.push(Wa()))}Za();const Ir={Box:0};function _n(e){return _e[e]}const Wt={data:new Float32Array(_*4)},Sr={data:new Float32Array(_*4)};function Qa(){const e=Wt.data;function t(r){const s=r*4,o=Math.round(e[s]*255),i=Math.round(e[s+1]*255),a=Math.round(e[s+2]*255);return o<<16|i<<8|a}function n(r,s){const o=r*4;e[o]=(s>>16&255)/255,e[o+1]=(s>>8&255)/255,e[o+2]=(s&255)/255,e[o+3]=1}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}function gt(e){const t=Wt.data;function n(s){return t[s*4+e]}function r(s,o){t[s*4+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}function mt(e){const t=Sr.data;function n(s){return t[s*4+e]}function r(s,o){t[s*4+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const L={shape:[],color:Qa(),colorR:gt(0),colorG:gt(1),colorB:gt(2),sizeX:mt(0),sizeY:mt(1),sizeZ:mt(2)};R(L,{defaults:()=>({shape:Ir.Box,color:16777215,sizeX:1,sizeY:1,sizeZ:1}),accessors:{color:L.color,colorR:L.colorR,colorG:L.colorG,colorB:L.colorB,sizeX:L.sizeX,sizeY:L.sizeY,sizeZ:L.sizeZ}});function Ha(e,t){const n=e.createBuffer({label:"vertex",size:t.vertices.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(n,0,t.vertices);const r=e.createBuffer({label:"index",size:t.indices.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(r,0,t.indices),{vertex:n,index:r,indexCount:t.indexCount}}function Ka(e){const t=new Map;for(const n of e){const r=L.shape[n];let s=t.get(r);s||(s=[],t.set(r,s)),s.push(n)}return t}function Ja(e,t,n,r){for(const[s,o]of t){let i=n.batches.get(s);if(!i){let a=n.buffers.get(s);if(!a){const u=_n(s)??_n(Ir.Box);a=Ha(e,u),n.buffers.set(s,a)}i={index:n.batches.size,buffers:a,entityIds:Do(e,_),count:0},n.batches.set(s,i)}e.queue.writeBuffer(i.entityIds,0,new Uint32Array(o)),i.count=o.length,qa(e,r,i.index,{indexCount:i.buffers.indexCount,instanceCount:o.length,firstIndex:0,baseVertex:0,firstInstance:0})}}const Ie=[];function Da(){Ie.length===0&&Ie.push({roughness:.9,metallic:0,emissionColor:0,emissionIntensity:0})}Da();const eu={Default:0},Tn={data:new Uint32Array(_)},me={type:[]};R(me,{defaults:()=>({type:eu.Default})});function tu(e){return{r:(e>>16&255)/255,g:(e>>8&255)/255,b:(e&255)/255}}function nu(){const t=new Float32Array(Ie.length*8);for(let n=0;n<Ie.length;n++){const r=Ie[n],s=n*8,o=r.emissionColor??0,i=r.emissionIntensity??0,a=tu(o);t[s+0]=a.r*i,t[s+1]=a.g*i,t[s+2]=a.b*i,t[s+3]=r.roughness??.9,t[s+4]=r.metallic??0,t[s+5]=0,t[s+6]=0,t[s+7]=0}return t}const ru=`
struct VertexOutput {
    @builtin(position) position: vec4f,
    @location(0) uv: vec2f,
}

struct Uniforms {
    exposure: f32,
    vignetteStrength: f32,
    vignetteInner: f32,
    vignetteOuter: f32,
    texelSizeX: f32,
    texelSizeY: f32,
    flags: u32,
    _pad: u32,
}

@group(0) @binding(0) var inputTexture: texture_2d<f32>;
@group(0) @binding(1) var inputSampler: sampler;
@group(0) @binding(2) var<uniform> uniforms: Uniforms;
@group(0) @binding(3) var maskTexture: texture_2d<f32>;

const FLAG_TONEMAP: u32 = 1u;
const FLAG_FXAA: u32 = 2u;
const FLAG_VIGNETTE: u32 = 4u;

@vertex
fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
    var positions = array<vec2f, 3>(
        vec2f(-1.0, -1.0),
        vec2f(3.0, -1.0),
        vec2f(-1.0, 3.0)
    );

    let pos = positions[vertexIndex];

    var output: VertexOutput;
    output.position = vec4f(pos, 0.0, 1.0);
    output.uv = (pos + 1.0) * 0.5;
    output.uv.y = 1.0 - output.uv.y;
    return output;
}

fn aces(x: vec3f) -> vec3f {
    let a = 2.51;
    let b = 0.03;
    let c = 2.43;
    let d = 0.59;
    let e = 0.14;
    return saturate((x * (a * x + b)) / (x * (c * x + d) + e));
}

fn luma(color: vec3f) -> f32 {
    return dot(color, vec3f(0.299, 0.587, 0.114));
}

const FXAA_REDUCE_MIN: f32 = 1.0 / 128.0;
const FXAA_REDUCE_MUL: f32 = 1.0 / 8.0;
const FXAA_SPAN_MAX: f32 = 8.0;

fn applyFXAA(uv: vec2f, colorM: vec3f) -> vec3f {
    let texelSize = vec2f(uniforms.texelSizeX, uniforms.texelSizeY);

    let colorNW = textureSample(inputTexture, inputSampler, uv + vec2f(-1.0, -1.0) * texelSize).rgb;
    let colorNE = textureSample(inputTexture, inputSampler, uv + vec2f(1.0, -1.0) * texelSize).rgb;
    let colorSW = textureSample(inputTexture, inputSampler, uv + vec2f(-1.0, 1.0) * texelSize).rgb;
    let colorSE = textureSample(inputTexture, inputSampler, uv + vec2f(1.0, 1.0) * texelSize).rgb;

    let lumaM = luma(colorM);
    let lumaNW = luma(colorNW);
    let lumaNE = luma(colorNE);
    let lumaSW = luma(colorSW);
    let lumaSE = luma(colorSE);

    let lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
    let lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));

    var dir: vec2f;
    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
    dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));

    let dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * 0.25 * FXAA_REDUCE_MUL, FXAA_REDUCE_MIN);
    let rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
    dir = clamp(dir * rcpDirMin, vec2f(-FXAA_SPAN_MAX), vec2f(FXAA_SPAN_MAX)) * texelSize;

    let colorA = 0.5 * (
        textureSample(inputTexture, inputSampler, uv + dir * (1.0 / 3.0 - 0.5)).rgb +
        textureSample(inputTexture, inputSampler, uv + dir * (2.0 / 3.0 - 0.5)).rgb
    );

    let colorB = colorA * 0.5 + 0.25 * (
        textureSample(inputTexture, inputSampler, uv + dir * -0.5).rgb +
        textureSample(inputTexture, inputSampler, uv + dir * 0.5).rgb
    );

    let lumaB = luma(colorB);

    if lumaB < lumaMin || lumaB > lumaMax {
        return colorA;
    }
    return colorB;
}

fn applyVignette(color: vec3f, uv: vec2f) -> vec3f {
    let center = vec2f(0.5, 0.5);
    let dist = distance(uv, center);
    let vignette = 1.0 - smoothstep(uniforms.vignetteInner, uniforms.vignetteOuter, dist) * uniforms.vignetteStrength;
    return color * vignette;
}

@fragment
fn fragmentMain(input: VertexOutput) -> @location(0) vec4f {
    var color = textureSample(inputTexture, inputSampler, input.uv).rgb;
    let maskValue = textureSample(maskTexture, inputSampler, input.uv).r;

    if (uniforms.flags & FLAG_FXAA) != 0u {
        let fxaaColor = applyFXAA(input.uv, color);
        color = select(fxaaColor, color, maskValue >= 0.5);
    }

    if (uniforms.flags & FLAG_TONEMAP) != 0u {
        color = aces(color * uniforms.exposure);
    }

    if (uniforms.flags & FLAG_VIGNETTE) != 0u {
        color = applyVignette(color, input.uv);
    }

    return vec4f(color, 1.0);
}
`,su=1,ou=2,iu=4;function au(e){let t=null,n=null,r=null;return{id:"postprocess",phase:"postprocess",inputs:[{id:"scene",access:"read"},{id:"mask",access:"read"}],outputs:[{id:"framebuffer",access:"write"}],execute(s){const{device:o,encoder:i,canvasView:a,format:u,context:c}=s,l=c.canvas.width,f=c.canvas.height,d=s.getTextureView("scene"),p=s.getTextureView("mask");if(!t){const y=o.createShaderModule({code:ru});t=o.createRenderPipeline({layout:"auto",vertex:{module:y,entryPoint:"vertexMain"},fragment:{module:y,entryPoint:"fragmentMain",targets:[{format:u}]},primitive:{topology:"triangle-list"}})}n||(n=o.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})),r||(r=o.createSampler({magFilter:"linear",minFilter:"linear"}));let h=0;e.tonemap&&(h|=su),e.fxaa&&(h|=ou),e.vignetteStrength>0&&(h|=iu);const g=new ArrayBuffer(32),m=new Float32Array(g),M=new Uint32Array(g);m[0]=e.exposure,m[1]=e.vignetteStrength,m[2]=e.vignetteInner,m[3]=e.vignetteOuter,m[4]=1/l,m[5]=1/f,M[6]=h,o.queue.writeBuffer(n,0,g);const E=o.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:d},{binding:1,resource:r},{binding:2,resource:{buffer:n}},{binding:3,resource:p}]}),F=i.beginRenderPass({colorAttachments:[{view:a,loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});F.setPipeline(t),F.setBindGroup(0,E),F.draw(3),F.end()}}}const uu=D("transparent-pass");function cu(e){return{id:"transparent",phase:"transparent",inputs:[{id:"depth",access:"read"}],outputs:[{id:"scene",access:"write"},{id:"mask",access:"write"}],execute(t){const n=e.getContributors();if(n.length===0)return;const r=t.getTextureView("scene")??t.canvasView,s=t.getTextureView("depth"),o=t.getTextureView("mask"),i=t.encoder.beginRenderPass({colorAttachments:[{view:r,loadOp:"load",storeOp:"store"},{view:o,clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:s,depthLoadOp:"load",depthStoreOp:"store"}}),a={device:t.device,format:t.format,maskFormat:Tr},u=[...n].sort((c,l)=>c.order-l.order);for(const c of u)c.draw(i,a);i.end()}}}const Pr=D("opaque-pass");function lu(e){const t=Pr.from(e);return t?Array.from(t.callbacks.values()):[]}const Cr=D("render"),fu={group:"draw",first:!0,update(e){const t=Cr.from(e),n=it.from(e);if(!t||!n||!e.canvas)return;const{device:r,format:s,resources:o}=n,{width:i,height:a}=e.canvas;Ca(r,s,i,a,o.textures,o.textureViews);for(const p of e.query([V]))if(V.active[p]){za(r,t.scene,p,i,a),t.postProcess.tonemap=e.hasComponent(p,tt),t.postProcess.tonemap&&(t.postProcess.exposure=tt.exposure[p]),t.postProcess.fxaa=e.hasComponent(p,xr),e.hasComponent(p,le)?(t.postProcess.vignetteStrength=le.strength[p],t.postProcess.vignetteInner=le.inner[p],t.postProcess.vignetteOuter=le.outer[p]):t.postProcess.vignetteStrength=0;break}let u={color:8947848,intensity:1},c={color:16777215,intensity:1,directionX:-.5,directionY:-1,directionZ:-.5};for(const p of e.query([xe])){u={color:xe.color[p],intensity:xe.intensity[p]};break}for(const p of e.query([Q])){c={color:Q.color[p],intensity:Q.intensity[p],directionX:Q.directionX[p],directionY:Q.directionY[p],directionZ:Q.directionZ[p]};break}const l=Ya(u,c);r.queue.writeBuffer(t.scene,128,l),r.queue.writeBuffer(t.matrices,0,ae.data);const f=e.query([L,ae]),d=Ka(f);r.queue.writeBuffer(t.colors,0,Wt.data),r.queue.writeBuffer(t.sizes,0,Sr.data);for(const p of e.query([me]))Tn.data[p]=me.type[p];r.queue.writeBuffer(t.materials,0,nu()),r.queue.writeBuffer(t.materialIds,0,Tn.data),Ja(r,d,t,t.indirect)}},du={group:"setup",update(e){for(const t of e.query([L]))e.hasComponent(t,me)||e.addComponent(t,me)}},pu={systems:[du,fu],components:{Camera:V,Mesh:L,Material:me,AmbientLight:xe,DirectionalLight:Q,Tonemap:tt,FXAA:xr,Vignette:le},dependencies:[ir],initialize(e){const t=it.from(e);if(!t)return;const{device:n}=t,r=a=>n.createBuffer({label:"property",size:a,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),s={scene:Pa(n),matrices:r(_*64),colors:r(_*16),sizes:r(_*16),materials:r(256*32),materialIds:r(_*4),indirect:$a(n,16),batches:new Map,buffers:new Map,postProcess:{tonemap:!1,exposure:1,fxaa:!0,vignetteStrength:0,vignetteInner:.4,vignetteOuter:.8}};e.setResource(Cr,s);const o={callbacks:new Map};e.setResource(Pr,o);const i={contributors:new Map};e.setResource(uu,i),t.graph.add(Va({scene:s.scene,matrices:s.matrices,colors:s.colors,sizes:s.sizes,materials:s.materials,materialIds:s.materialIds,indirect:s.indirect,batches:s.batches,getCallbacks:()=>lu(e)})),t.graph.add(cu({getContributors:()=>Array.from(i.contributors.values())})),t.graph.add(au(s.postProcess))}},hu={bg:"#1a1a1a",track:"#333",bar:"#E8A86B"},gu={bg:"#f5f5f5",track:"#ddd",bar:"#B87654"},mu=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">
  <defs>
    <radialGradient id="baseGradient" cx="35%" cy="30%" r="70%" fx="25%" fy="20%">
      <stop offset="0%" stop-color="#F5D4B8"/>
      <stop offset="45%" stop-color="#E8A86B"/>
      <stop offset="100%" stop-color="#B87654"/>
    </radialGradient>
  </defs>
  <g transform="rotate(35 40.0 40.0)">
    <path d="M40.0,2 C44.0,10 66.0,28 66.0,46 C66.0,60 48.0,70 40.0,78 C32.0,70 14.0,60 14.0,46 C14.0,28 36.0,10 40.0,2 Z" fill="url(#baseGradient)"/>
    <path d="M40.0,6 C37.0,14 22.0,28 20.0,44 C20.0,52 28.0,62 36.0,70 C34.0,58 26.0,46 26.0,38 C26.0,26 38.0,12 40.0,6 Z" fill="#B87654" opacity="0.45"/>
    <path d="M40.0,6 C43.0,14 58.0,28 60.0,44 C60.0,52 52.0,62 44.0,70 C46.0,58 54.0,46 54.0,38 C54.0,26 42.0,12 40.0,6 Z" fill="#B87654" opacity="0.35"/>
    <path d="M40.0,8 C40.0,20 40.0,50 40.0,72" stroke="#B87654" stroke-width="1" stroke-opacity="0.4" fill="none" stroke-linecap="round"/>
    <path d="M40.0,78 C48.0,70 66.0,60 66.0,46 C61.0,58 44.0,70 40.0,73 Z" fill="#B87654"/>
    <path d="M40.0,2 C36.0,10 14.0,28 14.0,46 C19.0,30 41.0,8 40.0,7 Z" fill="#F5D4B8" opacity="0.7"/>
    <path d="M40.0,2 C44.0,10 66.0,28 66.0,46 C66.0,60 48.0,70 40.0,78 C32.0,70 14.0,60 14.0,46 C14.0,28 36.0,10 40.0,2 Z" fill="none" stroke="#6B4230" stroke-width="2"/>
  </g>
</svg>`;function Ar(e,t){const n=document.createElement("div");n.style.cssText=`
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: ${t};
        z-index: 1000;
    `;const r=e.parentElement;return r&&(getComputedStyle(r).position==="static"&&(r.style.position="relative"),r.appendChild(n)),n}function Or(e){const t=document.createElement("div");t.style.cssText=`
        width: 200px;
        height: 4px;
        background: ${e.track};
        border-radius: 2px;
        overflow: hidden;
    `;const n=document.createElement("div");return n.style.cssText=`
        width: 0%;
        height: 100%;
        background: ${e.bar};
        transition: width 0.15s ease-out;
    `,t.appendChild(n),{track:t,bar:n}}function yu(e,t){let n=null,r=null;return{show(){n=Ar(e,t.bg);const s=document.createElement("div");s.innerHTML=mu,s.style.cssText="width: 64px; height: 64px; margin-bottom: 24px;",n.appendChild(s);const o=Or(t);return r=o.bar,n.appendChild(o.track),()=>{n?.remove(),n=null,r=null}},update(s){r&&(r.style.width=`${s*100}%`)}}}function wu(e,t){let n=null,r=null;return{show(){n=Ar(e,t.bg);const s=Or(t);return r=s.bar,n.appendChild(s.track),()=>{n?.remove(),n=null,r=null}},update(s){r&&(r.style.width=`${s*100}%`)}}}const bu=e=>yu(e,hu),Ou=e=>wu(e,gu),vu=[Ia,cr,ir,pu];ge.defaultPlugins=vu;ge.loading=bu;const Ge=Math.PI*2,qt={Left:0,Middle:1},v={target:[],yaw:[],pitch:[],distance:[],targetYaw:[],targetPitch:[],targetDistance:[],minPitch:[],maxPitch:[],minDistance:[],maxDistance:[],smoothness:[],sensitivity:[],zoomSpeed:[],button:[]};R(v,{defaults:()=>({target:0,yaw:0,pitch:Math.PI/6,distance:8,targetYaw:0,targetPitch:Math.PI/6,targetDistance:10,minPitch:-Math.PI/2+.01,maxPitch:Math.PI/2-.01,minDistance:1,maxDistance:25,smoothness:.3,sensitivity:.005,zoomSpeed:.025,button:qt.Left})});function Eu(e,t){const n=Math.max(0,Math.min(1,e));return 1-Math.pow(1-n,t*60)}function Nu(e){return(e%Ge+Ge)%Ge}function _u(e,t){const n=Nu(t-e);return n>Math.PI?n-Ge:n}function Tu(e,t){return t===qt.Left?e.left:t===qt.Middle?e.middle:e.right}const Mu={group:"simulation",update(e){const t=Ct.from(e),n=e.time.deltaTime;for(const r of e.query([v,w])){const s=v.sensitivity[r],o=v.zoomSpeed[r],i=v.minPitch[r],a=v.maxPitch[r],u=v.minDistance[r],c=v.maxDistance[r],l=v.smoothness[r];if(t&&Tu(t.mouse,v.button[r])&&(v.targetYaw[r]-=t.mouse.deltaX*s,v.targetPitch[r]=rn(v.targetPitch[r]+t.mouse.deltaY*s,i,a)),t&&t.mouse.scrollDelta!==0){const Z=v.targetDistance[r],ee=Math.max(.3,Z*.08),x=t.mouse.scrollDelta*o*ee;v.targetDistance[r]=rn(Z+x,u,c)}const f=Eu(l,n);v.yaw[r]+=_u(v.yaw[r],v.targetYaw[r])*f,v.pitch[r]+=(v.targetPitch[r]-v.pitch[r])*f,v.distance[r]+=(v.targetDistance[r]-v.distance[r])*f;const d=v.yaw[r],p=v.pitch[r],h=v.distance[r];let g=0,m=0,M=0;const E=v.target[r];E&&e.hasComponent(E,w)&&(g=w.posX[E],m=w.posY[E],M=w.posZ[E]);const F=g+h*Math.cos(p)*Math.sin(d),y=m+h*Math.sin(p),T=M+h*Math.cos(p)*Math.cos(d);w.posX[r]=F,w.posY[r]=y,w.posZ[r]=T;const C=Ls(F,y,T,g,m,M);w.quatX[r]=C.x,w.quatY[r]=C.y,w.quatZ[r]=C.z,w.quatW[r]=C.w}}},Ru={systems:[Mu],components:{Orbit:v},dependencies:[cr]},Zt={data:new Float32Array(_*12)};function ce(e){const t=Zt.data;function n(s){return t[s*12+e]}function r(s,o){t[s*12+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}function xu(){const e=Zt.data;function t(r){const s=r*12+8,o=Math.round(e[s]*255),i=Math.round(e[s+1]*255),a=Math.round(e[s+2]*255);return o<<16|i<<8|a}function n(r,s){const o=r*12+8;e[o]=(s>>16&255)/255,e[o+1]=(s>>8&255)/255,e[o+2]=(s&255)/255,e[o+3]=1}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}function yt(e){const t=Zt.data;function n(s){return t[s*12+8+e]}function r(s,o){t[s*12+8+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const U={offsetX:ce(0),offsetY:ce(1),offsetZ:ce(2),thickness:ce(3),visible:ce(4),opacity:ce(7),color:xu(),colorR:yt(0),colorG:yt(1),colorB:yt(2)};R(U,{defaults:()=>({offsetX:1,offsetY:0,offsetZ:0,thickness:2,visible:1,opacity:1,color:16777215}),accessors:{offsetX:U.offsetX,offsetY:U.offsetY,offsetZ:U.offsetZ,thickness:U.thickness,visible:U.visible,opacity:U.opacity,color:U.color,colorR:U.colorR,colorG:U.colorG,colorB:U.colorB}});D("lines");const Iu={data:new Float32Array(_*4)};function wt(e){const t=Iu.data;function n(s){return t[s*4+e]}function r(s,o){t[s*4+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const Ue={start:wt(0),end:wt(1),size:wt(2)};R(Ue,{defaults:()=>({start:0,end:1,size:1}),accessors:{start:Ue.start,end:Ue.end,size:Ue.size}});D("arrows");const Qt={data:new Float32Array(_*12)};function ve(e){const t=Qt.data;function n(s){return t[s*12+e]}function r(s,o){t[s*12+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}function Su(){const e=Qt.data;function t(r){const s=r*12+8,o=Math.round(e[s]*255),i=Math.round(e[s+1]*255),a=Math.round(e[s+2]*255);return o<<16|i<<8|a}function n(r,s){const o=r*12+8;e[o]=(s>>16&255)/255,e[o+1]=(s>>8&255)/255,e[o+2]=(s&255)/255,e[o+3]=1}return new Proxy([],{get(r,s){if(s==="get")return t;if(s==="set")return n;const o=Number(s);if(!Number.isNaN(o))return t(o)},set(r,s,o){const i=Number(s);return Number.isNaN(i)?!1:(n(i,o),!0)}})}function bt(e){const t=Qt.data;function n(s){return t[s*12+8+e]}function r(s,o){t[s*12+8+e]=o}return new Proxy([],{get(s,o){if(o==="get")return n;if(o==="set")return r;const i=Number(o);if(!Number.isNaN(i))return n(i)},set(s,o,i){const a=Number(o);return Number.isNaN(a)?!1:(r(a,i),!0)}})}const z={fontSize:ve(0),opacity:ve(1),visible:ve(2),anchorX:ve(3),anchorY:ve(4),color:Su(),colorR:bt(0),colorG:bt(1),colorB:bt(2)};R(z,{defaults:()=>({fontSize:1,opacity:1,visible:1,anchorX:0,anchorY:0,color:16777215}),accessors:{fontSize:z.fontSize,opacity:z.opacity,visible:z.visible,anchorX:z.anchorX,anchorY:z.anchorY,color:z.color,colorR:z.colorR,colorG:z.colorG,colorB:z.colorB}});D("text");const fe={step:[],target:[],max:[]};R(fe,{defaults:()=>({step:0,target:0,max:0})});let Rr=null;function Pu(e,t){Rr=n=>t.getEntityByName(n)}Gt(Pu);function vt(e){return Rr?.(e)??null}function Cu(e){let t=!1;return{group:"simulation",update(n){if(!t)for(const r of n.query([fe])){const s=fe.step[r],o=fe.target[r];if(s!==o){t=!0;const i=e[`${s}-${o}`],a=i?vt(i):null;for(const u of Object.values(e)){const c=vt(u);c!==null&&n.hasComponent(c,P)&&P.state[c]===W.PLAYING&&(P.state[c]=W.COMPLETE)}n.step(0);for(const u of Object.values(e)){const c=vt(u);if(c!==null&&n.hasComponent(c,P)){P.state[c]=W.IDLE,P.elapsed[c]=0;for(const l of n.query([kr(X.relation,c),b]))b.state[l]=G.IDLE,b.elapsed[l]=0}}a!==null&&n.hasComponent(a,P)&&(P.state[a]=W.PLAYING),fe.step[r]=o,t=!1}}}}}function Fu(e){return{components:{StepController:fe},systems:[Cu(e)]}}export{X as C,L as M,Ru as O,pu as R,fe as S,b as T,W as a,P as b,kr as c,G as d,Pe as e,Ia as f,vt as g,Au as h,Fu as i,w as j,Ou as m,R as s};
//# sourceMappingURL=step-plugin-Cqgj3jUS.js.map
