import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{g as R,S as q,a as M,b as I,c as T,T as w,C,d as P}from"./step-plugin-Cqgj3jUS.js";import{M as k,A as z}from"./mp4-muxer-DaZBAdSD.js";import{c as A,d as B,D as U}from"./ui-vQ9UuVEs.js";/* empty css                   */function D(e){if(e.displayName)return e.displayName;if(e.iframeSelector){const t=e.iframeSelector.match(/\*="?([^""\]]+)/);return t?t[1]:e.canvasId}return e.canvasId}function h(e){if(e.iframeSelector){const t=e.iframeSelector.match(/\*="?([^""\]]+)/);return`${t?t[1]:e.iframeSelector.replace(/[^a-zA-Z0-9]/g,"")}:${e.canvasId}`}return e.canvasId}let m=!1,i=null,v=[],$=null,N="Waiting...";function y(e){return e.isIframe&&e.canvas.__getStep__?e.canvas.__getStep__():q.target[e.controllerEid]}function b(e,t){e.isIframe&&e.canvas.__setStep__?e.canvas.__setStep__(t):q.target[e.controllerEid]=t}function E(e){return e.isIframe&&e.canvas.__maxStep__!==void 0?e.canvas.__maxStep__:H(e.config.sequenceMap)}function f(e){N=e,l()}function H(e){let t=0;for(const o of Object.keys(e)){const[r,a]=o.split("-").map(Number);t=Math.max(t,r,a)}return t}async function O(e,t,o,r,a){I.state[o]=M.IDLE,I.elapsed[o]=0;for(const s of t.query([T(C.relation,o),w]))w.state[s]=P.IDLE,w.elapsed[s]=0;I.state[o]=M.PLAYING;let u=0;for(const s of t.query([T(C.relation,o),w]))u=Math.max(u,w.duration[s]);const p=u+.1,_=Math.ceil(p*r.fps),c=new k({target:new z,video:{codec:"avc",width:r.width,height:r.height},fastStart:"in-memory"}),d=new VideoEncoder({output:(s,S)=>c.addVideoChunk(s,S),error:s=>console.error("Encoder error:",s)});d.configure({codec:"avc1.640032",width:r.width,height:r.height,bitrate:r.bitrate,framerate:r.fps});const n=1/r.fps;for(let s=0;s<_;s++){t.step(n);const S=new VideoFrame(e,{timestamp:s*1e6/r.fps});d.encode(S),S.close(),s%30===0&&(a?.(s,_),await new Promise(g=>setTimeout(g,0)))}return await d.flush(),c.finalize(),new Blob([c.target.buffer],{type:"video/mp4"})}async function V(e,t,o,r){if(m)return;m=!0,l();const{canvas:a,config:u}=e,p=u.sequenceMap[`${t}-${o}`];if(!p){f(`No seq ${t}-${o}`),m=!1,l();return}const _=`${D(u)}-step-${t}-${o}`;f("Recording...");let c=null;if(e.isIframe&&a.__recordSequence__)c=await a.__recordSequence__({seqName:p,width:r.width,height:r.height,fps:r.fps,bitrate:r.bitrate},(d,n)=>f(`${d}/${n}`));else{const d=a.__state__;if(!d){f("No state"),m=!1,l();return}const n=R(p);if(n===null){f("Seq not found"),m=!1,l();return}const s=a.width,S=a.height,g=a.style.cssText;document.body.classList.add("recording-mode"),a.classList.add("recording-target"),a.width=r.width,a.height=r.height,a.style.cssText=`width:${r.width}px;height:${r.height}px;display:block`,window.dispatchEvent(new Event("resize")),await new Promise(x=>requestAnimationFrame(x)),c=await O(a,d,n,r,(x,L)=>{f(`${x}/${L}`)}),document.body.classList.remove("recording-mode"),a.classList.remove("recording-target"),a.width=s,a.height=S,a.style.cssText=g,window.dispatchEvent(new Event("resize"))}c?(b(e,o),B(c,`${_}.mp4`),f(`${(c.size/1024/1024).toFixed(1)}MB`)):f("Failed"),m=!1,l()}function l(){if(!$)return;const e={status:N,isRecording:m,hasCanvas:!!i,currentStep:i?y(i):0,maxStep:i?E(i):0,canvases:v.map(t=>({key:h(t.config),label:D(t.config)}))};$(e)}function G(e){const t=v.find(o=>h(o.config)===e);t&&(i=t,l())}function W(e){if(e.iframeSelector){const t=document.querySelector(e.iframeSelector);return t?.contentDocument?t.contentDocument.querySelector(`#${e.canvasId}`):null}return document.querySelector(`#${e.canvasId}`)}function j(e){const t=W(e);if(!t?.__state__)return!1;const o=t.__state__;let r=null;if(e.iframeSelector)r=t.__controllerEid__??null;else if(r=R(e.controllerName),r!==null&&!o.hasComponent(r,q))return!1;return r===null?!1:(v.find(u=>h(u.config)===h(e))||v.push({canvas:t,config:e,controllerEid:r,isIframe:!!e.iframeSelector}),!0)}function K(e,t={}){const o={...U,...t},r=new Set(e.map(n=>h(n))),a=async()=>{if(!i||m)return;const n=y(i),s=E(i);n>=s||await V(i,n,n+1,o)},u=()=>{if(!i||m)return;const n=y(i);n>0&&(b(i,n-1),l())},p=()=>{if(!i||m)return;const n=y(i),s=E(i);n<s&&(b(i,n+1),l())},{element:_,update:c}=A({onRecord:a,onPrev:u,onNext:p,onCanvasChange:G,showSteps:!0,showCanvasSelect:e.length>1});$=c,document.body.appendChild(_);const d=setInterval(()=>{for(const n of e)r.has(h(n))&&j(n)&&(r.delete(h(n)),!i&&v.length>0&&(i=v[0],N="Ready"),l());r.size===0&&clearInterval(d)},100);setInterval(l,100)}const F={"0-1":"step-0-1","1-0":"step-1-0"},Q=[{canvasId:"canvas",controllerName:"controller",sequenceMap:F,iframeSelector:'iframe[src*="steps"]'},{canvasId:"canvas",controllerName:"controller",sequenceMap:F,iframeSelector:'iframe[src*="grid"]'}];K(Q);
//# sourceMappingURL=record-oAtO98KK.js.map
