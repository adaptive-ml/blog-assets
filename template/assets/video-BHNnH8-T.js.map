{"version":3,"file":"video-BHNnH8-T.js","sources":["../../../src/recording/recorder.ts","../../video/index.ts"],"sourcesContent":["import { Pair } from 'bitecs';\r\nimport { Muxer, ArrayBufferTarget } from 'mp4-muxer';\r\nimport type { State } from '@multiplekex/shallot';\r\nimport { Sequence, SequenceState, Tween, TweenState, ChildOf } from '@multiplekex/shallot';\r\nimport type { RecordingConfig } from './types';\r\nimport { DEFAULT_CONFIG } from './types';\r\nimport { downloadBlob } from './encoder';\r\nimport { StepController, getEntityByName, type SequenceMap } from '@blog-components/sequence';\r\nimport { createRecorderUI, type RecorderUIState } from './ui';\r\n\r\nexport interface RecorderConfig {\r\n  canvas: string | HTMLCanvasElement;\r\n  sequenceMap: SequenceMap;\r\n  name?: string;\r\n  recording?: Partial<RecordingConfig>;\r\n}\r\n\r\nlet isRecording = false;\r\n\r\nfunction getMaxStep(sequenceMap: SequenceMap): number {\r\n  let max = 0;\r\n  for (const key of Object.keys(sequenceMap)) {\r\n    const [from, to] = key.split('-').map(Number);\r\n    max = Math.max(max, from, to);\r\n  }\r\n  return max;\r\n}\r\n\r\nfunction setCanvasSize(canvas: HTMLCanvasElement, width: number, height: number): void {\r\n  const dpr = window.devicePixelRatio || 1;\r\n  canvas.style.width = `${width / dpr}px`;\r\n  canvas.style.height = `${height / dpr}px`;\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n}\r\n\r\nasync function encodeSequence(\r\n  canvas: HTMLCanvasElement,\r\n  state: State,\r\n  seqEid: number,\r\n  config: RecordingConfig,\r\n  onProgress?: (frame: number, total: number) => void\r\n): Promise<Blob> {\r\n  Sequence.state[seqEid] = SequenceState.IDLE;\r\n  Sequence.elapsed[seqEid] = 0;\r\n  for (const childEid of state.query([Pair(ChildOf.relation, seqEid), Tween])) {\r\n    Tween.state[childEid] = TweenState.IDLE;\r\n    Tween.elapsed[childEid] = 0;\r\n  }\r\n  Sequence.state[seqEid] = SequenceState.PLAYING;\r\n\r\n  let maxDuration = 0;\r\n  for (const childEid of state.query([Pair(ChildOf.relation, seqEid), Tween])) {\r\n    maxDuration = Math.max(maxDuration, Tween.duration[childEid]);\r\n  }\r\n  const duration = maxDuration + 0.1;\r\n  const totalFrames = Math.ceil(duration * config.fps);\r\n\r\n  const muxer = new Muxer({\r\n    target: new ArrayBufferTarget(),\r\n    video: { codec: 'avc', width: config.width, height: config.height },\r\n    fastStart: 'in-memory',\r\n  });\r\n\r\n  const encoder = new VideoEncoder({\r\n    output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),\r\n    error: (e) => console.error('Encoder error:', e),\r\n  });\r\n\r\n  encoder.configure({\r\n    codec: 'avc1.640032',\r\n    width: config.width,\r\n    height: config.height,\r\n    bitrate: config.bitrate,\r\n    framerate: config.fps,\r\n  });\r\n\r\n  const stepTime = 1 / config.fps;\r\n\r\n  for (let i = 0; i < totalFrames; i++) {\r\n    setCanvasSize(canvas, config.width, config.height);\r\n    state.step(stepTime);\r\n\r\n    const videoFrame = new VideoFrame(canvas, {\r\n      timestamp: (i * 1_000_000) / config.fps,\r\n    });\r\n    encoder.encode(videoFrame);\r\n    videoFrame.close();\r\n\r\n    if (i % 30 === 0) {\r\n      onProgress?.(i, totalFrames);\r\n      await new Promise((r) => setTimeout(r, 0));\r\n    }\r\n  }\r\n\r\n  await encoder.flush();\r\n  muxer.finalize();\r\n\r\n  return new Blob([muxer.target.buffer], { type: 'video/mp4' });\r\n}\r\n\r\nexport function setupRecorder(config: RecorderConfig): void {\r\n  const { sequenceMap, name = 'recording', recording = {} } = config;\r\n  const fullConfig = { ...DEFAULT_CONFIG, ...recording };\r\n  const maxStep = getMaxStep(sequenceMap);\r\n\r\n  let uiUpdate: ((state: RecorderUIState) => void) | null = null;\r\n  let statusText = 'Waiting...';\r\n  let currentStep = 0;\r\n  let controllerEid: number | undefined;\r\n  let canvas: HTMLCanvasElement | null = null;\r\n  let state: State | null = null;\r\n\r\n  const updateUI = () => {\r\n    uiUpdate?.({\r\n      status: statusText,\r\n      isRecording,\r\n      hasCanvas: !!canvas,\r\n      currentStep,\r\n      maxStep,\r\n    });\r\n  };\r\n\r\n  const doRecord = async () => {\r\n    if (isRecording || !canvas || !state) return;\r\n    const toStep = currentStep + 1;\r\n    if (toStep > maxStep) return;\r\n\r\n    const seqName = sequenceMap[`${currentStep}-${toStep}`];\r\n    if (!seqName) {\r\n      statusText = `No seq ${currentStep}-${toStep}`;\r\n      updateUI();\r\n      return;\r\n    }\r\n\r\n    const seqEid = getEntityByName(seqName);\r\n    if (seqEid === null) {\r\n      statusText = 'Seq not found';\r\n      updateUI();\r\n      return;\r\n    }\r\n\r\n    isRecording = true;\r\n    statusText = 'Recording...';\r\n    updateUI();\r\n\r\n    const origWidth = canvas.width;\r\n    const origHeight = canvas.height;\r\n    const origStyle = canvas.style.cssText;\r\n\r\n    document.body.classList.add('recording-mode');\r\n    canvas.classList.add('recording-target');\r\n    setCanvasSize(canvas, fullConfig.width, fullConfig.height);\r\n    window.dispatchEvent(new Event('resize'));\r\n\r\n    await new Promise((r) => requestAnimationFrame(r));\r\n\r\n    const blob = await encodeSequence(canvas, state, seqEid, fullConfig, (frame, total) => {\r\n      statusText = `${frame}/${total}`;\r\n      updateUI();\r\n    });\r\n\r\n    document.body.classList.remove('recording-mode');\r\n    canvas.classList.remove('recording-target');\r\n    canvas.width = origWidth;\r\n    canvas.height = origHeight;\r\n    canvas.style.cssText = origStyle;\r\n    window.dispatchEvent(new Event('resize'));\r\n\r\n    currentStep = toStep;\r\n    if (controllerEid !== undefined) {\r\n      StepController.target[controllerEid] = toStep;\r\n    }\r\n\r\n    downloadBlob(blob, `${name}-step-${currentStep - 1}-${currentStep}.mp4`);\r\n    statusText = `${(blob.size / 1024 / 1024).toFixed(1)}MB`;\r\n    isRecording = false;\r\n    updateUI();\r\n  };\r\n\r\n  const doPrev = () => {\r\n    if (isRecording || currentStep <= 0) return;\r\n    currentStep--;\r\n    if (controllerEid !== undefined) {\r\n      StepController.target[controllerEid] = currentStep;\r\n    }\r\n    updateUI();\r\n  };\r\n\r\n  const doNext = () => {\r\n    if (isRecording || currentStep >= maxStep) return;\r\n    currentStep++;\r\n    if (controllerEid !== undefined) {\r\n      StepController.target[controllerEid] = currentStep;\r\n    }\r\n    updateUI();\r\n  };\r\n\r\n  const { element, update } = createRecorderUI({\r\n    onRecord: doRecord,\r\n    onPrev: doPrev,\r\n    onNext: doNext,\r\n    showSteps: true,\r\n  });\r\n\r\n  uiUpdate = update;\r\n  document.body.appendChild(element);\r\n\r\n  const checkReady = setInterval(() => {\r\n    const selector = typeof config.canvas === 'string' ? config.canvas : null;\r\n    const c = selector\r\n      ? (document.querySelector(selector) as HTMLCanvasElement)\r\n      : (config.canvas as HTMLCanvasElement);\r\n\r\n    if (!c?.__state__) return;\r\n\r\n    clearInterval(checkReady);\r\n    canvas = c;\r\n    state = c.__state__ as State;\r\n\r\n    const controllers = [...state.query([StepController])];\r\n    controllerEid = controllers[0];\r\n\r\n    if (controllerEid !== undefined) {\r\n      currentStep = StepController.step[controllerEid];\r\n    }\r\n\r\n    statusText = 'Ready';\r\n    updateUI();\r\n  }, 100);\r\n}\r\n","import { State, TransformsPlugin, RenderPlugin, TweenPlugin } from '@multiplekex/shallot';\r\nimport { OrbitPlugin } from '@multiplekex/shallot/extras';\r\nimport { setupRecorder } from '@blog-components/recording';\r\nimport { createStepPlugin, type SequenceMap } from '@blog-components/sequence';\r\n\r\nconst STEP_SEQUENCES: SequenceMap = {\r\n  '0-1': 'step-0-1',\r\n  '1-0': 'step-1-0',\r\n};\r\n\r\nfunction setupCanvas(canvas: HTMLCanvasElement): void {\r\n  const rect = canvas.getBoundingClientRect();\r\n  canvas.width = rect.width * window.devicePixelRatio;\r\n  canvas.height = rect.height * window.devicePixelRatio;\r\n}\r\n\r\nasync function init(): Promise<void> {\r\n  const canvas = document.getElementById('canvas-1') as HTMLCanvasElement;\r\n  if (!canvas) return;\r\n\r\n  setupCanvas(canvas);\r\n  window.addEventListener('resize', () => setupCanvas(canvas));\r\n\r\n  const state = await State.new()\r\n    .withCanvas(canvas)\r\n    .withPlugins(\r\n      TransformsPlugin,\r\n      RenderPlugin,\r\n      OrbitPlugin,\r\n      TweenPlugin,\r\n      createStepPlugin(STEP_SEQUENCES)\r\n    )\r\n    .withScene('/scenes/steps.scene')\r\n    .build();\r\n\r\n  canvas.__state__ = state;\r\n\r\n  let lastTime = performance.now();\r\n  const tick = (now: number) => {\r\n    const dt = (now - lastTime) / 1000;\r\n    lastTime = now;\r\n    state.step(dt);\r\n    requestAnimationFrame(tick);\r\n  };\r\n  requestAnimationFrame(tick);\r\n\r\n  setupRecorder({\r\n    canvas: '#canvas-1',\r\n    sequenceMap: STEP_SEQUENCES,\r\n    name: 'video',\r\n  });\r\n}\r\n\r\nif (typeof document !== 'undefined') {\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', init);\r\n  } else {\r\n    init();\r\n  }\r\n}\r\n"],"names":["isRecording","getMaxStep","sequenceMap","max","key","from","to","setCanvasSize","canvas","width","height","dpr","encodeSequence","state","seqEid","config","onProgress","Sequence","SequenceState","childEid","Pair","ChildOf","Tween","TweenState","maxDuration","duration","totalFrames","muxer","Muxer","ArrayBufferTarget","encoder","chunk","meta","e","stepTime","i","videoFrame","r","setupRecorder","name","recording","fullConfig","DEFAULT_CONFIG","maxStep","uiUpdate","statusText","currentStep","controllerEid","updateUI","doRecord","toStep","seqName","getEntityByName","origWidth","origHeight","origStyle","blob","frame","total","StepController","downloadBlob","doPrev","doNext","element","update","createRecorderUI","checkReady","selector","c","STEP_SEQUENCES","setupCanvas","rect","init","State","TransformsPlugin","RenderPlugin","OrbitPlugin","TweenPlugin","createStepPlugin","lastTime","tick","now","dt"],"mappings":"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"}