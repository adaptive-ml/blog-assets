{"version":3,"file":"ui-vQ9UuVEs.js","sources":["../../../src/recording/types.ts","../../../src/recording/encoder.ts","../../../src/recording/ui.ts"],"sourcesContent":["export interface RecordingConfig {\r\n  fps: number;\r\n  bitrate: number;\r\n  width: number;\r\n  height: number;\r\n  durationSeconds: number;\r\n}\r\n\r\nexport const DEFAULT_CONFIG: RecordingConfig = {\r\n  fps: 60,\r\n  bitrate: 5_000_000,\r\n  width: 1920,\r\n  height: 1080,\r\n  durationSeconds: 3,\r\n};\r\n","import { Muxer, ArrayBufferTarget } from 'mp4-muxer';\r\nimport type { State } from '@multiplekex/shallot';\r\nimport type { RecordingConfig } from './types';\r\n\r\nexport async function encodeFrames(\r\n  canvas: HTMLCanvasElement,\r\n  state: State,\r\n  config: RecordingConfig,\r\n  onProgress?: (frame: number, total: number) => void\r\n): Promise<Blob> {\r\n  const totalFrames = Math.ceil(config.durationSeconds * config.fps);\r\n\r\n  const muxer = new Muxer({\r\n    target: new ArrayBufferTarget(),\r\n    video: { codec: 'avc', width: config.width, height: config.height },\r\n    fastStart: 'in-memory',\r\n  });\r\n\r\n  const encoder = new VideoEncoder({\r\n    output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),\r\n    error: (e) => console.error('Encoder error:', e),\r\n  });\r\n\r\n  encoder.configure({\r\n    codec: 'avc1.640032',\r\n    width: config.width,\r\n    height: config.height,\r\n    bitrate: config.bitrate,\r\n    framerate: config.fps,\r\n  });\r\n\r\n  const stepTime = 1 / config.fps;\r\n\r\n  for (let i = 0; i < totalFrames; i++) {\r\n    state.step(stepTime);\r\n\r\n    const videoFrame = new VideoFrame(canvas, {\r\n      timestamp: (i * 1_000_000) / config.fps,\r\n    });\r\n    encoder.encode(videoFrame);\r\n    videoFrame.close();\r\n\r\n    if (i % 30 === 0) {\r\n      onProgress?.(i, totalFrames);\r\n      await new Promise((r) => setTimeout(r, 0));\r\n    }\r\n  }\r\n\r\n  await encoder.flush();\r\n  muxer.finalize();\r\n\r\n  return new Blob([muxer.target.buffer], { type: 'video/mp4' });\r\n}\r\n\r\nexport function downloadBlob(blob: Blob, filename: string): void {\r\n  const url = URL.createObjectURL(blob);\r\n  const a = document.createElement('a');\r\n  a.href = url;\r\n  a.download = filename;\r\n  a.click();\r\n  URL.revokeObjectURL(url);\r\n}\r\n","export interface RecorderUIConfig {\r\n  onRecord: () => void;\r\n  onPrev?: () => void;\r\n  onNext?: () => void;\r\n  onCanvasChange?: (key: string) => void;\r\n  showSteps?: boolean;\r\n  showCanvasSelect?: boolean;\r\n}\r\n\r\nexport interface RecorderUIState {\r\n  status: string;\r\n  isRecording: boolean;\r\n  hasCanvas: boolean;\r\n  currentStep?: number;\r\n  maxStep?: number;\r\n  canvases?: { key: string; label: string }[];\r\n}\r\n\r\nconst STYLES = `\r\n.rec {\r\n  position: fixed;\r\n  bottom: 16px;\r\n  right: 16px;\r\n  background: #1a1a1a;\r\n  padding: 12px;\r\n  font: 11px/1.4 monospace;\r\n  color: #888;\r\n  z-index: 9999;\r\n  min-width: 140px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n}\r\n\r\n.rec-row {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  gap: 8px;\r\n}\r\n\r\n.rec-dot {\r\n  width: 6px;\r\n  height: 6px;\r\n  border-radius: 50%;\r\n  background: #444;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.rec.has-canvas .rec-dot { background: #666; }\r\n.rec.is-recording .rec-dot { background: #c00; }\r\n\r\n.rec-status { color: #aaa; }\r\n\r\n.rec select {\r\n  background: #111;\r\n  border: 1px solid #333;\r\n  color: #ccc;\r\n  font: inherit;\r\n  padding: 4px 6px;\r\n  flex: 1;\r\n  min-width: 0;\r\n}\r\n\r\n.rec select:focus { outline: none; border-color: #555; }\r\n\r\n.rec-nav {\r\n  display: flex;\r\n  gap: 4px;\r\n}\r\n\r\n.rec-nav button {\r\n  flex: 1;\r\n  background: #111;\r\n  border: 1px solid #333;\r\n  color: #888;\r\n  font: inherit;\r\n  padding: 4px 8px;\r\n  cursor: pointer;\r\n}\r\n\r\n.rec-nav button:hover:not(:disabled) { color: #ccc; border-color: #555; }\r\n.rec-nav button:disabled { color: #444; cursor: default; }\r\n\r\n.rec-record {\r\n  background: #111;\r\n  border: 1px solid #333;\r\n  color: #c44;\r\n  font: inherit;\r\n  padding: 6px 8px;\r\n  cursor: pointer;\r\n  text-align: center;\r\n}\r\n\r\n.rec-record:hover:not(:disabled) { background: #1a1a1a; border-color: #555; }\r\n.rec-record:disabled { color: #444; cursor: default; }\r\n\r\n.rec-hide { display: none !important; }\r\n\r\nbody.recording-mode .rec { display: none; }\r\nbody.recording-mode { margin: 0; padding: 0; overflow: hidden; background: #000; }\r\nbody.recording-mode canvas.recording-target {\r\n  display: block !important;\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n}\r\nbody.recording-mode .blog-container { display: none; }\r\n`;\r\n\r\nlet styleInjected = false;\r\n\r\nfunction injectStyles(): void {\r\n  if (styleInjected) return;\r\n  const style = document.createElement('style');\r\n  style.textContent = STYLES;\r\n  document.head.appendChild(style);\r\n  styleInjected = true;\r\n}\r\n\r\nexport interface RecorderUIHandle {\r\n  element: HTMLElement;\r\n  update: (state: RecorderUIState) => void;\r\n}\r\n\r\nexport function createRecorderUI(config: RecorderUIConfig): RecorderUIHandle {\r\n  injectStyles();\r\n\r\n  const el = document.createElement('div');\r\n  el.className = 'rec';\r\n\r\n  el.innerHTML = `\r\n    <div class=\"rec-row\">\r\n      <span class=\"rec-dot\"></span>\r\n      <span class=\"rec-status\">Ready</span>\r\n    </div>\r\n    <div class=\"rec-row rec-canvas-row rec-hide\">\r\n      <select class=\"rec-canvas\"></select>\r\n    </div>\r\n    <div class=\"rec-row rec-step-row rec-hide\">\r\n      <span>Step</span>\r\n      <span><span class=\"rec-current\">0</span>/<span class=\"rec-max\">0</span></span>\r\n    </div>\r\n    <div class=\"rec-nav rec-step-row rec-hide\">\r\n      <button class=\"rec-prev\">&larr;</button>\r\n      <button class=\"rec-next\">&rarr;</button>\r\n    </div>\r\n    <button class=\"rec-record\">Record [R]</button>\r\n  `;\r\n\r\n  const statusEl = el.querySelector('.rec-status')!;\r\n  const recordBtn = el.querySelector('.rec-record') as HTMLButtonElement;\r\n  const canvasRow = el.querySelector('.rec-canvas-row') as HTMLElement;\r\n  const canvasSelect = el.querySelector('.rec-canvas') as HTMLSelectElement;\r\n  const stepRows = el.querySelectorAll('.rec-step-row');\r\n  const currentEl = el.querySelector('.rec-current')!;\r\n  const maxEl = el.querySelector('.rec-max')!;\r\n  const prevBtn = el.querySelector('.rec-prev') as HTMLButtonElement;\r\n  const nextBtn = el.querySelector('.rec-next') as HTMLButtonElement;\r\n\r\n  if (config.showCanvasSelect) canvasRow.classList.remove('rec-hide');\r\n  if (config.showSteps) stepRows.forEach((r) => r.classList.remove('rec-hide'));\r\n\r\n  recordBtn.addEventListener('click', () => {\r\n    if (!recordBtn.disabled) config.onRecord();\r\n  });\r\n\r\n  canvasSelect.addEventListener('change', () => config.onCanvasChange?.(canvasSelect.value));\r\n  prevBtn.addEventListener('click', () => config.onPrev?.());\r\n  nextBtn.addEventListener('click', () => config.onNext?.());\r\n\r\n  document.addEventListener('keydown', (e) => {\r\n    if (e.key.toLowerCase() === 'r' && !recordBtn.disabled) config.onRecord();\r\n    if (config.showSteps) {\r\n      if (e.key === 'ArrowLeft') config.onPrev?.();\r\n      if (e.key === 'ArrowRight') config.onNext?.();\r\n    }\r\n  });\r\n\r\n  function update(state: RecorderUIState): void {\r\n    el.classList.toggle('has-canvas', state.hasCanvas);\r\n    el.classList.toggle('is-recording', state.isRecording);\r\n    statusEl.textContent = state.status;\r\n    recordBtn.disabled = state.isRecording || !state.hasCanvas;\r\n\r\n    if (config.showSteps) {\r\n      const step = state.currentStep ?? 0;\r\n      const max = state.maxStep ?? 0;\r\n      currentEl.textContent = String(step);\r\n      maxEl.textContent = String(max);\r\n      prevBtn.disabled = state.isRecording || step <= 0;\r\n      nextBtn.disabled = state.isRecording || step >= max;\r\n      recordBtn.disabled = state.isRecording || step >= max;\r\n    }\r\n\r\n    if (config.showCanvasSelect && state.canvases) {\r\n      const current = canvasSelect.value;\r\n      canvasSelect.innerHTML = state.canvases\r\n        .map((c) => `<option value=\"${c.key}\">${c.label}</option>`)\r\n        .join('');\r\n      if (state.canvases.some((c) => c.key === current)) {\r\n        canvasSelect.value = current;\r\n      }\r\n    }\r\n  }\r\n\r\n  return { element: el, update };\r\n}\r\n"],"names":["DEFAULT_CONFIG","downloadBlob","blob","filename","url","a","STYLES","styleInjected","injectStyles","style","createRecorderUI","config","el","statusEl","recordBtn","canvasRow","canvasSelect","stepRows","currentEl","maxEl","prevBtn","nextBtn","r","update","state","step","max","current","c"],"mappings":"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"}