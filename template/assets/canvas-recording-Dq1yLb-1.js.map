{"version":3,"file":"canvas-recording-Dq1yLb-1.js","sources":["../../../src/sequence/ui.ts","../../../src/recording/canvas-recording.ts"],"sourcesContent":["export interface StepContent {\r\n  title: string;\r\n  description: string;\r\n}\r\n\r\nexport interface StepUIOptions {\r\n  steps: StepContent[];\r\n  onStepChange: (step: number) => void;\r\n}\r\n\r\nexport interface StepUIElements {\r\n  btnPrev: HTMLButtonElement | null;\r\n  btnNext: HTMLButtonElement | null;\r\n  counter: HTMLElement | null;\r\n  title: HTMLElement | null;\r\n  description: HTMLElement | null;\r\n}\r\n\r\nexport function findStepElements(container: HTMLElement | string): StepUIElements {\r\n  const root = typeof container === 'string' ? document.querySelector(container) : container;\r\n  if (!root) {\r\n    return { btnPrev: null, btnNext: null, counter: null, title: null, description: null };\r\n  }\r\n\r\n  return {\r\n    btnPrev: root.querySelector('.btn-prev') as HTMLButtonElement | null,\r\n    btnNext: root.querySelector('.btn-next') as HTMLButtonElement | null,\r\n    counter: root.querySelector('.step-counter'),\r\n    title: root.querySelector('.step-title'),\r\n    description: root.querySelector('.step-description'),\r\n  };\r\n}\r\n\r\nexport interface StepUIController {\r\n  setStep: (step: number) => void;\r\n  getStep: () => number;\r\n  getMaxStep: () => number;\r\n  dispose: () => void;\r\n}\r\n\r\nexport function setupStepUI(elements: StepUIElements, options: StepUIOptions): StepUIController {\r\n  const { steps, onStepChange } = options;\r\n  const maxStep = steps.length - 1;\r\n  let currentStep = 0;\r\n\r\n  const stepInfo = elements.title?.parentElement;\r\n  if (stepInfo) {\r\n    let maxHeight = 0;\r\n    for (const step of steps) {\r\n      if (elements.title) elements.title.textContent = step.title;\r\n      if (elements.description) elements.description.innerHTML = step.description;\r\n      maxHeight = Math.max(maxHeight, stepInfo.offsetHeight);\r\n    }\r\n    stepInfo.style.minHeight = `${maxHeight}px`;\r\n  }\r\n\r\n  function updateDisplay(): void {\r\n    const { btnPrev, btnNext, counter, title, description } = elements;\r\n    const content = steps[currentStep];\r\n\r\n    if (btnPrev) btnPrev.disabled = currentStep <= 0;\r\n    if (btnNext) btnNext.disabled = currentStep >= maxStep;\r\n    if (counter) counter.textContent = `Step ${currentStep + 1} of ${steps.length}`;\r\n    if (title) title.textContent = content?.title ?? '';\r\n    if (description) description.innerHTML = content?.description ?? '';\r\n  }\r\n\r\n  function goToStep(step: number): void {\r\n    const clamped = Math.max(0, Math.min(maxStep, step));\r\n    if (clamped === currentStep) return;\r\n    currentStep = clamped;\r\n    updateDisplay();\r\n    onStepChange(currentStep);\r\n  }\r\n\r\n  const handlePrev = () => goToStep(currentStep - 1);\r\n  const handleNext = () => goToStep(currentStep + 1);\r\n  const handleKeydown = (e: KeyboardEvent) => {\r\n    if (e.key === 'ArrowLeft') goToStep(currentStep - 1);\r\n    if (e.key === 'ArrowRight') goToStep(currentStep + 1);\r\n  };\r\n\r\n  elements.btnPrev?.addEventListener('click', handlePrev);\r\n  elements.btnNext?.addEventListener('click', handleNext);\r\n  document.addEventListener('keydown', handleKeydown);\r\n\r\n  updateDisplay();\r\n\r\n  return {\r\n    setStep(step: number) {\r\n      currentStep = Math.max(0, Math.min(maxStep, step));\r\n      updateDisplay();\r\n    },\r\n    getStep: () => currentStep,\r\n    getMaxStep: () => maxStep,\r\n    dispose() {\r\n      elements.btnPrev?.removeEventListener('click', handlePrev);\r\n      elements.btnNext?.removeEventListener('click', handleNext);\r\n      document.removeEventListener('keydown', handleKeydown);\r\n    },\r\n  };\r\n}\r\n","import { Pair } from 'bitecs';\r\nimport { Muxer, ArrayBufferTarget } from 'mp4-muxer';\r\nimport { Sequence, SequenceState, Tween, TweenState, ChildOf, type State } from '@multiplekex/shallot';\r\nimport { getEntityByName, type RecordSequenceConfig } from '@blog-components/sequence';\r\n\r\nfunction setCanvasSize(canvas: HTMLCanvasElement, width: number, height: number): void {\r\n  const dpr = window.devicePixelRatio || 1;\r\n  canvas.style.width = `${width / dpr}px`;\r\n  canvas.style.height = `${height / dpr}px`;\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n}\r\n\r\nexport function setupCanvasRecording(canvas: HTMLCanvasElement, state: State): void {\r\n  canvas.__recordSequence__ = async (\r\n    config: RecordSequenceConfig,\r\n    onProgress?: (frame: number, total: number) => void\r\n  ): Promise<Blob | null> => {\r\n    const seqEid = getEntityByName(config.seqName);\r\n    if (seqEid === null) return null;\r\n\r\n    const origWidth = canvas.width;\r\n    const origHeight = canvas.height;\r\n    const origStyle = canvas.style.cssText;\r\n\r\n    setCanvasSize(canvas, config.width, config.height);\r\n    await new Promise((r) => requestAnimationFrame(r));\r\n\r\n    Sequence.state[seqEid] = SequenceState.IDLE;\r\n    Sequence.elapsed[seqEid] = 0;\r\n    for (const childEid of state.query([Pair(ChildOf.relation, seqEid), Tween])) {\r\n      Tween.state[childEid] = TweenState.IDLE;\r\n      Tween.elapsed[childEid] = 0;\r\n    }\r\n    Sequence.state[seqEid] = SequenceState.PLAYING;\r\n\r\n    let maxDuration = 0;\r\n    for (const childEid of state.query([Pair(ChildOf.relation, seqEid), Tween])) {\r\n      maxDuration = Math.max(maxDuration, Tween.duration[childEid]);\r\n    }\r\n    const duration = maxDuration + 0.1;\r\n    const totalFrames = Math.ceil(duration * config.fps);\r\n\r\n    const muxer = new Muxer({\r\n      target: new ArrayBufferTarget(),\r\n      video: { codec: 'avc', width: config.width, height: config.height },\r\n      fastStart: 'in-memory',\r\n    });\r\n\r\n    const encoder = new VideoEncoder({\r\n      output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),\r\n      error: (e) => console.error('Encoder error:', e),\r\n    });\r\n\r\n    encoder.configure({\r\n      codec: 'avc1.640032',\r\n      width: config.width,\r\n      height: config.height,\r\n      bitrate: config.bitrate,\r\n      framerate: config.fps,\r\n    });\r\n\r\n    const stepTime = 1 / config.fps;\r\n\r\n    for (let i = 0; i < totalFrames; i++) {\r\n      setCanvasSize(canvas, config.width, config.height);\r\n      state.step(stepTime);\r\n\r\n      const videoFrame = new VideoFrame(canvas, {\r\n        timestamp: (i * 1_000_000) / config.fps,\r\n      });\r\n      encoder.encode(videoFrame);\r\n      videoFrame.close();\r\n\r\n      if (i % 30 === 0) {\r\n        onProgress?.(i, totalFrames);\r\n        await new Promise((r) => setTimeout(r, 0));\r\n      }\r\n    }\r\n\r\n    await encoder.flush();\r\n    muxer.finalize();\r\n\r\n    canvas.width = origWidth;\r\n    canvas.height = origHeight;\r\n    canvas.style.cssText = origStyle;\r\n\r\n    return new Blob([muxer.target.buffer], { type: 'video/mp4' });\r\n  };\r\n}\r\n"],"names":["findStepElements","container","root","setupStepUI","elements","options","steps","onStepChange","maxStep","currentStep","stepInfo","maxHeight","step","updateDisplay","btnPrev","btnNext","counter","title","description","content","goToStep","clamped","handlePrev","handleNext","handleKeydown","e","setCanvasSize","canvas","width","height","dpr","setupCanvasRecording","state","config","onProgress","seqEid","getEntityByName","origWidth","origHeight","origStyle","r","Sequence","SequenceState","childEid","Pair","ChildOf","Tween","TweenState","maxDuration","duration","totalFrames","muxer","Muxer","ArrayBufferTarget","encoder","chunk","meta","stepTime","videoFrame"],"mappings":"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"}